----- C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\aggregation.js -----
// C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\aggregation.js

import { hiraganaToKatakana, getLocalDateString } from './utils.js';
import { transactionTypeMap, createUploadTableHTML, renderUploadTableRows } from './common_table.js';

let view, runBtn, printBtn, outputContainer, kanaNameInput, dosageFormInput, coefficientInput, drugTypeCheckboxes, reorderNeededCheckbox, movementOnlyCheckbox;
let lastData = [];

function formatBalance(balance) {
    if (typeof balance === 'number') {
        return balance.toFixed(2);
    }
    return balance;
}

function renderResults() {
    let dataToRender = lastData;
    if (reorderNeededCheckbox.checked) {
        dataToRender = lastData.filter(yjGroup => yjGroup.isReorderNeeded)
            .map(yjGroup => ({
                ...yjGroup,
                packageLedgers: yjGroup.packageLedgers.filter(pkg => pkg.isReorderNeeded)
            }));
    }

    if (!dataToRender || dataToRender.length === 0) {
        outputContainer.innerHTML = "<p>対象データが見つかりませんでした。</p>";
        return;
    }

    let html = dataToRender.map((yjGroup, yjIndex) => {
        let yjReorderPointText = formatBalance(yjGroup.totalReorderPoint);
        if (yjGroup.totalPrecompounded > 0) {
            yjReorderPointText = `${formatBalance(yjGroup.totalBaseReorderPoint)} + 予${formatBalance(yjGroup.totalPrecompounded)} = ${formatBalance(yjGroup.totalReorderPoint)}`;
        }
        
        const yjHeader = `
            <div class="agg-yj-header" ${yjGroup.isReorderNeeded ? 'style="background-color: #ff0015ff; color: white;"' : ''}>
                <div style="flex-grow: 1;">
                    <span>YJ: ${yjGroup.yjCode}</span>
                    <span class="product-name">${yjGroup.productName}</span>
                    <span class="balance-info">
                        在庫: ${formatBalance(yjGroup.endingBalance)} | 
                        発注点: ${yjReorderPointText} | 
                        変動: ${formatBalance(yjGroup.netChange)}
                    </span>
                </div>
                <button class="btn inventory-adjust-link-btn" data-yj-code="${yjGroup.yjCode}" style="margin-left: 15px; background-color: #ffc107; color: black;">棚卸調整</button>
            </div>
        `;
     
        const packagesHtml = yjGroup.packageLedgers.map((pkg, pkgIndex) => {
            const tableId = `agg-table-${yjIndex}-${pkgIndex}`;
            let pkgReorderPointText = formatBalance(pkg.reorderPoint);
            if (pkg.precompoundedTotal > 0) {
                pkgReorderPointText = `${formatBalance(pkg.baseReorderPoint)} + 予${formatBalance(pkg.precompoundedTotal)} = ${formatBalance(pkg.reorderPoint)}`;
            }

            const pkgHeader = `
                <div class="agg-pkg-header">
                    <span>包装: ${pkg.packageKey}</span>
                    <span class="balance-info">
                        在庫: ${formatBalance(pkg.endingBalance)} |
                        在庫(発注残含): ${formatBalance(pkg.effectiveEndingBalance)} | 
                        発注点: ${pkgReorderPointText} |  
                        変動: ${formatBalance(pkg.netChange)}
                    </span>
                </div>
            `;
            const tableShell = createUploadTableHTML(tableId);
            const tableBodyContent = renderUploadTableRows(pkg.transactions);
            
            const fullTableHtml = tableShell.replace('<tbody></tbody>', `<tbody>${tableBodyContent}</tbody>`);
            return pkgHeader + `<div id="${tableId}-container">${fullTableHtml}</div>`;
        }).join('');

        return yjHeader + packagesHtml;
    }).join('');

    outputContainer.innerHTML = html;
}

export function initAggregation() {
    view = document.getElementById('aggregation-view');
    if (!view) return;
    runBtn = document.getElementById('run-aggregation-btn');
    printBtn = document.getElementById('print-aggregation-btn');
    outputContainer = document.getElementById('aggregation-output-container');
    kanaNameInput = document.getElementById('agg-kanaName');
    dosageFormInput = document.getElementById('agg-dosageForm');
    coefficientInput = document.getElementById('reorder-coefficient');
    drugTypeCheckboxes = document.querySelectorAll('input[name="drugType"]');
    reorderNeededCheckbox = document.getElementById('reorder-needed-filter');
    movementOnlyCheckbox = document.getElementById('movement-only-filter');
    
    printBtn.addEventListener('click', () => {
        if (lastData && lastData.length > 0) {
            document.getElementById('valuation-view').classList.remove('print-this-view');
            view.classList.add('print-this-view');
            window.print();
        } else {
            window.showNotification('先に「集計実行」を押してデータを表示してください。', 'error');
        }
    });

    window.addEventListener('afterprint', () => {
        view.classList.remove('print-this-view');
    });
    reorderNeededCheckbox.addEventListener('change', () => renderResults());
    
    // 棚卸調整ボタンのクリックイベント
    outputContainer.addEventListener('click', (e) => {
        const target = e.target;
        if (target.classList.contains('inventory-adjust-link-btn')) {
            const yjCode = target.dataset.yjCode;
            const event = new CustomEvent('navigateToInventoryAdjustment', {
                detail: { yjCode: yjCode },
                bubbles: true
            });
            target.dispatchEvent(event);
        }
    });

    runBtn.addEventListener('click', async () => {
        window.showLoading('データを取得・計算中...');

        const selectedDrugTypes = Array.from(drugTypeCheckboxes)
            .filter(cb => cb.checked)
            .map(cb => cb.value)
            .join(',');

        const params = new URLSearchParams({
            kanaName: hiraganaToKatakana(kanaNameInput.value),
            dosageForm: dosageFormInput.value,
            coefficient: coefficientInput.value,
            drugTypes: selectedDrugTypes,
            movementOnly: movementOnlyCheckbox.checked,
        });

        try {
            const res = await fetch(`/api/aggregation?${params.toString()}`);
            if (!res.ok) {
                const errText = await res.text();
                throw new Error(errText || '集計に失敗しました');
            }
            lastData = await res.json();
            
            window.showLoading('集計結果を描画中...');
            
            setTimeout(() => {
                try {
                    renderResults();
                    window.hideLoading();
                    window.showNotification('描画が完了しました。', 'success');
                } catch (renderErr) {
                    outputContainer.innerHTML = `<p style="color:red;">描画エラー: ${renderErr.message}</p>`;
                    window.hideLoading();
                    window.showNotification('結果の描画中にエラーが発生しました。', 'error');
                }
            }, 10);

        } catch (err) {
            outputContainer.innerHTML = `<p style="color:red;">エラー: ${err.message}</p>`;
            window.hideLoading();
            window.showNotification(err.message, 'error');
        }
    });
}

----- C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\app.js -----
// C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\app.js

// DATアップロード機能の初期化のみをインポート
import { initDatUpload } from './dat.js';

// === グローバルヘルパー関数 (ローディング・通知) ===
window.showLoading = (message = '処理中...') => {
    const overlay = document.getElementById('loading-overlay');
    const msgEl = document.getElementById('loading-message');
    if (msgEl) msgEl.textContent = message;
    if (overlay) overlay.classList.remove('hidden');
};

window.hideLoading = () => {
    const overlay = document.getElementById('loading-overlay');
    if (overlay) overlay.classList.add('hidden');
};

let notificationTimeout;
window.showNotification = (message, type = 'info') => {
    const box = document.getElementById('notification-box');
    if (!box) return;

    box.textContent = message;
    box.className = 'notification-box'; // Reset classes
    box.classList.add(type);
    box.classList.add('show');

    clearTimeout(notificationTimeout);
    notificationTimeout = setTimeout(() => {
        box.classList.remove('show');
    }, 3000);
};
// === ヘルパー関数ここまで ===


// --- DOM読み込み完了時の処理 ---
document.addEventListener('DOMContentLoaded', async () => {
    
    // DATアップロード機能の初期化
    initDatUpload();

    // 他のビューは存在しないため、ビュー切り替えロジックは不要
    const datBtn = document.getElementById('datBtn');
    const datInput = document.getElementById('datFileInput');

    if (datBtn && datInput) {
        datBtn.addEventListener('click', () => {
            datInput.click();
        });
    }

    // デフォルトでアップロードビューを表示状態にする (index.html側で .active を付与)
    console.log('DAT Upload App Initialized.');
});

----- C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\backorder.js -----
// C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\backorder.js

let view, outputContainer;

// ▼▼▼【ここから修正】▼▼▼
function renderBackorders(data) {
    if (!data || data.length === 0) {
        outputContainer.innerHTML = "<p>現在、発注残はありません。</p>";
        return;
    }

    let html = `
        <div class="controls-grid" style="margin-bottom: 10px; display: flex; gap: 10px;">
            <button class="btn" id="bulk-delete-backorder-btn" style="background-color: #dc3545; color: white;">選択した項目を一括削除</button>
            <button class="btn" id="delete-all-backorder-btn">表示されている項目を全て削除</button>
        </div>
        <table class="data-table">
            <thead>
                <tr>
                    <th style="width: 5%;"><input type="checkbox" id="select-all-backorders-checkbox"></th>
                    <th style="width: 10%;">発注日</th>
                    <th style="width: 10%;">YJコード</th>
                    <th style="width: 25%;">製品名</th>
                    <th style="width: 20%;">包装仕様</th>
                    <th style="width: 10%;">発注数量</th>
                    <th style="width: 10%;">残数量</th>
                    <th style="width: 10%;">個別操作</th>
                </tr>
            </thead>
            <tbody>
    `;

    data.forEach(bo => {
        const pkgSpec = bo.formattedPackageSpec;

        html += `
            <tr data-id="${bo.id}">
                <td class="center"><input type="checkbox" class="backorder-select-checkbox"></td>
                <td>${bo.orderDate}</td>
                <td>${bo.yjCode}</td>
                <td class="left">${bo.productName}</td>
                <td class="left">${pkgSpec}</td>
                <td class="right">${bo.orderQuantity.toFixed(2)}</td>
                <td class="right">${bo.remainingQuantity.toFixed(2)}</td>
                <td class="center"><button class="btn delete-backorder-btn">削除</button></td>
            </tr>
        `;
    });
    html += `</tbody></table>`;
    outputContainer.innerHTML = html;
}

async function loadAndRenderBackorders() {
    outputContainer.innerHTML = '<p>読み込み中...</p>';
    try {
        const res = await fetch('/api/backorders');
        if (!res.ok) throw new Error('発注残リストの読み込みに失敗しました。');
        const data = await res.json();
        renderBackorders(data);
    } catch (err) {
        outputContainer.innerHTML = `<p style="color:red;">${err.message}</p>`;
    }
}

async function handleBackorderEvents(e) {
    const target = e.target;

    // 個別削除ボタン
    if (target.classList.contains('delete-backorder-btn')) {
        const row = target.closest('tr');
        if (!confirm(`「${row.cells[3].textContent}」の発注残（発注日: ${row.cells[1].textContent}）を削除しますか？`)) {
            return;
        }
        const payload = {
            id: parseInt(row.dataset.id, 10),
        };
        window.showLoading();
        try {
            const res = await fetch('/api/backorders/delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });
            const resData = await res.json();
            if (!res.ok) throw new Error(resData.message || '削除に失敗しました。');
            window.showNotification(resData.message, 'success');
            loadAndRenderBackorders();
        } catch (err) {
            window.showNotification(err.message, 'error');
        } finally {
            window.hideLoading();
        }
    }

    // 全選択チェックボックス
    if (target.id === 'select-all-backorders-checkbox') {
        const isChecked = target.checked;
        document.querySelectorAll('.backorder-select-checkbox').forEach(cb => cb.checked = isChecked);
    }

    // 全件削除ボタン
    if (target.id === 'delete-all-backorder-btn') {
        document.getElementById('select-all-backorders-checkbox').checked = true;
        document.querySelectorAll('.backorder-select-checkbox').forEach(cb => cb.checked = true);
        document.getElementById('bulk-delete-backorder-btn').click(); // 一括削除ボタンのクリックを擬似的に発火
    }

    // 選択項目の一括削除ボタン
    if (target.id === 'bulk-delete-backorder-btn') {
        const checkedRows = document.querySelectorAll('.backorder-select-checkbox:checked');
        if (checkedRows.length === 0) {
            window.showNotification('削除する項目が選択されていません。', 'error');
            return;
        }
        if (!confirm(`${checkedRows.length}件の発注残を削除します。よろしいですか？`)) {
            return;
        }

        const payload = Array.from(checkedRows).map(cb => {
            const row = cb.closest('tr');
            return {
                id: parseInt(row.dataset.id, 10),
            };
        });

        window.showLoading();
        try {
            const res = await fetch('/api/backorders/bulk_delete', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });
            const resData = await res.json();
            if (!res.ok) throw new Error(resData.message || '一括削除に失敗しました。');
            window.showNotification(resData.message, 'success');
            loadAndRenderBackorders();
        } catch (err) {
            window.showNotification(err.message, 'error');
        } finally {
            window.hideLoading();
        }
    }
}

export function initBackorderView() {
    view = document.getElementById('backorder-view');
    if (!view) return;
    outputContainer = document.getElementById('backorder-output-container');
    
    view.addEventListener('show', loadAndRenderBackorders);
    outputContainer.addEventListener('click', handleBackorderEvents);
}
// ▲▲▲【修正ここまで】▲▲▲

----- C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\backup.js -----
/**
 * ファイルアップロードを処理し、サーバーに送信する共通関数
 * @param {Event} event - ファイル入力のchangeイベント
 * @param {string} url - アップロード先のAPIエンドポイント
 */
async function handleFileUpload(event, url) {
    const fileInput = event.target;
    const file = fileInput.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('file', file);
    
    window.showLoading();
    try {
        const res = await fetch(url, {
            method: 'POST',
            body: formData,
        });
        const resData = await res.json();
        if (!res.ok) {
            throw new Error(resData.message || 'インポートに失敗しました。');
        }
        window.showNotification(resData.message, 'success');
    } catch (err) {
        console.error(err);
        window.showNotification(`エラー: ${err.message}`, 'error');
    } finally {
        window.hideLoading();
        fileInput.value = ''; // 次回同じファイルを選択できるようにリセット
    }
}

/**
 * 全てのエクスポート・インポートボタンの機能を初期化する
 */
export function initBackupButtons() {
    // DOM要素を取得
    // ▼▼▼【ここから修正】▼▼▼
    const exportCustomersBtn = document.getElementById('exportCustomersBtn');
    const importCustomersBtn = document.getElementById('importCustomersBtn');
    const importCustomersInput = document.getElementById('importCustomersInput');
    // ▲▲▲【修正ここまで】▲▲▲
    const exportProductsBtn = document.getElementById('exportProductsBtn');
    const importProductsBtn = document.getElementById('importProductsBtn');
    const importProductsInput = document.getElementById('importProductsInput');
    const exportPricingBtn = document.getElementById('exportPricingBtn');

    // ▼▼▼【ここから修正】▼▼▼
    // 得意先・卸業者（顧客マスター）エクスポート
    if (exportCustomersBtn) {
        exportCustomersBtn.addEventListener('click', () => {
            window.location.href = '/api/customers/export';
        });
    }

    // 得意先・卸業者（顧客マスター）インポート
    if (importCustomersBtn && importCustomersInput) {
        importCustomersBtn.addEventListener('click', () => {
            importCustomersInput.click();
        });
        importCustomersInput.addEventListener('change', (event) => {
            handleFileUpload(event, '/api/customers/import');
        });
    }
    // ▲▲▲【修正ここまで】▲▲▲

    // 製品エクスポート
    if (exportProductsBtn) {
        exportProductsBtn.addEventListener('click', () => {
            window.location.href = '/api/products/export';
        });
    }

    // 製品インポート
    if (importProductsBtn && importProductsInput) {
        importProductsBtn.addEventListener('click', () => {
            importProductsInput.click();
        });
        importProductsInput.addEventListener('change', (event) => {
            handleFileUpload(event, '/api/products/import');
        });
    }

    // 価格情報バックアップ
    if (exportPricingBtn) {
        exportPricingBtn.addEventListener('click', () => {
            window.location.href = '/api/pricing/backup_export';
        });
    }
}

----- C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\common_table.js -----
import { clientMap, wholesalerMap } from './master_data.js';
import { getLocalDateString } from './utils.js';

export const transactionTypeMap = {
	0: "棚卸", 1: "納品", 2: "返品", 3: "処方", 4: "棚卸増",
	5: "棚卸減", 11: "入庫", 12: "出庫", 30: "月末",
};

function getClientOrWholesalerName(rec) {
	if (!rec.clientCode) return '';
	if (rec.flag === 1 || rec.flag === 2) {
		return wholesalerMap.get(rec.clientCode) || rec.clientCode;
	}
	return clientMap.get(rec.clientCode) || rec.clientCode;
}

export function createUploadTableHTML(tableId) {
	const colgroup = `
    <colgroup>
      <col class="col-1"><col class="col-2"><col class="col-3"><col class="col-4"><col class="col-5">
      <col class="col-6"><col class="col-7"><col class="col-8"><col class="col-9"><col class="col-10">
      <col class="col-11"><col class="col-12"><col class="col-13"><col class="col-14">
    </colgroup>
  `;
	const header = `
    <thead>
      <tr>
        <th rowspan="2">－</th>
        <th>日付</th><th class="yj-jan-code">YJ</th><th colspan="2">製品名</th>
        <th>個数</th><th>YJ数量</th><th>YJ包装数</th><th>YJ単位</th>
        <th>単価</th><th>税額</th><th>期限</th><th>得意先</th><th>行</th>
      </tr>
      <tr>
        <th>種別</th><th class="yj-jan-code">JAN</th><th>包装</th><th>メーカー</th>
        <th>剤型</th><th>JAN数量</th><th>JAN包装数</th><th>JAN単位</th>
        <th>金額</th><th>税率</th><th>ロット</th><th>伝票番号</th><th>MA</th>
      </tr>
    </thead>
  `;
	return `<table id="${tableId}" class="data-table">${colgroup}${header}<tbody></tbody></table>`;
}

export function renderUploadTableRows(records) {
	if (!records || records.length === 0) {
		return `<tr><td colspan="14">対象データがありません。</td></tr>`;
	}

	const getTxClass = (flag) => {
		switch (flag) {
			case 2:
				return 'tx-return';
			case 0:
			case 4:
			case 5:
				return 'tx-inventory';
			default:
				return '';
		}
	};

	let html = "";
	records.forEach(rec => {
		const rowClass = getTxClass(rec.flag);
		html += `
      <tr class="${rowClass}">
        <td rowspan="2"></td>
        <td>${rec.transactionDate || ""}</td>
        <td class="yj-jan-code">${rec.yjCode || ""}</td>
        <td class="left" colspan="2">${rec.productName || ""}</td>
        <td class="right">${rec.datQuantity?.toFixed(2) || ""}</td>
        <td class="right">${rec.yjQuantity?.toFixed(2) || ""}</td>
        <td class="right">${rec.yjPackUnitQty || ""}</td>
        <td>${rec.yjUnitName || ""}</td>
        <td class="right">${rec.unitPrice?.toFixed(2) || ""}</td>
        <td class="right">${rec.taxAmount?.toFixed(2) || ""}</td>
        <td>${rec.expiryDate || ""}</td>
        <td class="left">${getClientOrWholesalerName(rec)}</td>
        <td class="right">${rec.lineNumber || ""}</td>
      </tr>
      <tr class="${rowClass}">
        <td>${transactionTypeMap[rec.flag] ?? ""}</td>
        <td class="yj-jan-code">${rec.janCode || ""}</td>
        <td class="left">${rec.packageSpec || ""}</td>
        <td class="left">${rec.makerName || ""}</td>
        <td class="left">${rec.usageClassification || ""}</td>
        <td class="right">${rec.janQuantity?.toFixed(2) || ""}</td>
        <td class="right">${rec.janPackUnitQty || ""}</td>
        <td>${rec.janUnitName || ""}</td>
        <td class="right">${rec.subtotal?.toFixed(2) || ""}</td>
        <td class="right">${rec.taxRate != null ? (rec.taxRate * 100).toFixed(0) + "%" : ""}</td>
        <td class="left">${rec.lotNumber || ""}</td>
        <td class="left">${rec.receiptNumber || ""}</td>
        <td class="left">${rec.processFlagMA || ""}</td>
      </tr>
    `;
	});

	return html;
}

export function setupDateDropdown(inputEl) {
	if (!inputEl) return;
	inputEl.value = new Date().toISOString().slice(0, 10);
}

export async function setupClientDropdown(selectEl) {
	if (!selectEl) return;
	const preservedOptions = Array.from(selectEl.querySelectorAll('option[value=""]'));
	selectEl.innerHTML = '';
	preservedOptions.forEach(opt => selectEl.appendChild(opt));
	try {
		const res = await fetch('/api/clients');
		if (!res.ok) throw new Error('Failed to fetch clients');
		const clients = await res.json();
		if (clients) {
			clients.forEach(c => {
				const opt = document.createElement('option');
				opt.value = c.code;
				opt.textContent = `${c.code}:${c.name}`;
				selectEl.appendChild(opt);
			});
		}
	} catch (err) {
		console.error("得意先リストの取得に失敗:", err);
	}
}

----- C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\dat.js -----
import { createUploadTableHTML, renderUploadTableRows } from './common_table.js';

export function initDatUpload() {
    const datInput = document.getElementById('datFileInput');
    if (!datInput) return;

    datInput.addEventListener('change', async (e) => {
        const files = e.target.files;
        if (!files.length) return;

        const uploadContainer = document.getElementById('upload-output-container');
        // ▼▼▼【ここからが修正箇所です】▼▼▼
        
        // 先に処理中メッセージだけ表示する
        uploadContainer.innerHTML = `<p>Processing...</p>`;
        window.showLoading();
        
        try {
            const formData = new FormData();
            for (const file of files) formData.append('file', file);
            
            const res = await fetch('/api/dat/upload', { method: 'POST', body: formData });
            const data = await res.json();
            if (!res.ok) throw new Error(data.message || 'DAT file processing failed.');
            
            // --- 修正後の描画ロジック ---
            // 1. データを取得した後に、テーブルの枠と中身をそれぞれ文字列として生成
            const tableShell = createUploadTableHTML('upload-output-table');
            const tableBodyContent = renderUploadTableRows(data.records);
            
            // 2. 文字列を結合して完全なHTMLを作成
            const fullTableHtml = tableShell.replace('<tbody></tbody>', `<tbody>${tableBodyContent}</tbody>`);

            // 3. 完成したHTMLを一度だけDOMに書き込む
            uploadContainer.innerHTML = fullTableHtml;

            window.showNotification('DAT files processed successfully.', 'success');

        } catch (err) {
            // エラー時も同様に、テーブルの枠を作ってからエラーメッセージを表示すると確実
            const tableShell = createUploadTableHTML('upload-output-table');
            const errorRow = `<tr><td colspan="14" style="color:red; text-align:center;">Error: ${err.message}</td></tr>`;
            uploadContainer.innerHTML = tableShell.replace('<tbody></tbody>', `<tbody>${errorRow}</tbody>`);

            window.showNotification(err.message, 'error');
        } finally {
            window.hideLoading();
            e.target.value = '';
        }
        // ▲▲▲【修正ここまで】▲▲▲
    });
}

----- C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\deadstock.js -----
// C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\deadstock.js

import { hiraganaToKatakana, getLocalDateString } from './utils.js';
import { showModal } from './inout_modal.js';

let view, outputContainer, excludeZeroStockCheckbox, createCsvBtn, kanaNameInput, dosageFormInput, importBtn, shelfNumberInput;
let unitMap = {};

async function fetchUnitMap() {
    if (Object.keys(unitMap).length > 0) return;
    try {
        const res = await fetch('/api/units/map');
        if (!res.ok) throw new Error('単位マスタの取得に失敗');
        unitMap = await res.json();
    } catch (err) {
        console.error(err);
    }
}

function formatPackageSpec(master) {
    if (!master) return '';
    const yjUnitName = master.yjUnitName || '';
    let spec = `${master.packageForm || ''} ${master.yjPackUnitQty || 0}${yjUnitName}`;
    if (master.janPackInnerQty > 0 && master.janPackUnitQty > 0) {
        const janUnitName = (master.janUnitCode === 0 || !unitMap[master.janUnitCode]) 
            ? yjUnitName 
            : (unitMap[master.janUnitCode] || yjUnitName);
        spec += ` (${master.janPackInnerQty}${yjUnitName}×${master.janPackUnitQty}${janUnitName})`;
    }
    return spec;
}

function renderDeadStockList(data) {
    if (!data || data.length === 0) {
        outputContainer.innerHTML = "<p>対象データが見つかりませんでした。</p>";
        return;
    }

    let html = data.map(group => {
        const yjHeader = `<div class="yj-group-wrapper">
            <div class="agg-yj-header">
                <div style="flex-grow: 1;">
                    <span>YJ: ${group.yjCode}</span>
                    <span class="product-name">${group.productName}</span>
                </div>
                <button class="btn inventory-adjust-link-btn" data-yj-code="${group.yjCode}">棚卸調整</button>
            </div>`;

        let tableRowsHTML = '';
        group.packageGroups.forEach(pkg => {
            pkg.products.forEach(prod => {
                const savedRecords = prod.savedRecords || [];
                const rowSpanCount = savedRecords.length > 0 ? savedRecords.length : 1;
                const rowSpan = `rowspan="${rowSpanCount}"`;

                const janUnitName = (prod.janUnitCode === 0 || !unitMap[prod.janUnitCode]) 
                    ? prod.yjUnitName 
                    : (unitMap[prod.janUnitCode] || prod.yjUnitName);
                
                const spec = formatPackageSpec(prod);
                const lastUsed = prod.lastUsageDate ? `${prod.lastUsageDate.slice(0,4)}-${prod.lastUsageDate.slice(4,6)}-${prod.lastUsageDate.slice(6,8)}` : '使用履歴なし';
                
                // ▼▼▼【ここから修正】理論在庫をYJ単位からJAN単位に変換 ▼▼▼
                let janStock = prod.currentStock; // デフォルト値
                if (prod.janPackInnerQty > 0) {
                    // YJ単位の理論在庫を内包装数量で割り、JAN単位の在庫数を算出
                    janStock = prod.currentStock / prod.janPackInnerQty;
                }
                
                tableRowsHTML += `
                    <tr>
                        <td class="left" ${rowSpan}>${prod.productName}</td>
                        <td ${rowSpan}>${prod.productCode}</td>
                        <td class="left" ${rowSpan}>${prod.makerName}</td>
                        <td class="left" ${rowSpan}>${spec}</td>
                        <td class="right" ${rowSpan}>${janStock.toFixed(2)} ${janUnitName}</td>
                        <td ${rowSpan}>${lastUsed}</td>`;
                // ▲▲▲【修正ここまで】▲▲▲

                if (savedRecords.length > 0) {
                    const firstRec = savedRecords[0];
                    tableRowsHTML += `
                        <td class="right">${(firstRec.stockQuantityJan || 0).toFixed(2)}</td>
                        <td>${firstRec.expiryDate || ''}</td>
                        <td class="left">${firstRec.lotNumber || ''}</td>
                    </tr>`;
                } else {
                    tableRowsHTML += `
                        <td colspan="3" style="text-align:center; color: #888;">-</td>
                    </tr>`;
                }

                for (let i = 1; i < savedRecords.length; i++) {
                    const rec = savedRecords[i];
                    tableRowsHTML += `
                        <tr>
                            <td class="right">${(rec.stockQuantityJan || 0).toFixed(2)}</td>
                            <td>${rec.expiryDate || ''}</td>
                            <td class="left">${rec.lotNumber || ''}</td>
                        </tr>`;
                }
            });
        });
        
        const tableHTML = `<table class="data-table" style="margin-top: 5px;">
            <thead>
                <tr>
                    <th style="width: 20%;">製品名</th>
                    <th style="width: 12%;">JANコード</th>
                    <th style="width: 12%;">メーカー</th>
                    <th style="width: 18%;">包装仕様</th>
                    <th style="width: 8%;">在庫数</th>
                    <th style="width: 10%;">最終使用日</th>
                    <th style="width: 7%;">在庫</th>
                    <th style="width: 7%;">使用期限</th>
                    <th style="width: 6%;">ロット番号</th>
                </tr>
            </thead>
            <tbody>${tableRowsHTML}</tbody>
        </table></div>`;
        
        return yjHeader + tableHTML;
    }).join('');

    outputContainer.innerHTML = html;
}

export async function initDeadStock() {
    await fetchUnitMap();
    view = document.getElementById('deadstock-view');
    if (!view) return;

    outputContainer = document.getElementById('deadstock-output-container');
    excludeZeroStockCheckbox = document.getElementById('ds-exclude-zero-stock');
    createCsvBtn = document.getElementById('create-deadstock-csv-btn');
    kanaNameInput = document.getElementById('ds-kanaName');
    dosageFormInput = document.getElementById('ds-dosageForm');
    importBtn = document.getElementById('import-deadstock-btn');
    const printBtn = document.getElementById('print-deadstock-btn');
    const printArea = document.getElementById('deadstock-print-area');
    const importDeadstockInput = document.getElementById('importDeadstockInput');
    shelfNumberInput = document.getElementById('ds-shelf-number');

    if (printBtn) {
        printBtn.addEventListener('click', () => {
            const originalContent = outputContainer.querySelector('.yj-group-wrapper');
            if (!originalContent) {
                window.showNotification('印刷するデータがありません。先にリストを作成してください。', 'error');
                return;
            }

            const style = document.createElement('style');
            style.innerHTML = '@page { size: A4 portrait; margin: 1cm; }';
            style.id = 'print-style-portrait';
            document.head.appendChild(style);

            const contentToPrint = outputContainer.cloneNode(true);
            contentToPrint.querySelectorAll('button').forEach(btn => btn.remove());
            
            printArea.innerHTML = `
                <h2 style="text-align: center; margin-bottom: 20px;">不動在庫リスト</h2>
                <p style="text-align: right; margin-bottom: 10px;">印刷日: ${new Date().toLocaleDateString()}</p>
                ${contentToPrint.innerHTML}
            `;

            view.classList.add('print-this-view');
            outputContainer.classList.add('hidden');
            printArea.classList.remove('hidden');

            window.print();
        });
    }

    window.addEventListener('afterprint', () => {
        const printStyle = document.getElementById('print-style-portrait');
        if (printStyle) {
            printStyle.remove();
        }

        if (view.classList.contains('print-this-view')) {
            outputContainer.classList.remove('hidden');
            printArea.classList.add('hidden');
            view.classList.remove('print-this-view');
        }
    });
    
    if (outputContainer) {
        outputContainer.addEventListener('click', async (e) => {
            const target = e.target;
            if (target.classList.contains('inventory-adjust-link-btn')) {
                const yjCode = target.dataset.yjCode;
                const event = new CustomEvent('navigateToInventoryAdjustment', {
                    detail: { yjCode: yjCode },
                    bubbles: true
                });
                target.dispatchEvent(event);
            }
        });
    }

    if (view) {
        const runBtn = view.querySelector('#run-dead-stock-btn');
        if (runBtn) {
            runBtn.addEventListener('click', () => {
                window.showLoading();
                const params = new URLSearchParams({
                    excludeZeroStock: excludeZeroStockCheckbox.checked,
                    kanaName: hiraganaToKatakana(kanaNameInput.value),
                    dosageForm: dosageFormInput.value,
                    shelfNumber: shelfNumberInput.value,
                });
                fetch(`/api/deadstock/list?${params.toString()}`)
                    .then(res => {
                        if (!res.ok) { return res.text().then(text => { throw new Error(text || 'Failed to generate dead stock list') }); }
                        return res.json();
                    })
                    .then(data => renderDeadStockList(data))
                    .catch(err => { outputContainer.innerHTML = `<p style="color:red;">エラー: ${err.message}</p>`; })
                    .finally(() => { window.hideLoading(); });
            });
        }
    }

    if (createCsvBtn) {
        createCsvBtn.addEventListener('click', () => {
            const params = new URLSearchParams({
                excludeZeroStock: excludeZeroStockCheckbox.checked,
                kanaName: hiraganaToKatakana(kanaNameInput.value),
                dosageForm: dosageFormInput.value,
                shelfNumber: shelfNumberInput.value,
            });
            window.location.href = `/api/deadstock/export?${params.toString()}`;
        });
    }

    if (importBtn && importDeadstockInput) {
        importBtn.addEventListener('click', () => {
            importDeadstockInput.click();
        });

        importDeadstockInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);
            
            window.showLoading('CSVファイルをインポート中...');
            try {
                const res = await fetch('/api/deadstock/import', {
                    method: 'POST',
                    body: formData,
                });
                const resData = await res.json();
                if (!res.ok) {
                    throw new Error(resData.message || 'インポートに失敗しました。');
                }
                window.showNotification(resData.message, 'success');
                view.querySelector('#run-dead-stock-btn').click();
            } catch (err) {
                console.error(err);
                window.showNotification(`エラー: ${err.message}`, 'error');
            } finally {
                window.hideLoading();
                event.target.value = '';
            }
        });
    }
}

----- C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\edge.js -----
// C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\edge.js

export function initEdge() {
    const downloadBtn = document.getElementById('edgeDownloadBtn');
    if (!downloadBtn) return;

    downloadBtn.addEventListener('click', async () => {
        if (!confirm('edeにログインし、納品データをダウンロードします。よろしいですか？')) {
            return;
        }

        window.showLoading();
        try {
            const res = await fetch('/api/edge/download', {
                method: 'POST',
            });
            
            // ▼▼▼ [ここから修正] エラーハンドリングを改善 ▼▼▼
            if (!res.ok) {
                const errorText = await res.text();
                try {
                    const resData = JSON.parse(errorText);
                    throw new Error(resData.message || `ダウンロードに失敗しました (HTTP ${res.status})`);
                } catch (e) {
                    throw new Error(errorText || `ダウンロードに失敗しました (HTTP ${res.status})`);
                }
            }
            const resData = await res.json();
            window.showNotification(resData.message, 'success');
            // ▲▲▲ [修正ここまで] ▲▲▲
        } catch (err) {
            console.error('Download failed:', err);
            const errorMessage = err.message || 'サーバーとの通信に失敗しました。設定画面でID/パスワードが正しいか確認してください。';
            window.showNotification(errorMessage, 'error');
        } finally {
            window.hideLoading();
        }
    });
}

----- C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\inout_details_table.js -----
// C:\Dev\WASABI\static\js\inout_details_table.js

import { showModal } from './inout_modal.js';
import { transactionTypeMap, createUploadTableHTML } from './common_table.js';

let tableBody, addRowBtn, tableContainer;
// ▼▼▼ [修正点] 「個数」をINPUTから表示用のセルに変更 ▼▼▼
function createInoutRowsHTML(record = {}) {
    const rowId = record.lineNumber || `new-${Date.now()}`;
    const janQuantity = record.janQuantity ?? 1;
    const datQuantity = record.datQuantity ?? 1;
    // Default value, will be recalculated
    const nhiPrice = record.nhiPrice || 0;
    const janPackInnerQty = record.janPackInnerQty ||
    0;
    const yjQuantity = janQuantity * janPackInnerQty;
    const subtotal = yjQuantity * nhiPrice;
    const transactionType = record.flag ?
    (transactionTypeMap[record.flag] || '') : '';

    const upperRow = `
        <tr data-row-id="${rowId}">
            <td rowspan="2" class="center"><button class="delete-row-btn btn">削除</button></td>
            <td>${record.transactionDate ||
            ''}</td>
            <td class="yj-jan-code display-yj-code">${record.yjCode ||
            ''}</td>
            <td colspan="2" class="product-name-cell left" style="cursor: pointer; text-decoration: underline; color: blue;">${record.productName ||
            'ここをクリックして製品を検索'}</td>
            <td class="right display-dat-quantity">${datQuantity.toFixed(2)}</td>
            <td class="right display-yj-quantity">${yjQuantity.toFixed(2)}</td>
            <td class="right display-yj-pack-unit-qty">${record.yjPackUnitQty ||
            ''}</td>
            <td class="display-yj-unit-name">${record.yjUnitName ||
            ''}</td>
            <td class="right display-unit-price">${nhiPrice.toFixed(4)}</td>
            <td class="right">${record.taxAmount ||
            ''}</td>
            <td><input type="text" name="expiryDate" value="${record.expiryDate || ''}" placeholder="YYYYMM"></td>
            <td class="left">${record.clientCode ||
            ''}</td>
            <td class="right">${record.lineNumber ||
            ''}</td>
        </tr>`;

    const lowerRow = `
        <tr data-row-id-lower="${rowId}">
            <td>${transactionType}</td>
            <td class="yj-jan-code display-jan-code">${record.productCode ||
            record.janCode || ''}</td>
            <td class="left display-package-spec">${record.formattedPackageSpec || record.packageSpec ||
            ''}</td>
            <td class="left display-maker-name">${record.makerName ||
            ''}</td>
            <td class="left display-usage-classification">${record.usageClassification ||
            ''}</td>
            <td class="right"><input type="number" name="janQuantity" value="${janQuantity}" step="any"></td>
            <td class="right display-jan-pack-unit-qty">${record.janPackUnitQty ||
            ''}</td>
            <td class="display-jan-unit-name">${record.janUnitName ||
            ''}</td>
            <td class="right display-subtotal">${subtotal.toFixed(2)}</td>
            <td class="right">${record.taxRate != null ?
            (record.taxRate * 100).toFixed(0) + "%" : ""}</td>
            <td class="left"><input type="text" name="lotNumber" value="${record.lotNumber || ''}"></td>
            <td class="left">${record.receiptNumber ||
            ''}</td>
            <td class="left">${record.processFlagMA ||
            ''}</td>
        </tr>`;

    return upperRow + lowerRow;
}

export function populateDetailsTable(records) {
    if (!records || records.length === 0) {
        clearDetailsTable();
        return;
    }
    tableBody.innerHTML = records.map(createInoutRowsHTML).join('');
    
    tableBody.querySelectorAll('tr[data-row-id]').forEach((row, index) => {
        if (records[index]) {
            const masterData = { ...records[index] };
            delete masterData.id;
            delete masterData.runningBalance;
            row.dataset.product = JSON.stringify(masterData);
            recalculateRow(row); // Recalculate to set the initial datQuantity correctly
  
        }
    });
}

export function clearDetailsTable() {
    if (tableBody) {
        tableBody.innerHTML = `<tr><td colspan="14">ヘッダーで情報を選択後、「明細を追加」ボタンを押してください。</td></tr>`;
    }
}

/**
 * @brief 保存する全ての明細データをテーブルから収集します。
 * @details
 * 画面に表示されている全ての行（既存・新規問わず）を走査し、
 * 製品データが設定されている有効な行のみを抽出して配列にまとめます。
 * これにより、追記保存時に既存のデータが欠落することを防ぎます。
 * デバッグ用に、どの行が処理されたかをコンソールに出力します。
 * @returns {Array} 保存用の明細レコードの配列
 */
export function getDetailsData() {
    console.log("Collecting details data for saving...");
    const records = [];
    const allUpperRows = tableBody.querySelectorAll('tr[data-row-id]');
    console.log(`Found ${allUpperRows.length} item rows in the table.`);
    allUpperRows.forEach((upperRow, index) => {
        const productDataString = upperRow.dataset.product;

        // 製品情報が設定されていない行（空の行など）は保存対象外とします
        if (!productDataString || productDataString === '{}') {
            console.log(`Row ${index + 1} skipped: No product data found.`);
            return; // continue
        }

        const lowerRow = upperRow.nextElementSibling;
        if (!lowerRow) 
        {
            console.error(`Row ${index + 1} is missing its corresponding lower row.`);
            return; // continue
        }

        const productData = JSON.parse(productDataString);
        const janQuantity = parseFloat(lowerRow.querySelector('input[name="janQuantity"]').value) || 0;
        let datQuantity = 0;
        if (productData.janPackUnitQty > 0) {
  
           
           datQuantity = janQuantity / productData.janPackUnitQty;
        }

        const record = {
            productCode: productData.janCode,
            productName: productData.productName,
            janQuantity: janQuantity,
            datQuantity: datQuantity,
      
            expiryDate: upperRow.querySelector('input[name="expiryDate"]').value,
          
           lotNumber: lowerRow.querySelector('input[name="lotNumber"]').value,
        };
        console.log(`Row ${index + 1} processed:`, record);
        records.push(record);
    });
    console.log(`Total records to be saved: ${records.length}`, records);
    return records;
}
function recalculateRow(upperRow) {
    const productDataString = upperRow.dataset.product;
    if (!productDataString) return;
    const product = JSON.parse(productDataString);
    const lowerRow = upperRow.nextElementSibling;
    if (!lowerRow) return;
    
    const janQuantity = parseFloat(lowerRow.querySelector('[name="janQuantity"]').value) || 0;
    const nhiPrice = parseFloat(product.nhiPrice) || 0;
    const janPackInnerQty = parseFloat(product.janPackInnerQty) || 0;
    const janPackUnitQty = parseFloat(product.janPackUnitQty) || 0;

    let datQuantity = 0;
    if(janPackUnitQty > 0) {
        datQuantity = janQuantity / janPackUnitQty;
    }
    const yjQuantity = janQuantity * janPackInnerQty;
    const subtotal = yjQuantity * nhiPrice;

    upperRow.querySelector('.display-dat-quantity').textContent = datQuantity.toFixed(2);
    upperRow.querySelector('.display-yj-quantity').textContent = yjQuantity.toFixed(2);
    lowerRow.querySelector('.display-subtotal').textContent = subtotal.toFixed(2);
}
// ▲▲▲ 修正ここまで ▲▲▲

export function initDetailsTable() {
    tableContainer = document.getElementById('inout-details-container');
    addRowBtn = document.getElementById('addRowBtn');
    if (!tableContainer || !addRowBtn) return;
    
    tableContainer.innerHTML = createUploadTableHTML('inout-details-table');
    tableBody = document.querySelector('#inout-details-table tbody');
    addRowBtn.addEventListener('click', () => {
        if (tableBody.querySelector('td[colspan="14"]')) {
            tableBody.innerHTML = '';
        }
        tableBody.insertAdjacentHTML('beforeend', createInoutRowsHTML());
    });
    tableBody.addEventListener('click', (e) => {
        if (e.target.classList.contains('delete-row-btn')) {
            const upperRow = e.target.closest('tr');
            const lowerRow = upperRow.nextElementSibling;
            if(lowerRow) lowerRow.remove();
            upperRow.remove();
            if (tableBody.children.length === 0) {
                
                clearDetailsTable();
            }
        }
        if (e.target.classList.contains('product-name-cell')) {
            const activeRow = e.target.closest('tr');
            showModal(activeRow, (selectedProduct, targetRow) => {
                // ▼▼▼【ここからが修正箇所です】▼▼▼
                // 選択された製品データ(productCodeを持つ)を、
                // 既存の取引データ(janCodeを持つ)と構造を合わせるために正規化します。
                const productToStore = { ...selectedProduct };
                productToStore.janCode = productToStore.productCode; // janCodeプロパティを追加

                // 正規化したオブジェクトをデータとして保存します。
                targetRow.dataset.product = JSON.stringify(productToStore);
                // ▲▲▲【修正ここまで】▲▲▲
         
                const lowerRow = targetRow.nextElementSibling;
                
                targetRow.querySelector('.display-yj-code').textContent = selectedProduct.yjCode;
                targetRow.querySelector('.product-name-cell').textContent = selectedProduct.productName;
                targetRow.querySelector('.display-yj-pack-unit-qty').textContent = selectedProduct.yjPackUnitQty || '';
                targetRow.querySelector('.display-yj-unit-name').textContent = selectedProduct.yjUnitName || '';
                targetRow.querySelector('.display-unit-price').textContent = (selectedProduct.nhiPrice || 0).toFixed(4);
                
                lowerRow.querySelector('.display-jan-code').textContent = selectedProduct.productCode;
                lowerRow.querySelector('.display-package-spec').textContent = selectedProduct.formattedPackageSpec || '';
                lowerRow.querySelector('.display-maker-name').textContent = selectedProduct.makerName;
                lowerRow.querySelector('.display-usage-classification').textContent = selectedProduct.usageClassification || '';
                lowerRow.querySelector('.display-jan-pack-unit-qty').textContent = selectedProduct.janPackUnitQty || '';
                lowerRow.querySelector('.display-jan-unit-name').textContent = selectedProduct.janUnitName || '';
                
                const quantityInput = lowerRow.querySelector('input[name="janQuantity"]');
                quantityInput.focus();
                quantityInput.select();
                recalculateRow(targetRow);
            });
        }
    });
    tableBody.addEventListener('input', (e) => {
        const upperRow = e.target.closest('tr[data-row-id]') || e.target.closest('tr[data-row-id-lower]')?.previousElementSibling;
        if(upperRow) {
            recalculateRow(upperRow);
        }
    });
}

----- C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\inout_header.js -----
// C:\Dev\WASABI\static\js\inout_header.js

import { setupDateDropdown, setupClientDropdown } from './common_table.js';
// ▼▼▼ [修正点] refreshClientMap をインポート ▼▼▼
import { refreshClientMap } from './master_data.js';
// ▲▲▲ 修正ここまで ▲▲▲

const NEW_ENTRY_VALUE = '--new--';
let clientSelect, receiptSelect, saveBtn, deleteBtn, headerDateInput, headerTypeSelect;
let newClientName = null;
let currentLoadedReceipt = null;

// (initializeClientDropdown, resetHeader 関数は変更ありません)
async function initializeClientDropdown() {
	clientSelect.innerHTML = `<option value="">選択してください</option>`;
	await setupClientDropdown(clientSelect);
	
	const newOption = document.createElement('option');
	newOption.value = NEW_ENTRY_VALUE;
	newOption.textContent = '--- 新規作成 ---';
	clientSelect.appendChild(newOption);
}

export function resetHeader() {
	if (!clientSelect || !headerDateInput) return;
	setupDateDropdown(headerDateInput);
	initializeClientDropdown();
	
	receiptSelect.innerHTML = `
		<option value="">日付を選択してください</option>
		<option value="${NEW_ENTRY_VALUE}">--- 新規作成 ---</option>
	`;
	headerTypeSelect.value = "入庫";
	newClientName = null;
	currentLoadedReceipt = null;
	deleteBtn.disabled = true;
	headerDateInput.dispatchEvent(new Event('change'));
}

export async function initHeader(getDetailsData, clearDetailsTable, populateDetailsTable) {
	clientSelect = document.getElementById('in-out-client');
	receiptSelect = document.getElementById('in-out-receipt');
	saveBtn = document.getElementById('saveBtn');
	deleteBtn = document.getElementById('deleteBtn');
	headerDateInput = document.getElementById('in-out-date');
	headerTypeSelect = document.getElementById('in-out-type');

	if (!clientSelect || !receiptSelect || !saveBtn || !deleteBtn) return;
	
    // (各種イベントリスナーは変更ありません)
	headerDateInput.addEventListener('change', async () => {
		const date = headerDateInput.value.replace(/-/g, '');
		if (!date) return;
		try {
			const res = await fetch(`/api/receipts?date=${date}`);
			if (!res.ok) throw new Error('伝票の取得に失敗');
			const receiptNumbers = await res.json();
			
			receiptSelect.innerHTML = `
				<option value="">選択してください</option>
				<option value="${NEW_ENTRY_VALUE}">--- 新規作成 ---</option>
			`;
			if (receiptNumbers && receiptNumbers.length > 0) {
				receiptNumbers.forEach(num => {
					const opt = document.createElement('option');
					opt.value = num;
					opt.textContent = num;
					receiptSelect.appendChild(opt);
				});
			}
		} catch (err) { console.error(err); }
	});

	clientSelect.addEventListener('change', () => {
		const selectedValue = clientSelect.value;
		if (selectedValue === NEW_ENTRY_VALUE) {
			const name = prompt('新しい得意先名を入力してください:');
			if (name && name.trim()) {
				newClientName = name.trim();
				const opt = document.createElement('option');
				opt.value = `new:${newClientName}`;
				opt.textContent = `[新規] ${newClientName}`;
				opt.selected = true;
				clientSelect.appendChild(opt);
			} else {
				clientSelect.value = '';
			}
		} else if (!selectedValue.startsWith('new:')) {
			newClientName = null;
		}
	});
	receiptSelect.addEventListener('change', async () => {
		const selectedValue = receiptSelect.value;
		deleteBtn.disabled = (selectedValue === NEW_ENTRY_VALUE || selectedValue === "");

		if (selectedValue === NEW_ENTRY_VALUE || selectedValue === "") {
			clearDetailsTable();
			currentLoadedReceipt = null;
		} else {
			window.showLoading();
			try {
				const res = await fetch(`/api/transaction/${selectedValue}`);
				if (!res.ok) throw new Error('明細の読込に失敗');
				const records = await res.json();
				if (records && records.length > 0) {
					currentLoadedReceipt = selectedValue;
					clientSelect.value = records[0].clientCode;
					headerTypeSelect.value = records[0].flag === 11 ? "入庫" : "出庫";
					newClientName = null;
				}
				populateDetailsTable(records);
			} catch (err) {
				console.error(err);
				window.showNotification(err.message, 'error');
			} finally {
				window.hideLoading();
			}
		}
	});

	saveBtn.addEventListener('click', async () => {
		let clientCode = clientSelect.value;
		let clientNameToSave = '';
		let isNewClient = false;
		if (newClientName && clientCode.startsWith('new:')) {
			clientNameToSave = newClientName;
			isNewClient = true;
			clientCode = '';
		} else {
			if (!clientCode || clientCode === NEW_ENTRY_VALUE) {
				window.showNotification('得意先を選択または新規作成してください。', 'error');
				return;
			}
		}
		const records = getDetailsData();
		if (records.length === 0) {
			window.showNotification('保存する明細データがありません。', 'error');
			return;
		}
		const payload = {
			isNewClient, clientCode, clientName: clientNameToSave,
			transactionDate: headerDateInput.value.replace(/-/g, ''),
			transactionType: headerTypeSelect.value,
			records: records,
			originalReceiptNumber: currentLoadedReceipt
		};
		window.showLoading();
		try {
			const res = await fetch('/api/inout/save', {
				method: 'POST',
				headers: { 'Content-Type': 'application/json' },
				body: JSON.stringify(payload),
			});
			const resData = await res.json();
			if (!res.ok) {
				throw new Error(resData.message || `保存に失敗しました (HTTP ${res.status})`);
			}

			// ▼▼▼ [修正点] 新規得意先が作成された場合、変換マップを更新する ▼▼▼
			if (resData.newClient) {
				await refreshClientMap();
			}
			// ▲▲▲ 修正ここまで ▲▲▲

			window.showNotification(`データを保存しました。\n伝票番号: ${resData.receiptNumber}`, 'success');
			resetHeader();
			clearDetailsTable();
		} catch (err) {
			console.error(err);
			window.showNotification(err.message, 'error');
		} finally {
			window.hideLoading();
		}
	});

	deleteBtn.addEventListener('click', async () => {
		const receiptNumber = receiptSelect.value;
		if (!receiptNumber || receiptNumber === NEW_ENTRY_VALUE) {
			window.showNotification("削除対象の伝票が選択されていません。", 'error');
			return;
		}
		if (!confirm(`伝票番号 [${receiptNumber}] を完全に削除します。よろしいですか？`)) {
			return;
		}
		window.showLoading();
		try {
			const res = await fetch(`/api/transaction/delete/${receiptNumber}`, { method: 'DELETE' });
			const errData = await res.json().catch(() => null);
			if (!res.ok) {
				throw new Error(errData?.message || '削除に失敗しました。');
			}
			window.showNotification(`伝票 [${receiptNumber}] を削除しました。`, 'success');
			resetHeader();
			clearDetailsTable();
		} catch(err) {
			console.error(err);
			window.showNotification(err.message, 'error');
		} finally {
			window.hideLoading();
		}
	});
}

----- C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\inout_modal.js -----
// C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\inout_modal.js

import { hiraganaToKatakana } from './utils.js';

let activeCallback = null;
let activeRowElement = null;
let skipQueryLengthCheck = false; 

const DEFAULT_SEARCH_API = '/api/products/search';
const modal = document.getElementById('search-modal');
const closeModalBtn = document.getElementById('closeModalBtn');
const searchInput = document.getElementById('product-search-input');
const searchBtn = document.getElementById('product-search-btn');
const searchResultsBody = document.querySelector('#search-results-table tbody');

function hideModal() {
  if (modal) {
        modal.classList.add('hidden');
        document.body.classList.remove('modal-open');
    }
}

function handleResultClick(event) {
  if (event.target && event.target.classList.contains('select-product-btn')) {
    const product = JSON.parse(event.target.dataset.product);
    if (typeof activeCallback === 'function') {
      activeCallback(product, activeRowElement);
    }
    hideModal();
  }
}

async function performSearch() {
  const query = hiraganaToKatakana(searchInput.value.trim());
  if (!skipQueryLengthCheck && query.length < 2) {
    alert('検索キーワードを2文字以上入力してください。');
    searchResultsBody.innerHTML = '<tr><td colspan="6" class="center">2文字以上入力して検索してください。</td></tr>';
    return;
  }
  
  const searchApi = modal.dataset.searchApi || DEFAULT_SEARCH_API;
  searchResultsBody.innerHTML = '<tr><td colspan="6" class="center">検索中...</td></tr>';

  try {
    const separator = searchApi.includes('?') ? '&' : '?';
    const fullUrl = `${searchApi}${separator}q=${encodeURIComponent(query)}`;
    const res = await fetch(fullUrl);

    if (!res.ok) {
        throw new Error(`サーバーエラー: ${res.status}`);
    }
    const products = await res.json();
    renderSearchResults(products);
  } catch (err) {
    searchResultsBody.innerHTML = `<tr><td colspan="6" class="center" style="color:red;">${err.message}</td></tr>`;
  }
}

function renderSearchResults(products) {
  if (!products || products.length === 0) {
    searchResultsBody.innerHTML = '<tr><td colspan="6" class="center">該当する製品が見つかりません。</td></tr>';
    return;
  }

  // ▼▼▼【ここから修正】▼▼▼
  let html = '';
  products.forEach(p => {
    const productData = JSON.stringify(p);
    const rowClass = p.isAdopted ? 'class="adopted-item"' : '';
    html += `
      <tr ${rowClass}>
        <td class="left">${p.productName || ''}</td>
        <td class="left">${p.makerName || ''}</td>
        <td class="left">${p.formattedPackageSpec}</td>
        <td>${p.yjCode || ''}</td>
        <td>${p.productCode || ''}</td>
        <td><button class="select-product-btn" data-product='${productData.replace(/'/g, "&apos;")}'>選択</button></td>
      </tr>
    `;
  });
  // ▲▲▲【修正ここまで】▲▲▲
  searchResultsBody.innerHTML = html;
}

export function initModal() {
  if (!modal || !closeModalBtn || !searchInput || !searchBtn || !searchResultsBody) {
    console.error("薬品検索モーダルの必須要素が見つかりません。");
    return;
  }
  closeModalBtn.addEventListener('click', hideModal);
  searchBtn.addEventListener('click', () => performSearch());
  searchInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
      e.preventDefault();
      performSearch();
    }
  });
  searchResultsBody.addEventListener('click', handleResultClick);
}

export function showModal(rowElement, callback, options = {}) {
  if (modal) {
    document.body.classList.add('modal-open');
    activeRowElement = rowElement;
    activeCallback = callback; 
    
    skipQueryLengthCheck = options.skipQueryLengthCheck || false;
    searchInput.placeholder = skipQueryLengthCheck ? '製品名またはカナ名（絞り込みフィルタ有効）' : '製品名またはカナ名（2文字以上）';
    
    const searchApi = options.searchApi || DEFAULT_SEARCH_API;
    modal.dataset.searchApi = searchApi;
    
    modal.classList.remove('hidden');
    searchInput.value = '';
    setTimeout(() => {
        searchInput.focus();
    }, 0);

    if (options.initialResults) {
        renderSearchResults(options.initialResults);
    } else {
        searchResultsBody.innerHTML = '<tr><td colspan="6" class="center">製品名を入力して検索してください。</td></tr>';
    }
  }
}

----- C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\inout.js -----
import { initHeader, resetHeader } from './inout_header.js';
import { initDetailsTable, getDetailsData, clearDetailsTable, populateDetailsTable } from './inout_details_table.js';

export async function initInOut() {
  initDetailsTable();
  await initHeader(getDetailsData, clearDetailsTable, populateDetailsTable);
}

export function resetInOutView() {
    clearDetailsTable();
    resetHeader();
}

----- C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\inventory_adjustment_logic.js -----
// C:/Users/wasab/OneDrive/デスクトップ/WASABI/static/js/inventory_adjustment_logic.js
import { showModal } from './inout_modal.js';
import { hiraganaToKatakana, getLocalDateString } from './utils.js';
import { generateFullHtml, createFinalInputRow, setUnitMap } from './inventory_adjustment_ui.js';

let view, outputContainer;
let dosageFormFilter, kanaInitialFilter, selectProductBtn, deadStockOnlyFilter, barcodeInput, shelfNumberInput;
let currentYjCode = null;
let lastLoadedDataCache = null;

// ▼▼▼【ここから修正】▼▼▼
function parseGS1_128(code) {
    let rest = code;
    const data = {};

    if (rest.startsWith('01')) {
        if (rest.length < 16) return null;
        data.gs1Code = rest.substring(2, 16);
        rest = rest.substring(16);
    } else {
        return null;
    }

    if (rest.startsWith('17')) {
        if (rest.length < 8) return data;
        const yy_mm_dd = rest.substring(2, 8); // 例: "251000"
        if (yy_mm_dd.length === 6) {
            const yy = yy_mm_dd.substring(0, 2); // "25"
            const mm = yy_mm_dd.substring(2, 4); // "10"
            data.expiryDate = `20${yy}${mm}`;   // "202510" に変換
        } else {
            data.expiryDate = yy_mm_dd; // 予期せぬ形式の場合はそのまま
        }
        rest = rest.substring(8);
    }

    if (rest.startsWith('10')) {
        const groupSeparatorIndex = rest.indexOf('\x1D'); // GS (Group Separator)
        if (groupSeparatorIndex !== -1) {
            data.lotNumber = rest.substring(2, groupSeparatorIndex);
        } else {
            data.lotNumber = rest.substring(2);
        }
    }
   
    return data;
}
// ▲▲▲【修正ここまで】▲▲▲

async function handleAdjustmentBarcodeScan(e) {
    e.preventDefault();
    const barcodeInput = document.getElementById('adjustment-barcode-input');
    const inputValue = barcodeInput.value.trim();
    if (!inputValue) return;

    const parsedData = parseGS1_128(inputValue);
    if (!parsedData || !parsedData.gs1Code) {
        window.showNotification('GS1-128形式のバーコードではありません。', 'error');
        barcodeInput.value = '';
        return;
    }

    window.showLoading('製品情報を検索中...');
    try {
        const res = await fetch(`/api/product/by_gs1?gs1_code=${parsedData.gs1Code}`);
        
        let productMaster;
        if (!res.ok) {
            if (res.status === 404) {
                 if (confirm(`このGS1コードはマスターに登録されていません。\n新規マスターを作成しますか？`)) {
                    productMaster = await createProvisionalMaster(parsedData.gs1Code);
                 } else {
                    throw new Error('このGS1コードはマスターに登録されていません。');
                 }
            } else {
                throw new Error('製品情報の検索に失敗しました。');
            }
        } else {
            productMaster = await res.json();
        }

        const productTbody = outputContainer.querySelector(`.final-input-tbody[data-product-code="${productMaster.productCode}"]`);
        if (!productTbody) {
            throw new Error(`画面内に製品「${productMaster.productName}」の入力欄が見つかりません。`);
        }

        let targetRow = null;
        const rows = productTbody.querySelectorAll('tr.inventory-row');
        for (let i = 0; i < rows.length; i += 2) {
            const expiryInput = rows[i].querySelector('.expiry-input');
            const lotInput = rows[i+1].querySelector('.lot-input');
            if (expiryInput.value.trim() === '' && lotInput.value.trim() === '') {
                targetRow = rows[i];
                break;
            }
        }

        if (!targetRow) {
            const addBtn = productTbody.querySelector('.add-deadstock-row-btn');
            if (addBtn) {
                addBtn.click();
                const newRows = productTbody.querySelectorAll('tr.inventory-row');
                targetRow = newRows[newRows.length - 2];
            }
        }

        if (targetRow) {
            const expiryInput = targetRow.querySelector('.expiry-input');
            const lotInput = targetRow.nextElementSibling.querySelector('.lot-input');
            if (parsedData.expiryDate) {
                expiryInput.value = parsedData.expiryDate;
            }
            if (parsedData.lotNumber) {
                lotInput.value = parsedData.lotNumber;
            }
            window.showNotification('ロット・期限を自動入力しました。', 'success');
        } else {
            throw new Error('ロット・期限の入力欄の追加に失敗しました。');
        }

    } catch (err) {
        window.showNotification(err.message, 'error');
    } finally {
        window.hideLoading();
        barcodeInput.value = '';
        barcodeInput.focus();
    }
}

async function handleBarcodeScan(e) {
    e.preventDefault();
    
    const barcodeInput = document.getElementById('ia-barcode-input');
    const inputValue = barcodeInput.value.trim();
    if (!inputValue) return;

    let gs1Code = '';
    if (inputValue.startsWith('01') && inputValue.length > 16) {
        const parsedData = parseGS1_128(inputValue);
        if (parsedData) {
            gs1Code = parsedData.gs1Code;
        }
    }
    
    if (!gs1Code) {
        gs1Code = inputValue;
    }

    if (!gs1Code) {
        window.showNotification('有効なGS1コードではありません。', 'error');
        return;
    }
   
    window.showLoading('製品情報を検索中...');
    try {
        const res = await fetch(`/api/product/by_gs1?gs1_code=${gs1Code}`);
        if (!res.ok) {
            if (res.status === 404) {
                if (confirm(`このGS1コードはマスターに登録されていません。\n新規マスターを作成しますか？`)) {
                    await createProvisionalMaster(gs1Code);
                } else {
                    throw new Error('このGS1コードはマスターに登録されていません。');
                }
            } else {
                throw new Error('製品情報の検索に失敗しました。');
            }
        } else {
            const productMaster = await res.json();
            await loadAndRenderDetails(productMaster.yjCode);
            barcodeInput.value = '';
            barcodeInput.focus();
        }
    } catch (err) {
        window.showNotification(err.message, 'error');
    } finally {
        window.hideLoading();
    }
}

async function createProvisionalMaster(gs1Code) {
    window.showLoading('新規マスターを作成中...');
    try {
        const productCode = gs1Code.length === 14 ? gs1Code.substring(1) : gs1Code;
        const res = await fetch('/api/master/create_provisional', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ gs1Code: gs1Code, productCode: productCode }),
        });
        const resData = await res.json();
        if (!res.ok) {
            throw new Error(resData.message || 'マスターの作成に失敗しました。');
        }
        window.showNotification(`新規マスターを作成しました (YJ: ${resData.yjCode})`, 'success');
        await loadAndRenderDetails(resData.yjCode);
        const mainBarcode = document.getElementById('ia-barcode-input');
        if(mainBarcode) {
            mainBarcode.value = '';
            mainBarcode.focus();
        }
    } catch (err) {
        throw err;
    }
}

async function onSelectProductClick() {
    const dosageForm = dosageFormFilter.value;
    const kanaInitial = kanaInitialFilter.value;
    const isDeadStockOnly = deadStockOnlyFilter.checked;
    const shelfNumber = shelfNumberInput.value.trim();
    
    const params = new URLSearchParams({
        dosageForm: dosageForm,
        kanaInitial: kanaInitial,
        deadStockOnly: isDeadStockOnly,
        shelfNumber: shelfNumber,
    });
    
    const apiUrl = `/api/products/search_filtered?${params.toString()}`;
    const shouldSkipQueryLengthCheck = !!(dosageForm || kanaInitial || isDeadStockOnly || shelfNumber);
    
    window.showLoading();
    try {
        const res = await fetch(apiUrl);
        if (!res.ok) throw new Error('品目リストの取得に失敗しました。');
        const products = await res.json();
        window.hideLoading();
        showModal(view, (selectedProduct) => {
            loadAndRenderDetails(selectedProduct.yjCode);
        }, { 
            initialResults: products, 
            searchApi: apiUrl,
            skipQueryLengthCheck: shouldSkipQueryLengthCheck
        });
    } catch (err) {
        window.hideLoading();
        window.showNotification(err.message, 'error');
    }
}

async function loadAndRenderDetails(yjCode) {
    currentYjCode = yjCode;
    if (!yjCode) {
        window.showNotification('YJコードを指定してください。', 'error');
        return;
    }
    window.showLoading();
    outputContainer.innerHTML = '<p>データを読み込んでいます...</p>';
    try {
        const apiUrl = `/api/inventory/adjust/data?yjCode=${yjCode}`;
        const res = await fetch(apiUrl);
        if (!res.ok) {
            const errText = await res.text();
            throw new Error(errText || 'データ取得に失敗しました。');
        }
        
        lastLoadedDataCache = await res.json();
        const html = generateFullHtml(lastLoadedDataCache, lastLoadedDataCache);
        outputContainer.innerHTML = html;
        
        const dateInput = document.getElementById('inventory-date');
        if(dateInput) {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yyyy = yesterday.getFullYear();
            const mm = String(yesterday.getMonth() + 1).padStart(2, '0');
            const dd = String(yesterday.getDate()).padStart(2, '0');
            dateInput.value = `${yyyy}-${mm}-${dd}`;
        }
    } catch (err) {
        outputContainer.innerHTML = `<p style="color:red;">エラー: ${err.message}</p>`;
    } finally {
        window.hideLoading();
    }
}

function handleInputChanges(e) {
    const targetClassList = e.target.classList;
    if (targetClassList.contains('physical-stock-input') || targetClassList.contains('precomp-active-check')) {
        reverseCalculateStock();
    }
    if(targetClassList.contains('lot-quantity-input') || targetClassList.contains('final-inventory-input')){
        const productCode = e.target.dataset.productCode;
        updateFinalInventoryTotal(productCode);
    }
}

function handleClicks(e) {
    const target = e.target;
    if (target.classList.contains('add-deadstock-row-btn')) {
        const productCode = target.dataset.productCode;
        const master = findMaster(productCode);
        const tbody = document.querySelector(`.final-input-tbody[data-product-code="${productCode}"]`);
        if(master && tbody){
            const newRowHTML = createFinalInputRow(master, null, false);
            tbody.insertAdjacentHTML('beforeend', newRowHTML);
        }
    }
  
    if (target.classList.contains('delete-deadstock-row-btn')) {
        const topRow = target.closest('tr');
        const bottomRow = topRow.nextElementSibling;
        const productCode = bottomRow.querySelector('[data-product-code]')?.dataset.productCode;
        topRow.remove();
        bottomRow.remove();
        if(productCode) updateFinalInventoryTotal(productCode);
    }
    if (target.classList.contains('register-inventory-btn')) {
        saveInventoryData();
    }
}

function updatePrecompTotalDisplay() {
    let total = 0;
    document.querySelectorAll('.precomp-active-check:checked').forEach(cb => {
        total += parseFloat(cb.dataset.quantity) || 0;
    });
    const totalEl = document.getElementById('precomp-active-total');
    if (totalEl) {
        totalEl.textContent = `有効合計: ${total.toFixed(2)}`;
    }
}

function reverseCalculateStock() {
    const todayStr = getLocalDateString().replace(/-/g, '');
    const precompTotalsByProduct = {};
    const calculationErrorByProduct = {}; 

    document.querySelectorAll('.precomp-active-check:checked').forEach(cb => {
        const productCode = cb.dataset.productCode;
        const master = findMaster(productCode);
        if (!master) return;
        const yjQuantity = parseFloat(cb.dataset.quantity) || 0;

        if (master.janPackInnerQty > 0) {
            const janQuantity = yjQuantity / master.janPackInnerQty;
            precompTotalsByProduct[productCode] = (precompTotalsByProduct[productCode] || 0) + janQuantity;
        } else if (yjQuantity > 0) {
            calculationErrorByProduct[productCode] = '包装数量(内)未設定';
        }
    });
    updatePrecompTotalDisplay();

    const todayNetChangeByProduct = {};
    if (lastLoadedDataCache && lastLoadedDataCache.transactionLedger) {
        lastLoadedDataCache.transactionLedger.forEach(yjGroup => {
            if (yjGroup.packageLedgers) {
                yjGroup.packageLedgers.forEach(pkg => {
                    if (pkg.transactions) {
                        pkg.transactions.forEach(tx => {
                            if (tx.transactionDate === todayStr && tx.flag !== 0) {
                                let janQty = tx.janQuantity || 0;
                                if (janQty === 0 && tx.yjQuantity) {
                                    if (tx.janPackInnerQty > 0) {
                                        janQty = tx.yjQuantity / tx.janPackInnerQty;
                                    } else if (tx.yjQuantity > 0) {
                                        calculationErrorByProduct[tx.janCode] = '包装数量(内)未設定';
                                    }
                                }
                                const signedJanQty = janQty * (tx.flag === 1 || tx.flag === 11 || tx.flag === 4 ? 1 : -1);
                                todayNetChangeByProduct[tx.janCode] = (todayNetChangeByProduct[tx.janCode] || 0) + signedJanQty;
                            }
                        });
                    }
                });
            }
        });
    }

    document.querySelectorAll('.physical-stock-input').forEach(input => {
        const productCode = input.dataset.productCode;
        const displaySpan = document.querySelector(`.calculated-previous-day-stock[data-product-code="${productCode}"]`);
        const finalInput = document.querySelector(`.final-inventory-input[data-product-code="${productCode}"]`);

        if (calculationErrorByProduct[productCode]) {
            if (displaySpan) displaySpan.innerHTML = `<span style="color: red;">${calculationErrorByProduct[productCode]}</span>`;
            if (finalInput) finalInput.value = '';
            updateFinalInventoryTotal(productCode);
            return;
        }

        const physicalStockToday = parseFloat(input.value) || 0;
        const precompStock = precompTotalsByProduct[productCode] || 0;
        const netChangeToday = todayNetChangeByProduct[productCode] || 0;
        const totalStockToday = physicalStockToday + precompStock;
        const calculatedPreviousDayStock = totalStockToday - netChangeToday;
        
        if (displaySpan) displaySpan.textContent = calculatedPreviousDayStock.toFixed(2);
        if (finalInput) {
            finalInput.value = calculatedPreviousDayStock.toFixed(2);
            updateFinalInventoryTotal(productCode);
        }
    });
}

function updateFinalInventoryTotal(productCode) {
    const tbody = document.querySelector(`.final-input-tbody[data-product-code="${productCode}"]`);
    if (!tbody) return;
    let totalQuantity = 0;
    tbody.querySelectorAll('.final-inventory-input, .lot-quantity-input').forEach(input => {
        totalQuantity += parseFloat(input.value) || 0;
    });
}

function findMaster(productCode) {
    if (!lastLoadedDataCache || !lastLoadedDataCache.transactionLedger || lastLoadedDataCache.transactionLedger.length === 0) {
        return null;
    }
    for (const pkgLedger of lastLoadedDataCache.transactionLedger[0].packageLedgers) {
        const master = (pkgLedger.masters || []).find(m => m.productCode === productCode);
        if (master) {
            return master;
        }
    }
    return null;
}

async function saveInventoryData() {
    const dateInput = document.getElementById('inventory-date');
    if (!dateInput || !dateInput.value) {
        window.showNotification('棚卸日を指定してください。', 'error');
        return;
    }
    if (!confirm(`${dateInput.value}の棚卸データとして保存します。よろしいですか？`)) return;

    const inventoryData = {};
    const deadStockData = [];
    const allMasters = (lastLoadedDataCache.transactionLedger[0].packageLedgers || []).flatMap(pkg => pkg.masters || []);
    
    allMasters.forEach(master => {
        const productCode = master.productCode;
        const tbody = document.querySelector(`.final-input-tbody[data-product-code="${productCode}"]`);
        if (!tbody) {
            inventoryData[productCode] = 0;
            return;
        };
        let totalInputQuantity = 0;
        const inventoryRows = tbody.querySelectorAll('.inventory-row');
        for (let i = 0; i < inventoryRows.length; i += 2) {
            const topRow = inventoryRows[i];
            const bottomRow = inventoryRows[i+1];
            const quantityInput = bottomRow.querySelector('.final-inventory-input, .lot-quantity-input');
            const expiryInput = topRow.querySelector('.expiry-input');
            const lotInput = bottomRow.querySelector('.lot-input');
            if (!quantityInput || !expiryInput || !lotInput) continue;
        
            const quantity = parseFloat(quantityInput.value) || 0;
            const expiry = expiryInput.value.trim();
            const lot = lotInput.value.trim();
            totalInputQuantity += quantity;
            if (quantity > 0 && (expiry || lot)) {
                deadStockData.push({ 
                    productCode, 
                    yjCode: master.yjCode, packageForm: master.packageForm,
                    janPackInnerQty: master.janPackInnerQty, yjUnitName: master.yjUnitName,
                    stockQuantityJan: quantity, expiryDate: expiry, lotNumber: lot 
                });
            }
        }
        inventoryData[productCode] = totalInputQuantity;
    });
    
    const payload = {
        date: dateInput.value.replace(/-/g, ''),
        yjCode: currentYjCode,
        inventoryData: inventoryData,
        deadStockData: deadStockData,
    };
    
    window.showLoading();
    try {
        const res = await fetch('/api/inventory/adjust/save', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
        });
        const resData = await res.json();
        if (!res.ok) throw new Error(resData.message || '保存に失敗しました。');
        window.showNotification(resData.message, 'success');
        loadAndRenderDetails(currentYjCode);
    } catch (err) {
        window.showNotification(err.message, 'error');
    } finally {
        window.hideLoading();
    }
}

export async function initLogic() {
    let unitMap = {};
    try {
        const res = await fetch('/api/units/map');
        if (!res.ok) throw new Error('単位マスタの取得に失敗');
        unitMap = await res.json();
        setUnitMap(unitMap); // UIモジュールに単位マップを設定
    } catch (err) {
        console.error(err);
        window.showNotification(err.message, 'error');
    }

    view = document.getElementById('inventory-adjustment-view');
    if (!view) return;
    dosageFormFilter = document.getElementById('ia-dosageForm');
    kanaInitialFilter = document.getElementById('ia-kanaInitial');
    selectProductBtn = document.getElementById('ia-select-product-btn');
    deadStockOnlyFilter = document.getElementById('ia-dead-stock-only');
    outputContainer = document.getElementById('inventory-adjustment-output');
    
    barcodeInput = document.getElementById('ia-barcode-input');
    const barcodeForm = document.getElementById('ia-barcode-form');
    shelfNumberInput = document.getElementById('ia-shelf-number');

    if (barcodeForm) {
        barcodeForm.addEventListener('submit', handleBarcodeScan);
    }
    selectProductBtn.addEventListener('click', onSelectProductClick);
    outputContainer.addEventListener('input', handleInputChanges);
    outputContainer.addEventListener('click', handleClicks);
    outputContainer.addEventListener('submit', (e) => {
        if (e.target.id === 'adjustment-barcode-form') {
            handleAdjustmentBarcodeScan(e);
        }
    });
    view.addEventListener('loadInventoryAdjustment', (e) => {
        const { yjCode } = e.detail;
        if (yjCode) {
            dosageFormFilter.value = '';
            kanaInitialFilter.value = '';
            deadStockOnlyFilter.checked = false;
            shelfNumberInput.value = '';
            loadAndRenderDetails(yjCode);
        }
    });
}

----- C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\inventory_adjustment_ui.js -----
// C:/Users/wasab/OneDrive/デスクトップ/WASABI/static/js/inventory_adjustment_ui.js

import { transactionTypeMap } from './common_table.js';
import { wholesalerMap, clientMap } from './master_data.js';
import { getLocalDateString } from './utils.js';

// このファイル内で共有する変数
let unitMap = {};
let lastLoadedDataCache = null; // UI描画関数内でキャッシュを参照できるようにする

/**
 * 単位マップを外部から設定する
 * @param {object} map 
 */
export function setUnitMap(map) {
    unitMap = map;
}

/**
 * 標準的な取引履歴テーブルのHTMLを生成する
 * @param {string} id - テーブルのID
 * @param {Array} records - 表示するレコードの配列
 * @param {boolean} addCheckbox - 予製用のチェックボックスを追加するか
 * @param {string|null} customBody - tbodyの内容をカスタムHTMLで置き換える場合
 * @returns {string} - テーブル全体のHTML文字列
 */
function renderStandardTable(id, records, addCheckbox = false, customBody = null) {
    const header = `<thead>
        <tr><th rowspan="2">－</th><th>日付</th><th>YJ</th><th colspan="2">製品名</th><th>個数</th><th>YJ数量</th><th>YJ包装数</th><th>YJ単位</th><th>単価</th><th>税額</th><th>期限</th><th>得意先</th><th>行</th></tr>
        <tr><th>種別</th><th>JAN</th><th>包装</th><th>メーカー</th><th>剤型</th><th>JAN数量</th><th>JAN包装数</th><th>JAN単位</th><th>金額</th><th>税率</th><th>ロット</th><th>伝票番号</th><th>MA</th></tr></thead>`;
    let bodyHtml = customBody ? customBody : `<tbody>${(!records || records.length === 0) ?
 '<tr><td colspan="14">対象データがありません。</td></tr>' : records.map(rec => {
        let clientDisplayHtml = '';
        if (rec.flag === 1 || rec.flag === 2) {
            clientDisplayHtml = wholesalerMap.get(rec.clientCode) || rec.clientCode || '';
        } else {
            clientDisplayHtml = rec.clientCode || '';
        }

        const top = `<tr><td rowspan="2">${addCheckbox ? `<input type="checkbox" class="precomp-active-check" data-quantity="${rec.yjQuantity}" data-product-code="${rec.janCode}">` : ''}</td>
            <td>${rec.transactionDate || ''}</td><td class="yj-jan-code">${rec.yjCode || ''}</td><td class="left" colspan="2">${rec.productName || ''}</td>
            <td class="right">${rec.datQuantity?.toFixed(2) || ''}</td><td class="right">${rec.yjQuantity?.toFixed(2) || ''}</td><td class="right">${rec.yjPackUnitQty || ''}</td><td>${rec.yjUnitName || ''}</td>
            <td class="right">${rec.unitPrice?.toFixed(4) || ''}</td><td class="right">${rec.taxAmount?.toFixed(2) || ''}</td><td>${rec.expiryDate || ''}</td><td class="left">${clientDisplayHtml}</td><td class="right">${rec.lineNumber || ''}</td></tr>`;
        const bottom = `<tr><td>${transactionTypeMap[rec.flag] || rec.flag}</td><td class="yj-jan-code">${rec.janCode || ''}</td><td>${rec.packageSpec || ''}</td><td>${rec.makerName || ''}</td>
            <td>${rec.usageClassification || ''}</td><td class="right">${rec.janQuantity?.toFixed(2) || ''}</td><td class="right">${rec.janPackUnitQty || ''}</td><td>${rec.janUnitName || ''}</td>
            <td class="right">${rec.subtotal?.toFixed(2) || ''}</td><td class="right">${rec.taxRate != null ? (rec.taxRate * 100).toFixed(0) + "%" : ""}</td><td>${rec.lotNumber || ''}</td><td class="left">${rec.receiptNumber || ''}</td><td class="left">${rec.processFlagMA || ''}</td></tr>`;
    return top + bottom;
    }).join('')}</tbody>`;
    return `<table class="data-table" id="${id}">${header}${bodyHtml}</table>`;
}

/**
 * 「1. 全体サマリー」セクションのHTMLを生成する
 * @param {object} yjGroup - 製品グループデータ
 * @param {number} yesterdaysTotal - 前日在庫合計
 * @returns {string} HTML文字列
 */
function generateSummaryLedgerHtml(yjGroup, yesterdaysTotal) {
    const endDate = getLocalDateString();
    const startDate = new Date();
    startDate.setDate(startDate.getDate() - 30);
    const startDateStr = startDate.toISOString().slice(0, 10);

    let packageLedgerHtml = (yjGroup.packageLedgers || []).map(pkg => {
        const sortedTxs = (pkg.transactions || []).sort((a, b) => 
            (a.transactionDate + a.id).toString().localeCompare(b.transactionDate + b.id)
        );
        const pkgHeader = `
            <div class="agg-pkg-header" style="margin-top: 10px;">
                <span>包装: ${pkg.packageKey}</span>
                <span class="balance-info">
                    本日理論在庫(包装計): ${(pkg.endingBalance || 0).toFixed(2)} ${yjGroup.yjUnitName}
                </span>
            </div>
        `;
        const txTable = renderStandardTable(`ledger-table-${pkg.packageKey.replace(/[^a-zA-Z0-9]/g, '')}`, sortedTxs);
        return pkgHeader + txTable;
    }).join('');

    return `<div class="summary-section">
        <h3 class="view-subtitle">1. 全体サマリー</h3>
        <div class="report-section-header">
            <h4>在庫元帳 (期間: ${startDateStr} ～ ${endDate})</h4>
            <span class="header-total">【参考】前日理論在庫合計: ${yesterdaysTotal.toFixed(2)} ${yjGroup.yjUnitName}</span>
        </div>
        ${packageLedgerHtml}
    </div>`;
}

/**
 * 「予製払出明細」セクションのHTMLを生成する
 * @param {Array} precompDetails - 予製詳細データ
 * @returns {string} HTML文字列
 */
function generateSummaryPrecompHtml(precompDetails) {
    const precompTransactions = (precompDetails || []).map(p => ({
        transactionDate: (p.transactionDate || '').slice(0, 8),
        flag: '予製',
        clientCode: p.clientCode ? `患者: ${p.clientCode}` : '',
        receiptNumber: p.receiptNumber,
        yjQuantity: p.yjQuantity,
        yjUnitName: p.yjUnitName,
        janCode: p.janCode,
        productName: p.productName,
        yjCode: p.yjCode,
        packageSpec: p.packageSpec,
        makerName: p.makerName,
        usageClassification: p.usageClassification,
        janQuantity: p.janQuantity,
        janPackUnitQty: p.janPackUnitQty,
        janUnitName: p.janUnitName
    }));
    return `<div class="summary-section" style="margin-top: 15px;">
        <div class="report-section-header"><h4>予製払出明細 (全体)</h4>
        <span class="header-total" id="precomp-active-total">有効合計: 0.00</span></div>
        ${renderStandardTable('precomp-table', precompTransactions, true)}</div>`;
}

/**
 * 「2. 棚卸入力」セクションの入力行のHTMLを生成する
 * @param {object} master - 製品マスターデータ
 * @param {object|null} deadStockRecord - 既存のロット・期限情報
 * @param {boolean} isPrimary - 最初の行（目安転記欄）かどうか
 * @returns {string} HTML文字列
 */
export function createFinalInputRow(master, deadStockRecord = null, isPrimary = false) {
    const actionButtons = isPrimary ?
    `
        <button class="btn add-deadstock-row-btn" data-product-code="${master.productCode}">＋</button>
        <button class="btn register-inventory-btn">登録</button>
    ` : `<button class="btn delete-deadstock-row-btn">－</button>`;

    const quantityInputClass = isPrimary ? 'final-inventory-input' : 'lot-quantity-input';
    const quantityPlaceholder = isPrimary ? '目安をここに転記' : 'ロット数量';
    const quantity = deadStockRecord ? deadStockRecord.stockQuantityJan : '';
    const expiry = deadStockRecord ? deadStockRecord.expiryDate : '';
    const lot = deadStockRecord ? deadStockRecord.lotNumber : '';
    const topRow = `<tr class="inventory-row"><td rowspan="2"><div style="display: flex; flex-direction: column; gap: 4px;">${actionButtons}</div></td>
        <td>(棚卸日)</td><td class="yj-jan-code">${master.yjCode}</td><td class="left" colspan="2">${master.productName}</td>
        <td></td><td></td><td class="right">${master.yjPackUnitQty || ''}</td><td>${master.yjUnitName || ''}</td>
        <td></td><td></td><td><input type="text" class="expiry-input" placeholder="YYYYMM" value="${expiry}"></td><td></td><td></td></tr>`;
    const bottomRow = `<tr class="inventory-row"><td>棚卸</td><td class="yj-jan-code">${master.productCode}</td>
        <td>${master.formattedPackageSpec || ''}</td><td>${master.makerName || ''}</td><td>${master.usageClassification || ''}</td>
        <td><input type="number" class="${quantityInputClass}" data-product-code="${master.productCode}" placeholder="${quantityPlaceholder}" value="${quantity}"></td>
        <td class="right">${master.janPackUnitQty || ''}</td><td>${master.janUnitName || ''}</td>
        <td></td><td></td><td><input type="text" class="lot-input" placeholder="ロット番号" value="${lot}"></td><td></td><td></td></tr>`;
    return topRow + bottomRow;
}

/**
 * 「2. 棚卸入力」セクション全体のHTMLを生成する
 * @param {Array} packageLedgers - 包装台帳データの配列
 * @param {string} yjUnitName - YJ単位名
 * @param {object} cache - lastLoadedDataCache
 * @param {number} yesterdaysTotal - 前日の理論在庫合計
 * @returns {string} HTML文字列
 */
function generateInputSectionsHtml(packageLedgers, yjUnitName = '単位', cache, yesterdaysTotal) {
    const packageGroupsHtml = (packageLedgers || []).map(pkgLedger => {
        let yesterdaysPkgStock = 0;
        if(cache.yesterdaysStock && cache.yesterdaysStock.packageLedgers){
            const prevPkg = cache.yesterdaysStock.packageLedgers.find(p => p.packageKey === pkgLedger.packageKey);
            if(prevPkg) {
                yesterdaysPkgStock = prevPkg.endingBalance || 0;
            }
        }
        
        // ▼▼▼【ここから修正】▼▼▼
        let totalStockDisplay = `${(pkgLedger.endingBalance || 0).toFixed(2)} ${yjUnitName}`; // デフォルト表示
        let yesterdaysTotalStockDisplay = `${yesterdaysPkgStock.toFixed(2)} ${yjUnitName}`; // デフォルト表示

        if (pkgLedger.masters && pkgLedger.masters.length > 0) {
            const firstMaster = pkgLedger.masters[0];
            const janPackInnerQty = firstMaster.janPackInnerQty;

            const getJanUnitName = (master) => (master.janUnitCode === 0 || !unitMap[master.janUnitCode])
                ? master.yjUnitName
                : (unitMap[master.janUnitCode] || master.yjUnitName);

            const firstJanUnitName = getJanUnitName(firstMaster);
            const allSameJanUnit = pkgLedger.masters.every(m => getJanUnitName(m) === firstJanUnitName);

            if (allSameJanUnit && janPackInnerQty > 0) {
                const totalJanStock = (pkgLedger.endingBalance || 0) / janPackInnerQty;
                totalStockDisplay = `${totalJanStock.toFixed(2)} ${firstJanUnitName}`;
                
                const yesterdaysTotalJanStock = yesterdaysPkgStock / janPackInnerQty;
                yesterdaysTotalStockDisplay = `${yesterdaysTotalJanStock.toFixed(2)} ${firstJanUnitName}`;
            }
        }
        // ▲▲▲【修正ここまで】▲▲▲

        let html = `
        <div class="package-input-group" style="margin-bottom: 20px;">
            <div class="agg-pkg-header">
                <span>包装: ${pkgLedger.packageKey}</span>
            </div>`;
        html += (pkgLedger.masters || []).map(master => {
            if (!master) return '';
            
            const janUnitName = (master.janUnitCode === 0 || !unitMap[master.janUnitCode]) ? master.yjUnitName : (unitMap[master.janUnitCode] || master.yjUnitName);
            
            // ▼▼▼【ここから修正】表示に新しい変数を使用 ▼▼▼
            const userInputArea = `
            <div class="user-input-area" style="font-size: 14px; padding: 10px; background-color: #fffbdd;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="font-weight: bold; min-width: 250px;">① 本日の実在庫数量（予製除く）:</label>
                            <input type="number" class="physical-stock-input" data-product-code="${master.productCode}" step="any">
                            <span>(${janUnitName})</span>
                        </div>
                        <span style="font-size: 12px; color: #555;">本日理論在庫(包装計): ${totalStockDisplay}</span>
                    </div>
                    <div style="display: flex; align-items: center; gap: 8px; font-weight: bold; color: #dc3545; justify-content: space-between;">
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <label style="min-width: 250px;">② 前日在庫(逆算値):</label>
                            <span class="calculated-previous-day-stock" data-product-code="${master.productCode}">0.00</span>
                            <span>(${janUnitName})</span>
                            <span style="font-size: 11px; color: #555; margin-left: 10px;">(この数値が棚卸データとして登録されます)</span>
                        </div>
                        <span style="font-size: 12px; color: #555;">前日理論在庫(包装計): ${yesterdaysTotalStockDisplay}</span>
                    </div>
                </div>`;
            // ▲▲▲【修正ここまで】▲▲▲
            
            const relevantDeadStock = (cache.deadStockDetails || []).filter(ds => ds.productCode === master.productCode);
            let finalInputTbodyHtml;
            if (relevantDeadStock.length > 0) {
                finalInputTbodyHtml = relevantDeadStock.map((rec, index) => createFinalInputRow(master, rec, index === 0)).join('');
            } else {
                finalInputTbodyHtml = createFinalInputRow(master, null, true);
            }
            const finalInputTable = renderStandardTable(`final-table-${master.productCode}`, [], false, 
                `<tbody class="final-input-tbody" data-product-code="${master.productCode}">${finalInputTbodyHtml}</tbody>`);
            
            return `<div class="product-input-group" style="padding-left: 20px; margin-top: 10px;">
                        ${userInputArea}
                        <div style="margin-top: 10px;">
                            <p style="font-size: 12px; font-weight: bold; margin-bottom: 4px;">ロット・期限を個別入力</p>
                            ${finalInputTable}
                        </div>
                    </div>`;
        }).join('');

        html += `</div>`;
        return html;
    }).join('');
    
    return `<div class="input-section" style="margin-top: 30px;">
        <h3 class="view-subtitle">2. 棚卸入力</h3>
        <div class="inventory-input-area" style="padding: 10px; border: 1px solid #ccc; background-color: #f8f9fa; margin-bottom: 15px;">
            <div style="display: flex; gap: 20px; align-items: flex-end;">
                <div class="field-group">
                    <label for="inventory-date" style="font-weight: bold;">棚卸日:</label>
                    <input type="date" id="inventory-date">
                </div>
                <form id="adjustment-barcode-form" style="flex-grow: 1;">
                    <div class="field-group">
                        <label for="adjustment-barcode-input" style="font-weight: bold;">バーコードでロット・期限入力</label>
                        <input type="text" id="adjustment-barcode-input" inputmode="latin" placeholder="GS1-128バーコードをスキャンしてEnter" style="ime-mode: disabled; font-size: 1.1em;">
                    </div>
                </form>
            </div>
        </div>
        ${packageGroupsHtml}
    </div>`;
}

/**
 * 「3. 参考」セクションのHTMLを生成する
 * @param {Array} deadStockRecords - 既存のロット・期限情報
 * @param {object} cache - lastLoadedDataCache
 * @returns {string} HTML文字列
 */
function generateDeadStockReferenceHtml(deadStockRecords, cache) {
    if (!deadStockRecords || deadStockRecords.length === 0) {
        return '';
    }

    const getProductName = (productCode) => {
        if (!cache || !cache.transactionLedger) return productCode;
        for (const yjGroup of cache.transactionLedger) {
            for (const pkg of yjGroup.packageLedgers) {
                const master = (pkg.masters || []).find(m => m.productCode === productCode);
                if (master) return master.productName;
            }
        }
        return productCode;
    };

    const rowsHtml = deadStockRecords.map(rec => `
        <tr>
            <td class="left">${getProductName(rec.productCode)}</td>
            <td class="right">${rec.stockQuantityJan.toFixed(2)}</td>
            <td>${rec.expiryDate || ''}</td>
            <td class="left">${rec.lotNumber || ''}</td>
        </tr>
    `).join('');
    return `
        <div class="summary-section" style="margin-top: 30px;">
            <h3 class="view-subtitle">3. 参考：現在登録済みのロット・期限情報</h3>
            <p style="font-size: 11px; margin-bottom: 5px;">※このリストは参照用です。棚卸情報を保存するには、上の「2. 棚卸入力」の欄に改めて入力してください。</p>
            <table class="data-table">
                <thead>
                    <tr>
                        <th style="width: 40%;">製品名</th>
                        <th style="width: 15%;">在庫数量(JAN)</th>
                        <th style="width: 20%;">使用期限</th>
                        <th style="width: 25%;">ロット番号</th>
                    </tr>
                </thead>
                <tbody>
                    ${rowsHtml}
                </tbody>
            </table>
        </div>
    `;
}

/**
 * 棚卸調整画面の全HTMLを生成する
 * @param {object} data - サーバーから取得した全データ
 * @param {object} cache - 読み込み済みデータキャッシュ
 * @returns {string} HTML文字列
 */
export function generateFullHtml(data, cache) {
    lastLoadedDataCache = cache;
    if (!data.transactionLedger || data.transactionLedger.length === 0) {
        return '<p>対象の製品データが見つかりませんでした。</p>';
    }
    const yjGroup = data.transactionLedger[0];
    const productName = yjGroup.productName;
    const yesterdaysTotal = data.yesterdaysStock ? (data.yesterdaysStock.endingBalance || 0) : 0;
    const summaryLedgerHtml = generateSummaryLedgerHtml(yjGroup, yesterdaysTotal);
    const summaryPrecompHtml = generateSummaryPrecompHtml(data.precompDetails);
    const inputSectionsHtml = generateInputSectionsHtml(yjGroup.packageLedgers, yjGroup.yjUnitName, cache, yesterdaysTotal);
    const deadStockReferenceHtml = generateDeadStockReferenceHtml(data.deadStockDetails, cache);
    return `<h2 style="text-align: center; margin-bottom: 20px;">【棚卸調整】 ${productName} (YJ: ${yjGroup.yjCode})</h2>
        ${summaryLedgerHtml}
        ${summaryPrecompHtml}
        ${inputSectionsHtml}
        ${deadStockReferenceHtml}`;
}

----- C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\inventory_adjustment.js -----
// C:/Users/wasab/OneDrive/デスクトップ/WASABI/static/js/inventory_adjustment.js
import { initLogic } from './inventory_adjustment_logic.js';

export async function initInventoryAdjustment() {
    // ロジックファイルの初期化関数を呼び出す
    await initLogic();
}

----- C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\inventory_history.js -----
// C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\inventory_history.js (新規作成)
// ▼▼▼ [修正点] getLocalDateString をインポート ▼▼▼
import { getLocalDateString } from './utils.js';
// ▲▲▲ 修正ここまで ▲▲▲
let view, dateInput, showBtn, outputContainer;

/**
 * 棚卸履歴のテーブルを描画する
 * @param {Array} records - 表示する取引記録の配列
 */
function renderInventoryHistory(records) {
    if (!records || records.length === 0) {
        outputContainer.innerHTML = "<p>この日付の棚卸データはありません。</p>";
        return;
    }

    const tableHeader = `
        <thead>
            <tr>
                <th style="width: 30%;">製品名</th>
                <th style="width: 15%;">JANコード</th>
                <th style="width: 10%;">YJ数量</th>
                <th style="width: 10%;">YJ単位</th>
                <th style="width: 25%;">包装仕様</th>
                <th style="width: 10%;">操作</th>
            </tr>
        </thead>
    `;

    const tableBody = records.map(rec => `
        <tr data-id="${rec.id}">
            <td class="left">${rec.productName}</td>
            <td>${rec.janCode}</td>
            <td class="right">${rec.yjQuantity.toFixed(2)}</td>
            <td>${rec.yjUnitName}</td>
            <td class="left">${rec.packageSpec}</td>
            <td class="center"><button class="btn delete-inv-record-btn" data-id="${rec.id}">削除</button></td>
        </tr>
    `).join('');

    outputContainer.innerHTML = `<table class="data-table">${tableHeader}<tbody>${tableBody}</tbody></table>`;
}

/**
 * 削除ボタンが押されたときの処理
 * @param {number} transactionId - 削除する取引のID
 */
async function handleDelete(transactionId) {
    if (!confirm(`この棚卸レコードを完全に削除しますか？\nこの操作は元に戻せません。`)) {
        return;
    }

    window.showLoading();
    try {
        const res = await fetch(`/api/transaction/delete_by_id/${transactionId}`, {
            method: 'DELETE',
        });
        const resData = await res.json();
        if (!res.ok) {
            throw new Error(resData.message || '削除に失敗しました。');
        }
        
        // 画面から該当の行を削除
        const rowToRemove = outputContainer.querySelector(`tr[data-id="${transactionId}"]`);
        if (rowToRemove) {
            rowToRemove.remove();
        }

        window.showNotification(resData.message, 'success');
    } catch (err) {
        window.showNotification(err.message, 'error');
    } finally {
        window.hideLoading();
    }
}


export function initInventoryHistory() {
    view = document.getElementById('inventory-history-view');
    if (!view) return;

    dateInput = document.getElementById('history-inv-date');
    showBtn = document.getElementById('history-inv-show-btn');
    outputContainer = document.getElementById('inventory-history-output');

    // ▼▼▼ [修正点] 日付設定処理を新しい関数に置き換え ▼▼▼
    dateInput.value = getLocalDateString();
    // ▲▲▲ 修正ここまで ▲▲▲

    showBtn.addEventListener('click', async () => {
        const date = dateInput.value.replace(/-/g, '');
        if (!date) {
            window.showNotification('日付を選択してください。', 'error');
            return;
        }

        window.showLoading();
        try {
            const res = await fetch(`/api/inventory/by_date?date=${date}`);
            if (!res.ok) {
                const errText = await res.text();
                throw new Error(errText || '棚卸データの取得に失敗しました。');
            }
            const records = await res.json();
            renderInventoryHistory(records);
        } catch (err) {
            outputContainer.innerHTML = `<p style="color:red;">${err.message}</p>`;
        } finally {
            window.hideLoading();
        }
    });

    outputContainer.addEventListener('click', (e) => {
        if (e.target.classList.contains('delete-inv-record-btn')) {
            const transactionId = e.target.dataset.id;
            handleDelete(transactionId);
        }
    });
}

----- C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\inventory.js -----
import { createUploadTableHTML, renderUploadTableRows } from './common_table.js';

const fileInput = document.getElementById('inventoryFileInput');
const outputContainer = document.getElementById('inventory-output-container');

async function handleInventoryUpload(event) {
    const files = event.target.files;
    if (!files.length) return;

    // ▼▼▼【ここからが修正箇所です】▼▼▼

    // 先に処理中メッセージだけ表示する
    outputContainer.innerHTML = `<p>Processing...</p>`;
    window.showLoading();

    try {
        const formData = new FormData();
        for (const file of files) {
            formData.append('file', file);
        }

        const response = await fetch('/api/inventory/upload', {
            method: 'POST',
            body: formData,
        });
        
        const data = await response.json();
        if (!response.ok) {
            throw new Error(data.message || 'Inventory file processing failed.');
        }

        // --- 修正後の描画ロジック ---
        // 1. データを取得した後に、テーブルの枠と中身をそれぞれ文字列として生成
        const tableShell = createUploadTableHTML('inventory-output-table');
        // 棚卸画面のAPIレスポンスでは、データは 'details' キーに含まれるため data.details を使用 
        const tableBodyContent = renderUploadTableRows(data.details); 
        
        // 2. 文字列を結合して完全なHTMLを作成
        const fullTableHtml = tableShell.replace('<tbody></tbody>', `<tbody>${tableBodyContent}</tbody>`);

        // 3. 完成したHTMLを一度だけDOMに書き込む
        outputContainer.innerHTML = fullTableHtml;
        
        window.showNotification(data.message || 'Inventory file processed successfully.', 'success');

    } catch (err) {
        // エラー時も同様に、テーブルの枠を作ってからエラーメッセージを表示すると確実
        const tableShell = createUploadTableHTML('inventory-output-table');
        const errorRow = `<tr><td colspan="14" class="center" style="color:red;">Error: ${err.message}</td></tr>`;
        outputContainer.innerHTML = tableShell.replace('<tbody></tbody>', `<tbody>${errorRow}</tbody>`);
        
        window.showNotification(err.message, 'error');
    } finally {
        window.hideLoading();
        event.target.value = ''; // ファイル入力をリセット
    }
    // ▲▲▲【修正ここまで】▲▲▲
}

export function initInventoryUpload() {
    if (!fileInput) return;
    fileInput.addEventListener('change', handleInventoryUpload);
}

----- C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\jcshms_update.js -----
export function initJcshmsUpdate() {
    const reloadBtn = document.getElementById('reloadJcshmsBtn');
    if (!reloadBtn) return;

    reloadBtn.addEventListener('click', async () => {
        if (!confirm('SOUフォルダ内のJCSHMS.CSVとJANCODE.CSVをデータベースに再読み込みします。\nこれには数分かかることがあり、完了するまでアプリケーションは応答しなくなります。\nよろしいですか？')) {
            return;
        }
        window.showLoading();
        // ▼▼▼ [修正点] 結果表示用のコンテナを取得し、処理中メッセージを表示 ▼▼▼
        const resultContainer = document.getElementById('upload-output-container');
        const uploadView = document.getElementById('upload-view');
        const activeView = document.querySelector('main > div:not(.hidden)');
        
        if (uploadView && activeView) {
            activeView.classList.add('hidden');
            uploadView.classList.remove('hidden');
        }
        resultContainer.innerHTML = `<h3>JCSHMSマスター更新処理中...</h3><p>ブラウザを閉じないでください。</p>`;
        // ▲▲▲ 修正ここまで ▲▲▲

        try {
            const res = await fetch('/api/masters/reload_jcshms', { method: 'POST' });
            const resData = await res.json();
            if (!res.ok) {
                throw new Error(resData.message || '再読み込みに失敗しました。');
            }
            
            // ▼▼▼ [修正点] 結果表示ロジックを全面的に書き換え ▼▼▼
            let resultHTML = `<h3>${resData.message}</h3>`;

            if (resData.updatedProducts && resData.updatedProducts.length > 0) {
                resultHTML += `<p style="margin-top: 10px;">以下の${resData.updatedProducts.length}件が更新されました。</p>
                               <table class="data-table"><thead><tr><th>JAN</th><th>製品名</th></tr></thead><tbody>`;
                resData.updatedProducts.forEach(p => {
                    resultHTML += `<tr><td>${p.productCode}</td><td class="left">${p.productName}</td></tr>`;
                });
                resultHTML += `</tbody></table>`;
            }

            if (resData.orphanedProducts && resData.orphanedProducts.length > 0) {
                resultHTML += `<p style="margin-top: 10px;">以下の${resData.orphanedProducts.length}件がJCSHMSから削除されたため、手動管理に移行しました。</p>
                               <table class="data-table"><thead><tr><th>JAN</th><th>製品名</th></tr></thead><tbody>`;
                resData.orphanedProducts.forEach(p => {
                    resultHTML += `<tr><td>${p.productCode}</td><td class="left">${p.productName}</td></tr>`;
                });
                resultHTML += `</tbody></table>`;
            }

            resultContainer.innerHTML = resultHTML;
            window.showNotification(resData.message, 'success');
            // ▲▲▲ 修正ここまで ▲▲▲
        } catch (err) {
            console.error(err);
            resultContainer.innerHTML = `<p style="color:red;">エラー: ${err.message}</p>`; // エラーもコンテナに表示
            window.showNotification(`エラー: ${err.message}`, 'error');
        } finally {
            window.hideLoading();
        }
    });
}

----- C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\ledger.js -----
// C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\ledger.js

import { showModal } from './inout_modal.js';
import { hiraganaToKatakana } from './utils.js';
import { wholesalerMap, clientMap } from './master_data.js';
import { transactionTypeMap } from './common_table.js';

let view, selectProductBtn, outputContainer, selectedProductDisplay, printBtn, shelfNumberInput;
let lastLoadedData = null; 

/**
 * トランザクションレコードから符号付きのYJ数量を計算するヘルパー関数
 * @param {object} record - TransactionRecordオブジェクト
 * @returns {number} - 符号付きのYJ数量
 */
function getSignedYjQty(record) {
    const flag = record.flag;
    const qty = record.yjQuantity || 0;
    switch (flag) {
        case 1: case 4: case 11: // 入庫系
            return qty;
        case 2: case 3: case 5: case 12: // 出庫系
            return -qty;
        default: // 棚卸など
            return 0;
    }
}

/**
 * 最新の棚卸を基点に、在庫を再計算し、日付昇順のリストを返す
 * @param {Array} transactions - サーバーから受け取った昇順の取引リスト
 * @returns {Array} - 在庫を再計算した、昇順の取引リスト
 */
function recalculateBalancesFromLatestInventory(transactions) {
    if (!transactions || transactions.length === 0) {
        return [];
    }

    let recalculatedTxs = JSON.parse(JSON.stringify(transactions));

    let latestInventoryIndex = -1;
    for (let i = recalculatedTxs.length - 1; i >= 0; i--) {
        if (recalculatedTxs[i].flag === 0) {
            latestInventoryIndex = i;
            break;
        }
    }

    if (latestInventoryIndex !== -1) {
        recalculatedTxs[latestInventoryIndex].runningBalance = recalculatedTxs[latestInventoryIndex].yjQuantity;

        for (let i = latestInventoryIndex + 1; i < recalculatedTxs.length; i++) {
            recalculatedTxs[i].runningBalance = recalculatedTxs[i - 1].runningBalance + getSignedYjQty(recalculatedTxs[i]);
        }

        for (let i = latestInventoryIndex - 1; i >= 0; i--) {
            recalculatedTxs[i].runningBalance = recalculatedTxs[i + 1].runningBalance - getSignedYjQty(recalculatedTxs[i + 1]);
        }

    } else {
        if (recalculatedTxs.length > 0) {
            for (let i = recalculatedTxs.length - 2; i >= 0; i--) {
                recalculatedTxs[i].runningBalance = recalculatedTxs[i + 1].runningBalance - getSignedYjQty(recalculatedTxs[i + 1]);
            }
        }
    }

    return recalculatedTxs;
}

/**
 * 予製情報テーブルを含む、台帳ビュー全体のHTMLを生成して描画する
 */
function renderLedgerView() {
    if (!lastLoadedData) {
        outputContainer.innerHTML = "<p>データがありません。</p>";
        return;
    }

    const ascendingTransactions = recalculateBalancesFromLatestInventory(lastLoadedData.ledgerTransactions);

    const ledgerHtml = renderLedgerTable(ascendingTransactions);
    const precompHtml = renderPrecompDetails(lastLoadedData.precompDetails);
    
    const finalTheoreticalStock = ascendingTransactions.length > 0
        ? ascendingTransactions[ascendingTransactions.length - 1].runningBalance
        : 0;

    const summaryHtml = `
        <div style="text-align: right; margin-top: 20px; padding-top: 10px; border-top: 2px solid #333; font-weight: bold;">
            <span>最終理論在庫: <span id="final-theoretical-stock">${finalTheoreticalStock.toFixed(2)}</span></span> | 
            <span>チェック済み予製合計: <span id="total-precomp-stock">0.00</span></span> | 
            <span style="color: blue;">最終実在庫: <span id="final-real-stock">${finalTheoreticalStock.toFixed(2)}</span></span>
        </div>
    `;

    outputContainer.innerHTML = ledgerHtml + precompHtml + summaryHtml;
    updateRealStock();
}

/**
 * 台帳テーブルのHTMLを生成する
 * @param {Array} records - 表示する台帳データの配列 (LedgerTransaction)
 */
function renderLedgerTable(records) {
    if (!records || records.length === 0) {
        return "<h4>取引履歴 (過去30日)</h4><p>対象期間の取引データがありませんでした。</p>";
    }

    const tableHeader = `
        <thead>
            <tr>
                <th>日付</th>
                <th>種別</th>
                <th>入庫 (YJ)</th>
                <th>出庫 (YJ)</th>
                <th>在庫(理論)</th>
                <th style="color: blue;">在庫(実)</th>
                <th>卸/患者</th>
                <th>ロット</th>
                <th>期限</th>
            </tr>
        </thead>
    `;

    const tableBody = records.map(rec => {
        const signedQty = getSignedYjQty(rec);
        const receipt = signedQty > 0 ? signedQty.toFixed(2) : '';
        const dispense = signedQty < 0 ? (-signedQty).toFixed(2) : '';
        
        let partyName = '';
        if (rec.flag === 1 || rec.flag === 2) {
             partyName = wholesalerMap.get(rec.clientCode) || rec.clientCode || '';
        } else if (rec.flag === 3 || rec.flag === 5) {
             partyName = clientMap.get(rec.clientCode) || rec.clientCode || '';
        }

        return `
        <tr class="ledger-row" data-theoretical-stock="${rec.runningBalance}">
            <td>${rec.transactionDate || ''}</td>
            <td>${transactionTypeMap[rec.flag] || ''}</td>
            <td class="right">${receipt}</td>
            <td class="right">${dispense}</td>
            <td class="right">${(rec.runningBalance ?? 0).toFixed(2)}</td>
            <td class="right real-stock-cell" style="font-weight: bold; color: blue;">${(rec.runningBalance ?? 0).toFixed(2)}</td>
            <td class="left">${partyName}</td>
            <td class="left">${rec.lotNumber || ''}</td>
            <td>${rec.expiryDate || ''}</td>
        </tr>
    `}).join('');

    return `<h3 class="view-subtitle">取引履歴 (過去30日)</h3><table class="data-table">${tableHeader}<tbody>${tableBody}</tbody></table>`;
}

/**
 * 予製情報テーブルのHTMLを生成する
 * @param {Array} records - 表示する予製データの配列 (TransactionRecord)
 */
function renderPrecompDetails(records) {
    if (!records || records.length === 0) {
        return '<div style="margin-top: 20px;"><h3 class="view-subtitle">関連する予製情報</h3><p>この製品に紐づく予製情報はありません。</p></div>';
    }

    const tableHeader = `
        <thead>
            <tr>
                <th style="width: 5%;"><input type="checkbox" class="precomp-check-all" checked></th>
                <th style="width: 25%;">患者番号</th>
                <th style="width: 40%;">製品名</th>
                <th style="width: 15%;">予製数量 (YJ)</th>
                <th style="width: 15%;">包装</th>
            </tr>
        </thead>
    `;
    const tableBody = records.map(rec => `
        <tr>
            <td class="center"><input type="checkbox" class="precomp-check" data-quantity="${rec.yjQuantity}" checked></td>
            <td class="left">${clientMap.get(rec.clientCode) || rec.clientCode}</td>
            <td class="left">${rec.productName}</td>
            <td class="right">${rec.yjQuantity.toFixed(2)}</td>
            <td class="left">${rec.packageSpec}</td>
        </tr>
    `).join('');

    return `<div style="margin-top: 20px;">
                <h3 class="view-subtitle">関連する予製情報</h3>
                <p style="font-size: 11px; margin-bottom: 5px;">チェックを入れた予製は実在庫から引かれます。</p>
                <table class="data-table">${tableHeader}<tbody>${tableBody}</tbody></table>
            </div>`;
}

/**
 * 予製チェックボックスの変更に応じて実在庫を再計算・描画する
 */
function updateRealStock() {
    let precompTotal = 0;
    outputContainer.querySelectorAll('.precomp-check:checked').forEach(checkbox => {
        precompTotal += parseFloat(checkbox.dataset.quantity || 0);
    });

    const totalPrecompEl = document.getElementById('total-precomp-stock');
    if (totalPrecompEl) totalPrecompEl.textContent = precompTotal.toFixed(2);

    const ledgerRows = outputContainer.querySelectorAll('tr.ledger-row');
    ledgerRows.forEach(row => {
        const theoreticalStock = parseFloat(row.dataset.theoreticalStock);
        const realStock = theoreticalStock - precompTotal;
        row.querySelector('.real-stock-cell').textContent = realStock.toFixed(2);
    });

    const finalRealStockEl = document.getElementById('final-real-stock');
    if (finalRealStockEl) {
        const finalTheoreticalStockEl = document.getElementById('final-theoretical-stock');
        const finalTheoreticalStock = finalTheoreticalStockEl ? parseFloat(finalTheoreticalStockEl.textContent) : 0;
        finalRealStockEl.textContent = (finalTheoreticalStock - precompTotal).toFixed(2);
    }
}


/**
 * 指定された製品コードの台帳データをサーバーから取得して描画する
 * @param {string} productCode - 対象の製品JANコード
 */
async function loadLedgerForProduct(productCode) {
    outputContainer.innerHTML = '<p>台帳データを読み込み中...</p>';
    window.showLoading();
    try {
        const res = await fetch(`/api/ledger/product/${productCode}`);
        if (!res.ok) {
            const errText = await res.text();
            throw new Error(errText || '台帳データの取得に失敗しました。');
        }
        lastLoadedData = await res.json();
        
        renderLedgerView();

    } catch (err) {
        outputContainer.innerHTML = `<p style="color:red;">${err.message}</p>`;
    } finally {
        window.hideLoading();
    }
}

/**
 * 「品目を選択...」ボタンがクリックされたときの処理
 */
async function onSelectProductClick() {
    const drugTypeCheckboxes = document.querySelectorAll('input[name="ledgerDrugType"]:checked');
    const selectedDrugTypes = Array.from(drugTypeCheckboxes).map(cb => cb.value).join(',');
    const shelfNumber = shelfNumberInput.value.trim();

    const params = new URLSearchParams({
        deadStockOnly: false,
        drugTypes: selectedDrugTypes,
        shelfNumber: shelfNumber,
    });
    const apiUrl = `/api/products/search_filtered?${params.toString()}`;
    const shouldSkipQueryLengthCheck = !!(selectedDrugTypes || shelfNumber);

    window.showLoading();
    try {
        const res = await fetch(apiUrl);
        if (!res.ok) throw new Error('品目リストの取得に失敗しました。');
        const products = await res.json();
        window.hideLoading();
        
        showModal(view, (selectedProduct) => {
            selectedProductDisplay.textContent = `${selectedProduct.productName} (${selectedProduct.yjCode})`;
            loadLedgerForProduct(selectedProduct.productCode);
        }, { 
            initialResults: products, 
            searchApi: apiUrl,
            skipQueryLengthCheck: shouldSkipQueryLengthCheck
        });
    } catch (err) {
        window.hideLoading();
        window.showNotification(err.message, 'error');
    }
}


/**
 * 管理台帳ビューの初期化
 */
export function initLedgerView() {
    view = document.getElementById('ledger-view');
    if (!view) return;

    selectProductBtn = document.getElementById('ledger-select-product-btn');
    outputContainer = document.getElementById('ledger-output-container');
    selectedProductDisplay = document.getElementById('ledger-selected-product');
    printBtn = document.getElementById('print-ledger-btn');
    shelfNumberInput = document.getElementById('ledger-shelf-number');

    selectProductBtn.addEventListener('click', onSelectProductClick);
    
    printBtn.addEventListener('click', () => {
        if (outputContainer.querySelector('table')) {
            view.classList.add('print-this-view');
            window.print();
        } else {
            window.showNotification('印刷するデータがありません。', 'error');
        }
    });
    
    window.addEventListener('afterprint', () => {
        view.classList.remove('print-this-view');
    });

    outputContainer.addEventListener('change', (e) => {
        if (e.target.classList.contains('precomp-check')) {
            updateRealStock();
        } else if (e.target.classList.contains('precomp-check-all')) {
            const isChecked = e.target.checked;
            outputContainer.querySelectorAll('.precomp-check').forEach(chk => chk.checked = isChecked);
            updateRealStock();
        }
    });
}

----- C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\manual_inventory.js -----
// C:\Dev\WASABI\static\js\manual_inventory.js

// ▼▼▼ [修正点] getLocalDateString をインポート ▼▼▼
import { hiraganaToKatakana, getLocalDateString } from './utils.js';
// ▲▲▲ 修正ここまで ▲▲▲

export function initManualInventory() {
    const view = document.getElementById('manual-inventory-view');
    if (!view) return;
    const dateInput = document.getElementById('manual-inv-date');
    const saveBtn = document.getElementById('save-manual-inv-btn');
    const container = document.getElementById('manual-inventory-container');
    const kanaNameInput = document.getElementById('manual-inv-kanaName');
    const dosageFormInput = document.getElementById('manual-inv-dosageForm');
    let allProducts = [];

    // ▼▼▼ [修正点] 日付を自動設定する関数を追加 ▼▼▼
    async function setDefaultDate() {
        // ▼▼▼ [修正点] 日付設定処理を新しい関数に置き換え ▼▼▼
        dateInput.value = getLocalDateString();
        // ▲▲▲ 修正ここまで ▲▲▲
    }
    // ▲▲▲ 修正ここまで ▲▲▲

    async function loadProducts() {
        container.innerHTML = '<p>製品マスターと理論在庫を読み込んでいます...</p>';
        window.showLoading();
        try {
            // ▼▼▼ [修正点] 製品リスト取得APIには最終棚卸日が含まれるようになった ▼▼▼
            const [mastersRes, stockRes] = await Promise.all([
                fetch('/api/inventory/list'),
                fetch('/api/stock/all_current')
            ]);
            // ▲▲▲ 修正ここまで ▲▲▲
            if (!mastersRes.ok) throw new Error('製品リストの取得に失敗しました。');
            if (!stockRes.ok) throw new Error('理論在庫の取得に失敗しました。');

            allProducts = await mastersRes.json();
            const stockMap = await stockRes.json();
            if(!allProducts) allProducts = [];

            allProducts.forEach(p => {
                p.currentStock = stockMap[p.productCode] || 0;
            });
            
            applyFiltersAndRender();
        } catch (err) {
            container.innerHTML = `<p style="color:red;">${err.message}</p>`;
        } finally {
            window.hideLoading();
        }
    }
    
function applyFiltersAndRender() {
    const kanaFilter = hiraganaToKatakana(kanaNameInput.value).toLowerCase();
    const dosageFilter = dosageFormInput.value; // toLowerCase()を削除
    
    let filteredProducts = allProducts;
    if (kanaFilter) {
        filteredProducts = filteredProducts.filter(p => 
            p.productName.toLowerCase().includes(kanaFilter) || p.kanaName.toLowerCase().includes(kanaFilter)
        );
    }
    
    // ▼▼▼ [修正点] プルダウンに合わせた絞り込みロジックに変更 ▼▼▼
    if (dosageFilter) {
        filteredProducts = filteredProducts.filter(p => 
            p.usageClassification && p.usageClassification.trim() === dosageFilter
        );
    }
    // ▲▲▲ 修正ここまで ▲▲▲
    
    renderProducts(filteredProducts);
}

    function renderProducts(productsToRender) {
        if (productsToRender.length === 0) {
            container.innerHTML = '<p>表示する製品マスターがありません。</p>';
            return;
        }

        const groups = productsToRender.reduce((acc, p) => {
            const key = p.yjCode || 'YJコードなし';
            if (!acc[key]) {
                acc[key] = {
                    productName: p.productName,
                    yjCode: p.yjCode,
                    packages: []
                };
            }
            acc[key].packages.push(p);
            return acc;
        }, {});
        
        Object.values(groups).forEach(group => {
            group.packages = group.packages.reduce((acc, p) => {
                 const key = `${p.packageForm}|${p.janPackInnerQty}|${p.yjUnitName}`;
                 if (!acc[key]) {
                     acc[key] = {
                         packageKey: key,
                         masters: []
                     };
                 }
                 acc[key].masters.push(p);
                 return acc;
            }, {});
        });
        
        let html = '';
        for (const group of Object.values(groups)) {
            html += `<div class="agg-yj-header"><span>YJ: ${group.yjCode}</span><span class="product-name">${group.productName}</span></div>`;
            for (const pkg of Object.values(group.packages)) {
                const firstMaster = pkg.masters[0];
                const productCodes = pkg.masters.map(m => m.productCode).join(',');
                const theoreticalStockForPackage = pkg.masters.reduce((sum, master) => sum + (master.currentStock || 0), 0);

                // ▼▼▼ [修正点] 最終棚卸日を表示するロジックを追加 ▼▼▼
                let lastInvDateStr = '';
                if (firstMaster.lastInventoryDate) {
                    const d = firstMaster.lastInventoryDate; // YYYYMMDD
                    lastInvDateStr = ` (最終棚卸: ${d.slice(0,4)}-${d.slice(4,6)}-${d.slice(6,8)})`;
                }

                html += `
                    <div class="agg-pkg-header" style="display:flex; align-items:center; gap: 10px;">
                        <span>包装: ${pkg.packageKey}</span>
                        <div style="margin-left:auto; display:flex; align-items: center; gap: 10px;">
                            <span style="font-size: 12px; color: #333;">理論在庫: ${theoreticalStockForPackage.toFixed(2)}${lastInvDateStr}</span>
                            <label for="inv-qty-${firstMaster.productCode}" style="font-weight: bold;">実在庫数:</label>
                            <input type="number" step="any" class="manual-inv-qty" data-product-codes="${productCodes}" id="inv-qty-${firstMaster.productCode}" style="width: 100px;">
                            <span>${firstMaster.yjUnitName || ''}</span>
                        </div>
                    </div>
                `;
                // ▲▲▲ 修正ここまで ▲▲▲
            }
        }
        container.innerHTML = html;
    }
    
    view.addEventListener('show', () => {
        setDefaultDate();
        loadProducts();
    });

    // ▼▼▼ [修正点] フィルター入力時のイベントリスナーを追加 ▼▼▼
    kanaNameInput.addEventListener('input', applyFiltersAndRender);
    dosageFormInput.addEventListener('input', applyFiltersAndRender);
    // ▲▲▲ 修正ここまで ▲▲▲
    
    saveBtn.addEventListener('click', async () => {
        const date = dateInput.value.replace(/-/g, '');
        if (!date) {
            window.showNotification('棚卸日を指定してください。', 'error');
            return;
        }
        if (!confirm(`${dateInput.value} の棚卸データとして保存します。よろしいですか？`)) {
            return;
        }

        const records = [];
        container.querySelectorAll('.manual-inv-qty').forEach(input => {
            if (input.value !== '') { 
                const quantity = parseFloat(input.value);
                if (!isNaN(quantity)) {
                    const productCode = input.dataset.productCodes.split(',')[0];
                    records.push({
                        productCode: productCode,
                        yjQuantity: quantity
                    });
                }
            }
        });

        window.showLoading();
        try {
            const res = await fetch('/api/inventory/save_manual', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ date, records }),
            });
            const resData = await res.json();
            if (!res.ok) throw new Error(resData.message || '保存に失敗しました。');
            window.showNotification(resData.message, 'success');
            loadProducts();
        } catch (err) {
            window.showNotification(err.message, 'error');
        } finally {
            window.hideLoading();
        }
    });
}

----- C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\master_data.js -----
// C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\master_data.js

export const clientMap = new Map();
export const wholesalerMap = new Map();

async function fetchAndPopulateClients() {
	const res = await fetch('/api/clients');
	if (!res.ok) {
		throw new Error('得意先マスターの取得に失敗しました。');
	}
	const clients = await res.json();
	clientMap.clear();
	if (clients) {
		clients.forEach(c => clientMap.set(c.code, c.name));
	}
}

export async function refreshClientMap() {
	try {
		await fetchAndPopulateClients();
		console.log('得意先マップを更新しました。');
	} catch (error) {
		console.error("得意先マップの更新に失敗しました:", error);
		window.showNotification('得意先リストの更新に失敗しました。', 'error');
	}
}

// ▼▼▼【ここから修正】▼▼▼
async function fetchAndPopulateWholesalers() {
	const res = await fetch('/api/settings/wholesalers');
	if (!res.ok) {
		throw new Error('卸業者マスターの読み込みに失敗しました。');
	}
	const wholesalers = await res.json();
	wholesalerMap.clear();
	if (wholesalers) {
		wholesalers.forEach(w => wholesalerMap.set(w.code, w.name));
	}
}

export async function refreshWholesalerMap() {
    try {
        await fetchAndPopulateWholesalers();
        console.log('卸業者マップを更新しました。');
    } catch (error) {
        console.error("卸業者マップの更新に失敗しました:", error);
        window.showNotification('卸業者リストの更新に失敗しました。', 'error');
    }
}

export async function loadMasterData() {
	try {
		await Promise.all([
			fetchAndPopulateClients(),
			fetchAndPopulateWholesalers()
		]);
		console.log('得意先と卸業者のマスターデータを読み込みました。');
	} catch (error) {
		console.error("マスターデータの読み込み中にエラーが発生しました:", error);
		window.showNotification('マスターデータの読み込みに失敗しました。', 'error');
	}
}
// ▲▲▲【修正ここまで】▲▲▲

----- C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\master_edit_logic.js -----
// C:/Users/wasab/OneDrive/デスクトップ/WASABI/static/js/master_edit_logic.js

import { showModal } from './inout_modal.js';
import { hiraganaToKatakana } from './utils.js';
import { renderMasters, updateShelfScannedList, createMasterRowHTML, formatPackageSpecForRow } from './master_edit_ui.js';

let view, tableContainer, refreshBtn, addRowBtn, kanaNameInput, dosageFormInput, shelfNumberInput;
let allMasters = [];
let shelfModal, closeShelfModalBtn, bulkShelfNumberBtn;
let shelfBarcodeForm, shelfBarcodeInput, shelfScannedList, shelfScannedCount;
let shelfNumberInputForBulk, shelfRegisterBtn, shelfClearBtn;
let shelfScanPool = [];

function applyFiltersAndRender() {
    const kanaFilter = hiraganaToKatakana(kanaNameInput.value).toLowerCase();
    const dosageFilter = dosageFormInput.value;
    const shelfFilter = shelfNumberInput ? shelfNumberInput.value.trim().toLowerCase() : '';
    let filteredMasters = allMasters;

    if (kanaFilter) {
        filteredMasters = filteredMasters.filter(p => 
            (p.productCode && p.productCode.toLowerCase().includes(kanaFilter)) ||
            (p.productName && p.productName.toLowerCase().includes(kanaFilter)) || 
            (p.kanaName && p.kanaName.toLowerCase().includes(kanaFilter))
        );
    }
    
    if (dosageFilter) {
        filteredMasters = filteredMasters.filter(p => 
            p.usageClassification && p.usageClassification.trim() === dosageFilter
        );
    }

    if (shelfFilter) {
        filteredMasters = filteredMasters.filter(p =>
            p.shelfNumber && p.shelfNumber.toLowerCase().includes(shelfFilter)
        );
    }
    
    renderMasters(filteredMasters, tableContainer);
}

async function loadAndRenderMasters() {
    tableContainer.innerHTML = `<p>読み込み中...</p>`;
    window.showLoading();
    try {
        const res = await fetch('/api/masters/editable');
        if (!res.ok) throw new Error('マスターの読み込みに失敗しました。');
        allMasters = await res.json();
        applyFiltersAndRender();
    } catch (err) {
        tableContainer.innerHTML = `<p style="color:red;">${err.message}</p>`;
    } finally {
        window.hideLoading();
    }
}

function populateFormWithJcshms(selectedProduct, tbody) {
    if (!tbody) return;
    const setVal = (name, value) => {
        const el = tbody.querySelector(`[name="${name}"]`);
        if (el) el.value = value !== undefined ? value : '';
    };
    const productCodeInput = tbody.querySelector('[name="productCode"]');
    if (productCodeInput && !productCodeInput.readOnly) {
        productCodeInput.value = selectedProduct.productCode || '';
    }
    setVal('yjCode', selectedProduct.yjCode); setVal('productName', selectedProduct.productName);
    setVal('kanaName', selectedProduct.kanaName); setVal('makerName', selectedProduct.makerName);
    setVal('usageClassification', selectedProduct.usageClassification); setVal('packageForm', selectedProduct.packageForm);
    setVal('nhiPrice', selectedProduct.nhiPrice); setVal('flagPoison', selectedProduct.flagPoison);
    setVal('flagDeleterious', selectedProduct.flagDeleterious); setVal('flagNarcotic', selectedProduct.flagNarcotic);
    setVal('flagPsychotropic', selectedProduct.flagPsychotropic); setVal('flagStimulant', selectedProduct.flagStimulant);
    setVal('flagStimulantRaw', selectedProduct.flagStimulantRaw); setVal('yjUnitName', selectedProduct.yjUnitName);
    setVal('yjPackUnitQty', selectedProduct.yjPackUnitQty);
    setVal('janPackInnerQty', selectedProduct.janPackInnerQty);
    setVal('janUnitCode', selectedProduct.janUnitCode); setVal('janPackUnitQty', selectedProduct.janPackUnitQty);
	setVal('specification', selectedProduct.specification);
	setVal('gs1Code', selectedProduct.gs1Code);
    formatPackageSpecForRow(tbody);
}

async function resolveProductNameForShelfScan(gs1) {
    try {
        const res = await fetch(`/api/product/by_gs1?gs1_code=${gs1}`);
        if (res.ok) {
            const product = await res.json();
            const poolItem = shelfScanPool.find(item => item.gs1 === gs1);
            if (poolItem) {
                poolItem.name = product.productName;
                updateShelfScannedList(shelfScannedList, shelfScannedCount, shelfScanPool);
            }
        } else if (res.status === 404) {
            if (confirm(`このGS1コード[${gs1}]はマスターに登録されていません。\n新規に仮マスターを作成しますか？`)) {
                const newMaster = await createProvisionalMasterForShelf(gs1);
                const poolItem = shelfScanPool.find(item => item.gs1 === gs1);
                 if (poolItem) {
                    poolItem.name = newMaster.productName;
                    updateShelfScannedList(shelfScannedList, shelfScannedCount, shelfScanPool);
                }
            }
        }
    } catch (err) {
        console.warn(`品目名の解決に失敗: ${gs1}`, err);
        window.showNotification(`品目名の解決に失敗しました: ${gs1}`, 'error');
    }
}

async function createProvisionalMasterForShelf(gs1) {
    window.showLoading('新規マスターを作成中...');
    try {
        const productCode = gs1.length === 14 ? gs1.substring(1) : gs1;

        const res = await fetch('/api/master/create_provisional', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ gs1Code: gs1, productCode: productCode }),
        });
        const resData = await res.json();
        if (!res.ok) {
            throw new Error(resData.message || 'マスターの作成に失敗しました。');
        }
        window.showNotification(`新規マスターを作成しました (YJ: ${resData.yjCode})`, 'success');

        const fetchRes = await fetch(`/api/product/by_gs1?gs1_code=${gs1}`);
        if (!fetchRes.ok) {
            throw new Error('作成したマスター情報の取得に失敗しました。');
        }
        return await fetchRes.json();
    } catch (err) {
        window.showNotification(err.message, 'error');
        throw err;
    } finally {
        window.hideLoading();
    }
}

async function handleShelfRegister() {
    const shelfNumber = shelfNumberInputForBulk.value.trim();
    if (!shelfNumber) {
        window.showNotification('棚番を入力してください。', 'error');
        return;
    }
    if (shelfScanPool.length === 0) {
        window.showNotification('登録する品目がスキャンされていません。', 'error');
        return;
    }

    const gs1Codes = shelfScanPool.map(item => item.gs1);

    if (!confirm(`スキャンした ${gs1Codes.length} 件の品目の棚番を「${shelfNumber}」として一括登録します。\nよろしいですか？`)) {
        return;
    }

    window.showLoading('棚番を一括更新中...');
    try {
        const payload = {
            shelfNumber: shelfNumber,
            gs1Codes: gs1Codes
        };
        const res = await fetch('/api/masters/bulk_update_shelf_numbers', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        if (!res.ok) {
            const errorText = await res.text();
            let errorMessage = '棚番の更新に失敗しました。';
            try {
                const errorJson = JSON.parse(errorText);
                errorMessage = errorJson.message || errorMessage;
            } catch (e) {
                errorMessage = errorText || errorMessage;
            }
            throw new Error(errorMessage);
        }

        const resData = await res.json();
        window.showNotification(resData.message, 'success');
        
        shelfScanPool = [];
        updateShelfScannedList(shelfScannedList, shelfScannedCount, shelfScanPool);
        shelfNumberInputForBulk.value = '';
        shelfBarcodeInput.focus();

        loadAndRenderMasters();

    } catch (err) {
        window.showNotification(`エラー: ${err.message}`, 'error');
    } finally {
        window.hideLoading();
    }
}

export function initLogic() {
    view = document.getElementById('master-edit-view');
    if (!view) return;
    tableContainer = document.getElementById('master-edit-container');
    refreshBtn = document.getElementById('refreshMastersBtn');
    addRowBtn = document.getElementById('addMasterRowBtn');
    kanaNameInput = document.getElementById('master-edit-kanaName');
    dosageFormInput = document.getElementById('master-edit-dosageForm');
    shelfNumberInput = document.getElementById('master-edit-shelfNumber');

    shelfModal = document.getElementById('bulk-shelf-number-modal');
    closeShelfModalBtn = document.getElementById('close-shelf-modal-btn');
    bulkShelfNumberBtn = document.getElementById('bulkShelfNumberBtn');
    shelfBarcodeForm = document.getElementById('shelf-barcode-form');
    shelfBarcodeInput = document.getElementById('shelf-barcode-input');
    shelfScannedList = document.getElementById('shelf-scanned-list');
    shelfScannedCount = document.getElementById('shelf-scanned-count');
    shelfNumberInputForBulk = document.getElementById('shelf-number-input');
    shelfRegisterBtn = document.getElementById('shelf-register-btn');
    shelfClearBtn = document.getElementById('shelf-clear-btn');

    bulkShelfNumberBtn.addEventListener('click', () => {
        shelfScanPool = [];
        updateShelfScannedList(shelfScannedList, shelfScannedCount, shelfScanPool);
        shelfNumberInputForBulk.value = '';
        shelfModal.classList.remove('hidden');
        document.body.classList.add('modal-open');
        setTimeout(() => shelfBarcodeInput.focus(), 100);
    });

    closeShelfModalBtn.addEventListener('click', () => {
        shelfModal.classList.add('hidden');
        document.body.classList.remove('modal-open');
    });

    // ▼▼▼【ここから修正】▼▼▼
    shelfBarcodeForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const barcode = shelfBarcodeInput.value.trim();
        if (barcode) {
            // GS1-128形式の場合、(01)に続く14桁のGS1コード部分のみを抽出
            let gs1Code = barcode;
            if (barcode.startsWith('01') && barcode.length >= 16) {
                gs1Code = barcode.substring(2, 16);
            }

            if (!shelfScanPool.some(item => item.gs1 === gs1Code)) {
                shelfScanPool.push({ gs1: gs1Code, name: null });
                updateShelfScannedList(shelfScannedList, shelfScannedCount, shelfScanPool);
                resolveProductNameForShelfScan(gs1Code);
            } else {
                window.showNotification('このバーコードは既にリストにあります。', 'error');
            }
        }
        shelfBarcodeInput.value = '';
    });
    // ▲▲▲【修正ここまで】▲▲▲

    shelfRegisterBtn.addEventListener('click', handleShelfRegister);

    shelfClearBtn.addEventListener('click', () => {
        if (confirm('スキャン済みリストをクリアしますか？')) {
            shelfScanPool = [];
            updateShelfScannedList(shelfScannedList, shelfScannedCount, shelfScanPool);
            shelfBarcodeInput.focus();
        }
    });

    view.addEventListener('filterMasterEdit', async (e) => {
        const { productCode } = e.detail;
        if (productCode) {
            kanaNameInput.value = productCode;
            await loadAndRenderMasters(); 
            const targetRow = tableContainer.querySelector(`[data-record-id="${productCode}"]`);
            if (targetRow) {
                targetRow.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }
    });

    refreshBtn.addEventListener('click', loadAndRenderMasters);

    addRowBtn.addEventListener('click', async () => {
        window.showLoading();
        try {
            const res = await fetch('/api/sequence/next/MA2Y');
            const data = await res.json();
            if (!res.ok) throw new Error(data.message || 'YJコードの採番に失敗しました。');
            
            const newMasterData = { yjCode: data.nextCode };
            const newRowContent = createMasterRowHTML(newMasterData);
            const newTableHTML = `<table class="data-table master-edit-table">${newRowContent}</table>`;

            tableContainer.insertAdjacentHTML('beforeend', newTableHTML);
            const newTable = tableContainer.lastElementChild;
            
            if (newTable) {
                newTable.scrollIntoView({ behavior: 'smooth', block: 'end' });
                const firstInput = newTable.querySelector('input[name="productCode"]');
                if (firstInput) firstInput.focus();
            }
        } catch (err) {
            window.showNotification(err.message, 'error');
        } finally {
            window.hideLoading();
        }
    });

    kanaNameInput.addEventListener('change', applyFiltersAndRender);
    dosageFormInput.addEventListener('change', applyFiltersAndRender);
    shelfNumberInput.addEventListener('input', applyFiltersAndRender);
    
    tableContainer.addEventListener('input', (e) => {
        const tbody = e.target.closest('tbody[data-record-id]');
        if (tbody) {
            formatPackageSpecForRow(tbody);
        }
    });

    tableContainer.addEventListener('click', async (e) => {
        const target = e.target;
        const tbody = target.closest('tbody[data-record-id]');
        if (!tbody) return;

        if (target.classList.contains('save-master-btn')) {
            const isNew = tbody.dataset.recordId.startsWith('new-');
            const data = {};
            tbody.querySelectorAll('input, select, textarea').forEach(el => {
                if(el.name){
                    const name = el.name;
                    const value = el.value;
                    
                    const numericSelects = [
                        'janUnitCode', 'flagPoison', 'flagDeleterious', 'flagNarcotic', 
                        'flagPsychotropic', 'flagStimulant', 'flagStimulantRaw', 'isOrderStopped'
                    ];

                    if (el.type === 'number' || (el.tagName === 'SELECT' && numericSelects.includes(name))) {
                        const numValue = parseFloat(value);
                        data[name] = !isNaN(numValue) ? numValue : 0;
                    } else {
                        data[name] = value;
                    }
                }
            });
      
            data.origin = data.origin || "PROVISIONAL";

            if (!data.productCode) {
                window.showNotification('製品コード(JAN)は必須です。', 'error');
                return;
            }
            window.showLoading();
            try {
                const res = await fetch('/api/master/update', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data),
                });

                if (!res.ok) {
                    let errorMsg = `保存に失敗しました (HTTP ${res.status})`;
                    try {
                        const errData = await res.json();
                        errorMsg = errData.message || errorMsg;
                    } catch (jsonError) {
                        const errText = await res.text();
                        errorMsg = errText || errorMsg;
                    }
                    throw new Error(errorMsg);
                }

                const resData = await res.json();
                window.showNotification(resData.message, 'success');

                const masterIndex = allMasters.findIndex(m => m.productCode === data.productCode);
                if (masterIndex > -1) {
                    allMasters[masterIndex] = { ...allMasters[masterIndex], ...data };
                } else {
                    allMasters.push(data);
                }

                if (isNew) {
                    const productCodeInput = tbody.querySelector('input[name="productCode"]');
                    productCodeInput.readOnly = true;
                    tbody.dataset.recordId = data.productCode;
                    const originInput = tbody.querySelector('input[name="origin"]');
                    originInput.value = data.origin;
                }
                
                tbody.querySelectorAll('tr').forEach(row => {
                    row.classList.remove('save-success');
                    void row.offsetWidth;
                    row.classList.add('save-success');
                });

            } catch (err) {
                window.showNotification(err.message, 'error');
            } finally {
                window.hideLoading();
            }
        }
      
        if (target.classList.contains('quote-jcshms-btn')) {
            showModal(tbody, populateFormWithJcshms);
        }
    });

    loadAndRenderMasters();
}

export function resetMasterEditView() {
    if (tableContainer) {
        if(kanaNameInput) kanaNameInput.value = '';
        if(dosageFormInput) dosageFormInput.value = '';
        if(shelfNumberInput) shelfNumberInput.value = '';
        loadAndRenderMasters();
    }
}

----- C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\master_edit_ui.js -----
// C:/Users/wasab/OneDrive/デスクトップ/WASABI/static/js/master_edit_ui.js

import { wholesalerMap } from './master_data.js';

let unitMap = {};

export function setUnitMap(map) {
    unitMap = map;
}

function formatPackageSpecForRow(tbody) {
    if (!tbody) return;
    const getVal = (name) => tbody.querySelector(`[name="${name}"]`)?.value || '';
    const packageForm = getVal('packageForm');
    const yjPackUnitQty = getVal('yjPackUnitQty');
    const yjUnitName = getVal('yjUnitName');
    const janPackInnerQty = getVal('janPackInnerQty');
    const janPackUnitQty = getVal('janPackUnitQty');
    const janUnitCode = getVal('janUnitCode');
    
    let formattedSpec = `${packageForm} ${yjPackUnitQty}${yjUnitName}`;
    if (parseFloat(janPackInnerQty) > 0 && parseFloat(janPackUnitQty) > 0) {
        let janUnitName = (janUnitCode === '0' || janUnitCode === '') ?
            '' : (unitMap[janUnitCode] || '');
        formattedSpec += ` (${janPackInnerQty}${yjUnitName}×${janPackUnitQty}${janUnitName})`;
    }
    const targetCell = tbody.querySelector('.formatted-spec-cell');
    if (targetCell) targetCell.textContent = formattedSpec;
}

function createMasterRowHTML(master = {}) {
    const isNew = !master.productCode;
    const rowId = master.productCode || `new-${Date.now()}`;
    const isProtected = master.origin === 'JCSHMS';
    const disabledAttr = isProtected ? 'disabled' : '';
    // ▼▼▼【ここから修正】YJコードが空白の場合は編集できるようにreadonly条件を変更 ▼▼▼
    const row1 = `
        <tr class="data-row-top">
            <td colspan="2"><div class="field-group"><label>1. JAN</label><input type="text" name="productCode" value="${master.productCode || ''}" placeholder="製品コード(JAN)" ${!isNew ? 'readonly' : ''}></div></td>
            <td colspan="2"><div class="field-group"><label>2. YJ</label><input type="text" name="yjCode" value="${master.yjCode || ''}" placeholder="YJコード" ${isNew || (isProtected && master.yjCode) ? 'readonly' : ''}></div></td>
            <td colspan="2"><div class="field-group"><label>3. GS1</label><input type="text" name="gs1Code" value="${master.gs1Code || ''}" ${disabledAttr}></div></td>
            <td colspan="3"><div class="field-group"><label>4. 商品名</label><input type="text" name="productName" value="${master.productName || ''}" ${disabledAttr}></div></td>
            <td colspan="3"><div class="field-group"><label>5. カナ</label><input type="text" name="kanaName" value="${master.kanaName || ''}" ${disabledAttr}></div></td>
        </tr>`;
    // ▲▲▲【修正ここまで】▲▲▲

    const row2 = `
        <tr class="data-row-middle">
            <td colspan="3"><div class="field-group"><label>6. メーカー</label><input type="text" name="makerName" value="${master.makerName || ''}" ${disabledAttr}></div></td>
            <td colspan="3"><div class="field-group"><label>7. 規格容量</label><input type="text" name="specification" value="${master.specification || ''}" ${disabledAttr}></div></td>
            <td colspan="2"><div class="field-group"><label>8. 剤型</label><input type="text" name="usageClassification" value="${master.usageClassification || ''}" ${disabledAttr}></div></td>
            <td colspan="4"><div class="field-group"><label>9. 包装</label><input type="text" name="packageForm" value="${master.packageForm || ''}" ${disabledAttr}></div></td>
        </tr>`;
    
    let janUnitOptions = '<option value="0">YJ単位と同じ</option>';
    for (const [code, name] of Object.entries(unitMap)) {
        if (code !== '0') janUnitOptions += `<option value="${code}" ${code == (master.janUnitCode || 0) ? 'selected' : ''}>${name}</option>`;
    }
    const flags = [
        { key: 'flagPoison', lbl: '18.毒' }, { key: 'flagDeleterious', lbl: '19.劇' }, { key: 'flagNarcotic', lbl: '20.麻' },
        { key: 'flagPsychotropic', lbl: '21.向' }, { key: 'flagStimulant', lbl: '22.覚' }, { key: 'flagStimulantRaw', lbl: '23.覚原' }
    ];
    const flagSelectorsHTML = flags.map(f => {
        const opts = (f.key === 'flagPsychotropic') ? [0, 1, 2, 3] : [0, 1];
        const options = opts.map(o => `<option value="${o}" ${o == (master[f.key] || 0) ? 'selected' : ''}>${o}</option>`).join('');
        return `<div class="field-group"><label style="text-align:center;">${f.lbl}</label><select name="${f.key}" ${disabledAttr}>${options}</select></div>`;
    }).join('');

    const row3 = `
        <tr class="data-row-middle">
            <td><div class="field-group"><label>10. YJ単位</label><input type="text" name="yjUnitName" value="${master.yjUnitName || ''}" ${disabledAttr}></div></td>
            <td><div class="field-group"><label>11. YJ数量</label><input type="number" name="yjPackUnitQty" value="${master.yjPackUnitQty || 0}" ${disabledAttr}></div></td>
            <td><div class="field-group"><label>12. 包装数</label><input type="number" name="janPackInnerQty" value="${master.janPackInnerQty || 0}" ${disabledAttr}></div></td>
            <td><div class="field-group"><label>13. JAN単位</label><select name="janUnitCode" ${disabledAttr}>${janUnitOptions}</select></div></td>
            <td><div class="field-group"><label>14. JAN数量</label><input type="number" name="janPackUnitQty" value="${master.janPackUnitQty || 0}" ${disabledAttr}></div></td>
            <td><div class="field-group"><label>15. マスタ</label><input type="text" name="origin" value="${master.origin || ''}" readonly></div></td>
            <td><div class="field-group"><label>16. 薬価</label><input type="number" name="nhiPrice" value="${master.nhiPrice || 0}" step="0.0001" ${disabledAttr}></div></td>
            <td colspan="5"><div class="flags-container">${flagSelectorsHTML}</div></td>
        </tr>`;

    let wholesalerOptions = '<option value="">--- 選択 ---</option>';
    wholesalerMap.forEach((name, code) => {
        wholesalerOptions += `<option value="${code}" ${code === master.supplierWholesale ? 'selected' : ''}>${name}</option>`;
    });
    const isOrderStoppedOptions = `<option value="0" ${ (master.isOrderStopped || 0) == 0 ? 'selected' : '' }>可</option><option value="1" ${ (master.isOrderStopped || 0) == 1 ? 'selected' : '' }>不可</option>`;
    
    const row4 = `
        <tr class="data-row-user">
            <td colspan="2"><div class="field-group"><label>17. 納入価(包装)</label><input type="number" name="purchasePrice" value="${master.purchasePrice || ''}" step="0.01"></div></td>
            <td colspan="2"><div class="field-group"><label>24. 卸</label><select name="supplierWholesale">${wholesalerOptions}</select></div></td>
            <td><div class="field-group"><label>25. 発注</label><select name="isOrderStopped">${isOrderStoppedOptions}</select></div></td>
            <td><div class="field-group"><label>26. グループ</label><input type="text" name="groupCode" value="${master.groupCode || ''}"></div></td>
            <td><div class="field-group"><label>27. 棚番</label><input type="text" name="shelfNumber" value="${master.shelfNumber || ''}"></div></td>
            <td><div class="field-group"><label>28. 分類</label><input type="text" name="category" value="${master.category || ''}"></div></td>
            <td colspan="2"><div class="field-group"><label>29. メモ</label><textarea name="userNotes">${master.userNotes || ''}</textarea></div></td>
            <td><div class="field-group"><label>&nbsp;</label><button class="save-master-btn btn">30.保存</button></div></td>
            <td><div class="field-group"><label>&nbsp;</label><button class="quote-jcshms-btn btn" ${disabledAttr}>31.引用</button></div></td>
        </tr>`;

    return `<tbody data-record-id="${rowId}">${row1}${row2}${row3}${row4}</tbody>`;
}

export function renderMasters(mastersToRender, tableContainer) {
    if (!mastersToRender || mastersToRender.length === 0) {
        tableContainer.innerHTML = '<p>対象のマスターが見つかりません。</p>';
        return;
    }
    const allTablesHTML = mastersToRender.map(master => {
        const tableContent = createMasterRowHTML(master);
        return `<table class="data-table master-edit-table">${tableContent}</table>`;
    }).join('');
    tableContainer.innerHTML = allTablesHTML;
}

export function updateShelfScannedList(shelfScannedList, shelfScannedCount, shelfScanPool) {
    shelfScannedCount.textContent = shelfScanPool.length;
    shelfScannedList.innerHTML = shelfScanPool.map(item => `
        <div class="scanned-item" data-gs1="${item.gs1}">
            <span class="scanned-item-name ${item.name ? 'resolved' : ''}">${item.name || item.gs1}</span>
        </div>
    `).join('');
}

export { createMasterRowHTML, formatPackageSpecForRow };

----- C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\master_edit.js -----
// C:/Users/wasab/OneDrive/デスクトップ/WASABI/static/js/master_edit.js

import { initLogic, resetMasterEditView } from './master_edit_logic.js';
import { setUnitMap } from './master_edit_ui.js';

// ▼▼▼【ここから修正】欠落していたCSS定義を追加▼▼▼
const style = document.createElement('style');
style.innerHTML = `
    .master-edit-table .field-group { display: flex; flex-direction: column; gap: 2px; }
    .master-edit-table .field-group label { font-size: 10px; font-weight: bold; color: #555; }
    .master-edit-table .field-group input, .master-edit-table .field-group select, .master-edit-table .field-group textarea { width: 100%; font-size: 12px; padding: 4px; border: 1px solid #ccc; }
    .master-edit-table textarea { resize: vertical; min-height: 40px; }
    .master-edit-table .flags-container { display: flex; gap: 5px; }
    .master-edit-table .flags-container .field-group { flex: 1; }
    .master-edit-table input:read-only, .master-edit-table select:disabled, .master-edit-table input:disabled { background-color: #e9ecef; color: #6c757d; cursor: not-allowed; }
    
    .save-success {
        animation: flash-green 1.5s ease-out;
    }
    @keyframes flash-green {
        0% { background-color: #d1e7dd; }
        100% { background-color: transparent; }
    }
`;
document.head.appendChild(style);
// ▲▲▲【修正ここまで】▲▲▲

export async function initMasterEdit() {
    let unitMap = {};
    try {
        const res = await fetch('/api/units/map');
        if (!res.ok) throw new Error('単位マスタの取得に失敗');
        unitMap = await res.json();
        setUnitMap(unitMap); // UIモジュールに単位マップを設定
    } catch (err) {
        console.error(err);
        window.showNotification(err.message, 'error');
    }

    initLogic();
}

export { resetMasterEditView };

----- C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\medrec.js -----
// C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\medrec.js

export function initMedrec() {
    const downloadBtn = document.getElementById('medrecDownloadBtn');
    if (!downloadBtn) return;

    downloadBtn.addEventListener('click', async () => {
        if (!confirm('e-mednet.jpにログインし、納品データをダウンロードします。よろしいですか？')) {
            return;
        }

        window.showLoading();
        try {
            const res = await fetch('/api/medrec/download', {
                method: 'POST',
            });
            
            // ▼▼▼ [ここから修正] エラーハンドリングを改善 ▼▼▼
            if (!res.ok) {
                const errorText = await res.text();
                try {
                    const resData = JSON.parse(errorText);
                    throw new Error(resData.message || `ダウンロードに失敗しました (HTTP ${res.status})`);
                } catch (e) {
                    throw new Error(errorText || `ダウンロードに失敗しました (HTTP ${res.status})`);
                }
            }
            const resData = await res.json();
            window.showNotification(resData.message, 'success');
            // ▲▲▲ [修正ここまで] ▲▲▲
        } catch (err) {
            console.error('Download failed:', err);
            const errorMessage = err.message || 'サーバーとの通信に失敗しました。設定画面でID/パスワードが正しいか確認してください。';
            window.showNotification(errorMessage, 'error');
        } finally {
            window.hideLoading();
        }
    });
}

----- C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\orders.js -----
// C:/Users/wasab/OneDrive/デスクトップ/WASABI/static/js/orders.js
import { hiraganaToKatakana, getLocalDateString, toHalfWidth } from './utils.js';
import { wholesalerMap } from './master_data.js';
import { showModal } from './inout_modal.js';

let continuousOrderModal, continuousOrderBtn, closeContinuousModalBtn;
let continuousBarcodeForm, continuousBarcodeInput, scannedItemsList, scannedItemsCount, processingIndicator;
let scanQueue = [];
let isProcessingQueue = false;

function formatBalance(balance) {
    if (typeof balance === 'number') {
        return balance.toFixed(2);
    }
    return balance;
}

function addOrUpdateOrderItem(productMaster) {
    const outputContainer = document.getElementById('order-candidates-output');
    const productCode = productMaster.productCode;
    const yjCode = productMaster.yjCode;

    const existingRow = outputContainer.querySelector(`tr[data-jan-code="${productCode}"]`);
    if (existingRow) {
        const quantityInput = existingRow.querySelector('.order-quantity-input');
        if (quantityInput) {
            quantityInput.value = parseInt(quantityInput.value, 10) + 1;
            window.showNotification(`「${productMaster.productName}」の数量を1増やしました。`, 'success');
        }
        return;
    }

    let wholesalerOptions = '<option value="">--- 選択 ---</option>';
    wholesalerMap.forEach((name, code) => {
        const isSelected = (code === productMaster.supplierWholesale);
        wholesalerOptions += `<option value="${code}" ${isSelected ? 'selected' : ''}>${name}</option>`;
    });

    const actionCellHTML = `
        <td class="order-actions-cell">
            <div class="order-action-buttons">
                <button class="remove-order-item-btn btn">除外</button>
                <button class="go-to-master-btn btn" data-product-code="${productMaster.productCode}">ﾏｽﾀ</button>
                <button class="set-unorderable-btn btn" data-product-code="${productMaster.productCode}">発注不可</button>
                <button class="go-to-inv-adj-btn btn" data-yj-code="${productMaster.yjCode}">棚卸調整</button>
            </div>
        </td>
    `;

    const newRowHTML = `
        <tr data-jan-code="${productMaster.productCode}" 
            data-yj-code="${productMaster.yjCode}"
            data-product-name="${productMaster.productName}"
            data-package-form="${productMaster.packageForm}"
            data-jan-pack-inner-qty="${productMaster.janPackInnerQty}"
            data-yj-unit-name="${productMaster.yjUnitName}"
            data-yj-pack-unit-qty="${productMaster.yjPackUnitQty}"
            data-order-multiplier="${productMaster.yjPackUnitQty}"> 
            <td class="left">${productMaster.productName}</td>
            <td class="left">${productMaster.makerName || ''}</td>
            <td class="left">${productMaster.formattedPackageSpec}</td>
            <td><select class="wholesaler-select" style="width: 100%;">${wholesalerOptions}</select></td>
            <td>1包装 (${productMaster.yjPackUnitQty} ${productMaster.yjUnitName})</td>
            <td><input type="number" value="1" class="order-quantity-input" style="width: 80px;"></td>
            ${actionCellHTML}
        </tr>
    `;

    let yjGroupWrapper = outputContainer.querySelector(`.order-yj-group-wrapper[data-yj-code="${yjCode}"]`);

    if (yjGroupWrapper) {
        const tbody = yjGroupWrapper.querySelector('tbody');
        tbody.insertAdjacentHTML('beforeend', newRowHTML);
    } else {
        const yjHeaderHTML = `
            <div class="agg-yj-header">
                <span>YJ: ${yjCode}</span>
                <span class="product-name">${productMaster.productName}</span>
            </div>`;
        
        const tableHTML = `
            <table class="data-table" style="margin-bottom: 20px;">
                <thead>
                    <tr>
                        <th style="width: 25%;">製品名（包装）</th>
                        <th style="width: 15%;">メーカー</th>
                        <th style="width: 15%;">包装仕様</th>
                        <th style="width: 20%;">卸業者</th>
                        <th style="width: 10%;">発注単位</th>
                        <th style="width: 5%;">発注数</th>
                        <th style="width: 10%;">操作</th>
                    </tr>
                </thead>
                <tbody>
                    ${newRowHTML}
                </tbody>
            </table>`;
        
        const newGroupHTML = `
            <div class="order-yj-group-wrapper" data-yj-code="${yjCode}">
                ${yjHeaderHTML}
                ${tableHTML}
            </div>`;
        
        outputContainer.insertAdjacentHTML('beforeend', newGroupHTML);
    }
    window.showNotification(`「${productMaster.productName}」を発注リストに追加しました。`, 'success');
}

function updateScannedItemsDisplay() {
    const counts = scanQueue.reduce((acc, code) => {
        acc[code] = (acc[code] || 0) + 1;
        return acc;
    }, {});

    scannedItemsList.innerHTML = Object.entries(counts).map(([code, count]) => {
        return `<div class="scanned-item">
                    <span class="scanned-item-name">${code}</span>
                    <span class="scanned-item-count">x ${count}</span>
                </div>`;
    }).join('');
    scannedItemsCount.textContent = scanQueue.length;
}

async function processScanQueue() {
    if (isProcessingQueue) return;

    isProcessingQueue = true;
    processingIndicator.classList.remove('hidden');

    while (scanQueue.length > 0) {
        const barcode = scanQueue.shift();

        try {
            let gs1Code = '';
            if (barcode.startsWith('01') && barcode.length > 16) {
                gs1Code = barcode.substring(2, 16);
            } else {
                gs1Code = barcode;
            }

            const res = await fetch(`/api/product/by_gs1?gs1_code=${gs1Code}`);
            if (!res.ok) {
                if (res.status === 404) {
                    const newMaster = await createAndFetchMaster(gs1Code);
                    addOrUpdateOrderItem(newMaster);
                } else {
                    throw new Error(`サーバーエラー (HTTP ${res.status})`);
                }
            } else {
                const productMaster = await res.json();
                addOrUpdateOrderItem(productMaster);
            }
        } catch (err) {
            console.error(`バーコード[${barcode}]の処理に失敗:`, err);
            window.showNotification(`バーコード[${barcode}]の処理に失敗しました: ${err.message}`, 'error');
        } finally {
            updateScannedItemsDisplay();
        }
    }

    isProcessingQueue = false;
    processingIndicator.classList.add('hidden');
}

function renderOrderCandidates(data, container, wholesalers) {
    if (!data || data.length === 0) {
        container.innerHTML = "<p>発注が必要な品目はありませんでした。</p>";
        return;
    }

    let html = '';
    data.forEach(yjGroup => {
        const yjShortfall = yjGroup.totalReorderPoint - (yjGroup.endingBalance || 0);

        html += `
            <div class="order-yj-group-wrapper" data-yj-code="${yjGroup.yjCode}">
                <div class="agg-yj-header" style="background-color: #ff0015ff;">
                    <span>YJ: ${yjGroup.yjCode}</span>
                    <span class="product-name">${yjGroup.productName}</span>
                    <span class="balance-info">
                        在庫: ${formatBalance(yjGroup.endingBalance)} | 
                        発注点: ${formatBalance(yjGroup.totalReorderPoint)} | 
                        不足数: ${formatBalance(yjShortfall)}
                    </span>
                </div>
        `;

        const existingBackordersForYj = yjGroup.packageLedgers.flatMap(p => p.existingBackorders || []);
        if (existingBackordersForYj.length > 0) {
            html += `<div class="existing-backorders-info">
                        <strong>＜既存の発注残＞</strong>
                        <ul>`;
            existingBackordersForYj.forEach(bo => {
                const wName = wholesalerMap.get(bo.wholesalerCode.String) || bo.wholesalerCode.String || '不明';
                html += `<li>${bo.orderDate}: ${bo.productName} - 数量: ${bo.remainingQuantity.toFixed(2)} (${wName})</li>`;
            });
            html += `</ul></div>`;
        }

        html += `
                <table class="data-table" style="margin-bottom: 20px;">
                    <thead>
                        <tr>
                            <th style="width: 25%;">製品名（包装）</th>
                            <th style="width: 15%;">メーカー</th>
                            <th style="width: 15%;">包装仕様</th>
                            <th style="width: 20%;">卸業者</th>
                            <th style="width: 10%;">発注単位</th>
                            <th style="width: 5%;">発注数</th>
                            <th style="width: 10%;">操作</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        yjGroup.packageLedgers.forEach(pkg => {
            if (pkg.masters && pkg.masters.length > 0) {
                pkg.masters.forEach(master => {
                    const pkgShortfall = pkg.reorderPoint - (pkg.endingBalance || 0);
                    if (pkgShortfall > 0) {
                        const isProvisional = master.productCode.startsWith('99999') && master.productCode.length > 13;
                        const isOrderStopped = master.isOrderStopped === 1;
                        const isOrderable = !isProvisional && !isOrderStopped;

                        const rowClass = !isOrderable ? 'provisional-order-item' : '';
                        const disabledAttr = !isOrderable ? 'disabled' : '';

                        const recommendedOrder = master.yjPackUnitQty > 0 ? Math.ceil(pkgShortfall / master.yjPackUnitQty) : 0;
                        
                        let rowWholesalerOptions = '<option value="">--- 選択 ---</option>';
                        wholesalers.forEach(w => {
                            const isSelected = (w.code === master.supplierWholesale);
                            rowWholesalerOptions += `<option value="${w.code}" ${isSelected ? 'selected' : ''}>${w.name}</option>`;
                        });

                        let actionCellHTML = `
                            <td class="order-actions-cell">
                                <div class="order-action-buttons">
                        `;
                        if (isOrderable) {
                            actionCellHTML += '<button class="remove-order-item-btn btn">除外</button>';
                        } else {
                            actionCellHTML += '<button class="change-to-orderable-btn btn">発注に変更</button>';
                        }
                        actionCellHTML += `
                                    <button class="go-to-master-btn btn" data-product-code="${master.productCode}">ﾏｽﾀ</button>
                                    <button class="set-unorderable-btn btn" data-product-code="${master.productCode}">発注不可</button>
                                    <button class="go-to-inv-adj-btn btn" data-yj-code="${yjGroup.yjCode}">棚卸調整</button>
                                </div>
                            </td>
                        `;

                        html += `
                            <tr class="${rowClass}" 
                                data-jan-code="${master.productCode}" 
                                data-yj-code="${yjGroup.yjCode}"
                                data-product-name="${master.productName}"
                                data-package-form="${master.packageForm}"
                                data-jan-pack-inner-qty="${master.janPackInnerQty}"
                                data-yj-unit-name="${master.yjUnitName}"
                                data-yj-pack-unit-qty="${master.yjPackUnitQty}"
                                data-order-multiplier="${master.yjPackUnitQty}"> 
                                <td class="left">${master.productName}</td>
                                <td class="left">${master.makerName || ''}</td>
                                <td class="left">${master.formattedPackageSpec}</td>
                                <td><select class="wholesaler-select" style="width: 100%;" ${disabledAttr}>${rowWholesalerOptions}</select></td>
                                <td>1包装 (${master.yjPackUnitQty} ${master.yjUnitName})</td>
                                <td><input type="number" value="${recommendedOrder}" class="order-quantity-input" style="width: 80px;" ${disabledAttr}></td>
                                ${actionCellHTML}
                            </tr>
                        `;
                    }
                });
            }
        });
        html += `</tbody></table></div>`;
    });
    container.innerHTML = html;
}

async function handleOrderBarcodeScan(e) {
    e.preventDefault();
    const barcodeInput = document.getElementById('order-barcode-input');
    const inputValue = barcodeInput.value.trim();
    if (!inputValue) return;

    let gs1Code = '';
    if (inputValue.startsWith('01') && inputValue.length > 16) {
        gs1Code = inputValue.substring(2, 16);
    } else {
        gs1Code = inputValue;
    }

    if (!gs1Code) {
        window.showNotification('有効なGS1コードではありません。', 'error');
        return;
    }

    window.showLoading('製品情報を検索中...');
    try {
        const res = await fetch(`/api/product/by_gs1?gs1_code=${gs1Code}`);
        if (!res.ok) {
            if (res.status === 404) {
                if (confirm(`このGS1コードはマスターに登録されていません。\n新規マスターを作成して発注リストに追加しますか？`)) {
                    const newMaster = await createAndFetchMaster(gs1Code);
                    addOrUpdateOrderItem(newMaster);
                } else {
                    throw new Error('このGS1コードはマスターに登録されていません。');
                }
            } else {
                throw new Error('製品情報の検索に失敗しました。');
            }
        } else {
            const productMaster = await res.json();
            addOrUpdateOrderItem(productMaster);
        }
        barcodeInput.value = '';
        barcodeInput.focus();
    } catch (err) {
        window.showNotification(err.message, 'error');
    } finally {
        window.hideLoading();
    }
}

async function createAndFetchMaster(gs1Code) {
    window.showLoading('新規マスターを作成中...');
    try {
        const productCode = gs1Code.length === 14 ? gs1Code.substring(1) : gs1Code;

        const createRes = await fetch('/api/master/create_provisional', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ gs1Code, productCode }),
        });
        const createData = await createRes.json();
        if (!createRes.ok) {
            throw new Error(createData.message || 'マスターの作成に失敗しました。');
        }
        window.showNotification(`新規マスターを作成しました (YJ: ${createData.yjCode})`, 'success');
        window.showLoading('作成したマスター情報を取得中...');
        const fetchRes = await fetch(`/api/product/by_gs1?gs1_code=${gs1Code}`);
        if (!fetchRes.ok) {
            throw new Error('作成されたマスター情報の取得に失敗しました。');
        }
        const newMaster = await fetchRes.json();
        return newMaster;

    } catch (err) {
        throw err;
    }
}

export function initOrders() {
    const view = document.getElementById('order-view');
    if (!view) return;

    const runBtn = document.getElementById('generate-order-candidates-btn');
    const outputContainer = document.getElementById('order-candidates-output');
    const kanaNameInput = document.getElementById('order-kanaName');
    const dosageFormInput = document.getElementById('order-dosageForm');
    const coefficientInput = document.getElementById('order-reorder-coefficient');
    const createCsvBtn = document.getElementById('createOrderCsvBtn');
    const barcodeInput = document.getElementById('order-barcode-input');
    const barcodeForm = document.getElementById('order-barcode-form');
    const shelfNumberInput = document.getElementById('order-shelf-number');
    const addFromMasterBtn = document.getElementById('add-order-item-from-master-btn');

    continuousOrderModal = document.getElementById('continuous-order-modal');
    continuousOrderBtn = document.getElementById('continuous-order-btn');
    closeContinuousModalBtn = document.getElementById('close-continuous-modal-btn');
    continuousBarcodeForm = document.getElementById('continuous-barcode-form');
    continuousBarcodeInput = document.getElementById('continuous-barcode-input');
    scannedItemsList = document.getElementById('scanned-items-list');
    scannedItemsCount = document.getElementById('scanned-items-count');
    processingIndicator = document.getElementById('processing-indicator');

    // ▼▼▼【ここから修正】▼▼▼
    addFromMasterBtn.addEventListener('click', () => {
        showModal(view, async (selectedProduct) => {
            window.showLoading('品目を準備しています...');
            try {
                let masterToAdd;
                if (selectedProduct.isAdopted) {
                    // 採用済みの場合は、JANコードで完全なマスター情報を取得しなおす
                    const res = await fetch(`/api/master/by_code/${selectedProduct.productCode}`);
                    if (!res.ok) {
                        const errJson = await res.json().catch(() => ({ message: '採用済みマスター情報の取得に失敗しました。' }));
                        throw new Error(errJson.message);
                    }
                    masterToAdd = await res.json();
                } else {
                    // 未採用の場合は、JCSHMSからマスターを新規作成するAPIを叩く
                    const createRes = await fetch('/api/master/create_from_jcshms', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ productCode: selectedProduct.productCode })
                    });
                    if (!createRes.ok) {
                        const errData = await createRes.json();
                        throw new Error(errData.message || 'JCSHMSからのマスター作成に失敗しました。');
                    }
                    masterToAdd = await createRes.json();
                }
                addOrUpdateOrderItem(masterToAdd);
            } catch (err) {
                window.showNotification(err.message, 'error');
            } finally {
                window.hideLoading();
            }
        });
    });
    // ▲▲▲【修正ここまで】▲▲▲

    continuousOrderBtn.addEventListener('click', () => {
        scanQueue = [];
        updateScannedItemsDisplay();
        continuousOrderModal.classList.remove('hidden');
        document.body.classList.add('modal-open');
        setTimeout(() => continuousBarcodeInput.focus(), 100);
    });

    closeContinuousModalBtn.addEventListener('click', () => {
        continuousOrderModal.classList.add('hidden');
        document.body.classList.remove('modal-open');
    });

    continuousBarcodeForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const barcode = continuousBarcodeInput.value.trim();
        if (barcode) {
            scanQueue.push(barcode);
            updateScannedItemsDisplay();
            processScanQueue();
        }
        continuousBarcodeInput.value = '';
    });
    
    if (barcodeForm) {
        barcodeForm.addEventListener('submit', handleOrderBarcodeScan);
    }
    
    runBtn.addEventListener('click', async () => {
        window.showLoading();
        const params = new URLSearchParams({
            kanaName: hiraganaToKatakana(kanaNameInput.value),
            dosageForm: dosageFormInput.value,
            shelfNumber: shelfNumberInput.value,
            coefficient: coefficientInput.value,
        });

        try {
            const res = await fetch(`/api/orders/candidates?${params.toString()}`);
            if (!res.ok) {
                const errText = await res.text();
                throw new Error(errText || 'List generation failed');
            }
            const data = await res.json();
            
            renderOrderCandidates(data.candidates, outputContainer, data.wholesalers || []);

        } catch (err) {
            outputContainer.innerHTML = `<p style="color:red;">エラー: ${err.message}</p>`;
        } finally {
            window.hideLoading();
        }
    });

    createCsvBtn.addEventListener('click', async () => {
        const rows = outputContainer.querySelectorAll('tbody tr');
        if (rows.length === 0) {
            window.showNotification('発注する品目がありません。', 'error');
            return;
        }

        const backorderPayload = [];
        let csvContent = "";
        let hasItemsToOrder = false;

        rows.forEach(row => {
            if (row.classList.contains('provisional-order-item')) {
                return; 
            }
            
            const quantityInput = row.querySelector('.order-quantity-input');
            const quantity = parseInt(quantityInput.value, 10);
            
            if (quantity > 0) {
                hasItemsToOrder = true;
                
                const janCode = row.dataset.janCode;
                const productName = row.cells[0].textContent;
                const wholesalerCode = row.querySelector('.wholesaler-select').value;
    
                const csvRow = [janCode, `"${productName}"`, quantity, wholesalerCode].join(',');
                csvContent += csvRow + "\r\n";

                const orderMultiplier = parseFloat(row.dataset.orderMultiplier) || 0;
                
                backorderPayload.push({
                    yjCode: row.dataset.yjCode,
                    packageForm: row.dataset.packageForm,
                    janPackInnerQty: parseFloat(row.dataset.janPackInnerQty),
                    yjUnitName: row.dataset.yjUnitName,
                    yjQuantity: quantity * orderMultiplier,
                    productName: row.dataset.productName,
                    yjPackUnitQty: parseFloat(row.dataset.yjPackUnitQty) || 0,
                    wholesalerCode: { String: wholesalerCode, Valid: wholesalerCode !== "" },
                });
            }
        });

        if (!hasItemsToOrder) {
            window.showNotification('発注数が1以上の品目がありません。', 'error');
            return;
        }

        window.showLoading();
        try {
            const res = await fetch('/api/orders/place', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(backorderPayload),
            });
            const resData = await res.json();
            if (!res.ok) throw new Error(resData.message || '発注残の登録に失敗しました。');
            
            window.showNotification(resData.message, 'success');
            const sjisArray = Encoding.convert(csvContent, {
                to: 'SJIS',
                from: 'UNICODE',
                type: 'array'
            });
            const sjisUint8Array = new Uint8Array(sjisArray);

            const blob = new Blob([sjisUint8Array], { type: 'text/csv' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            const now = new Date();
            const timestamp = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}_${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}${now.getSeconds().toString().padStart(2, '0')}`;
            const fileName = `発注書_${timestamp}.csv`;
            
            link.setAttribute("href", url);
            link.setAttribute("download", fileName);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        } catch(err) {
            window.showNotification(err.message, 'error');
        } finally {
            window.hideLoading();
        }
    });

    outputContainer.addEventListener('click', async (e) => {
        const target = e.target;
        const row = target.closest('tr');

        if (target.classList.contains('go-to-master-btn')) {
            const productCode = target.dataset.productCode;
            document.dispatchEvent(new CustomEvent('navigateToMasterEdit', {
                detail: { productCode },
                bubbles: true
            }));
        } else if (target.classList.contains('set-unorderable-btn')) {
            const productCode = target.dataset.productCode;
            const productName = row ? row.cells[0].textContent : productCode;
            if (!confirm(`「${productName}」を発注不可に設定しますか？\nこの品目は今後、不足品リストに表示されなくなります。`)) {
                return;
            }
            window.showLoading('マスターを更新中...');
            try {
                const res = await fetch('/api/master/set_order_stopped', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ productCode: productCode, status: 1 }),
                });
                const resData = await res.json();
                if (!res.ok) throw new Error(resData.message || '更新に失敗しました。');

                if (row) {
                    row.classList.add('provisional-order-item');
                    row.querySelector('.wholesaler-select').disabled = true;
                    row.querySelector('.order-quantity-input').disabled = true;
                    target.disabled = true; // ボタン自体も無効化
                }
                window.showNotification(`「${productName}」を発注不可に設定しました。`, 'success');

            } catch(err) {
                window.showNotification(err.message, 'error');
            } finally {
                window.hideLoading();
            }
        } else if (target.classList.contains('go-to-inv-adj-btn')) {
            const yjCode = target.dataset.yjCode;
            document.dispatchEvent(new CustomEvent('navigateToInventoryAdjustment', {
                detail: { yjCode },
                bubbles: true
            }));
        } else if (target.classList.contains('change-to-orderable-btn')) {
            if (row) {
                row.classList.remove('provisional-order-item');
                row.querySelector('.wholesaler-select').disabled = false;
                row.querySelector('.order-quantity-input').disabled = false;

                target.textContent = '除外';
                target.classList.remove('change-to-orderable-btn');
                target.classList.add('remove-order-item-btn');
            }
        } else if (target.classList.contains('remove-order-item-btn')) {
            const tbody = row.closest('tbody');
            const table = tbody.closest('table');
            const wrapper = table.closest('.order-yj-group-wrapper');
            row.remove();
            
            if (tbody.children.length === 0 && wrapper) {
                wrapper.remove();
            }
        }
    });
}

----- C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\precomp_details_table.js -----
// C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\precomp_details_table.js
import { showModal } from './inout_modal.js';
import { createUploadTableHTML } from './common_table.js';
import { clientMap } from './master_data.js';

let tableBody, addRowBtn, outputContainer;

function createRowHTML(rec = {}) {
    const isNew = !rec.janCode && !rec.productCode;
    const rowId = isNew ? `new-${Date.now()}` : rec.id;
    const productData = isNew ? {} : rec;
    const janQuantity = rec.janQuantity || 1;
    const yjQuantity = janQuantity * (rec.janPackInnerQty || 0);

    const topRow = `
        <tr class="data-row" data-row-id="${rowId}" data-product='${JSON.stringify(productData)}'>
            <td rowspan="2" class="center"><button class="delete-row-btn btn">削除</button><button class="insert-row-btn btn" style="margin-top: 4px;">挿入</button></td>
            <td>${rec.transactionDate || ''}</td>
            <td class="yj-jan-code">${rec.yjCode || ''}</td>
            <td colspan="2" class="product-name-cell left" style="cursor: pointer; text-decoration: underline; color: blue;">${rec.productName || 'ここをクリックして製品を検索'}</td>
            <td></td>
            <td class="right yj-quantity-cell">${yjQuantity.toFixed(2)}</td>
            <td class="right yj-pack-unit-qty-cell">${rec.yjPackUnitQty || ''}</td>
            <td class="yj-unit-name-cell">${rec.yjUnitName || ''}</td>
            <td></td><td></td><td></td>
            <td class="left client-code-cell">${clientMap.get(rec.clientCode) || rec.clientCode || ''}</td>
            <td class="right line-number-cell">${rec.lineNumber || ''}</td>
        </tr>`;

    const bottomRow = `
        <tr class="data-row-bottom">
            <td>予製</td>
            <td class="yj-jan-code jan-code-cell">${rec.janCode || rec.productCode || ''}</td>
            <td class="left package-spec-cell">${rec.packageSpec || rec.formattedPackageSpec || ''}</td>
            <td class="left maker-name-cell">${rec.makerName || ''}</td>
            <td class="left usage-classification-cell">${rec.usageClassification || ''}</td>
            <td><input type="number" name="janQuantity" value="${janQuantity}" step="any"></td>
            <td class="right jan-pack-unit-qty-cell">${rec.janPackUnitQty || ''}</td>
            <td class="jan-unit-name-cell">${rec.janUnitName || ''}</td>
            <td></td><td></td><td></td>
            <td class="left receipt-number-cell">${rec.receiptNumber || ''}</td>
            <td></td>
        </tr>`;
    return topRow + bottomRow;
}

function recalculateRow(quantityInputElement) {
    const lowerRow = quantityInputElement.closest('tr.data-row-bottom');
    if (!lowerRow) return;
    const topRow = lowerRow.previousElementSibling;
    if (!topRow || !topRow.classList.contains('data-row')) return;

    const productDataString = topRow.dataset.product;
    if (!productDataString || productDataString === '{}') return;
    const productData = JSON.parse(productDataString);

    const janQuantity = parseFloat(quantityInputElement.value) || 0;
    const yjQuantity = janQuantity * (productData.janPackInnerQty || 0);
    const yjQuantityCell = topRow.querySelector('.yj-quantity-cell');
    if (yjQuantityCell) {
        yjQuantityCell.textContent = yjQuantity.toFixed(2);
    }
}

export function populateDetailsTable(records) {
    if (!tableBody) return;
    if (!records || records.length === 0) {
        clearDetailsTable();
        return;
    }
    tableBody.innerHTML = records.map(createRowHTML).join('');
}

export function clearDetailsTable() {
    if (tableBody) {
        tableBody.innerHTML = '<tr><td colspan="14">患者番号を入力して「呼び出し」を押してください。</td></tr>';
    }
}

export function getDetailsData() {
    const records = [];
    outputContainer.querySelectorAll('tr.data-row[data-row-id]').forEach(row => {
        const productDataString = row.dataset.product;
        if (!productDataString || productDataString === '{}') return;

        const janQuantity = parseFloat(row.nextElementSibling.querySelector('input[name="janQuantity"]').value) || 0;
        if (janQuantity > 0) {
            const productData = JSON.parse(productDataString);
            const code = productData.productCode || productData.janCode; 

            if (code) { 
                records.push({
                    productCode: code,
                    janQuantity: janQuantity,
                });
            }
        }
    });
    return records;
}

export function initDetailsTable() {
    outputContainer = document.getElementById('precomp-details-container');
    addRowBtn = document.getElementById('precomp-add-row-btn');
    if (!outputContainer || !addRowBtn) return;
    outputContainer.innerHTML = createUploadTableHTML('precomp-details-table');
    tableBody = outputContainer.querySelector('tbody');
    clearDetailsTable();

    addRowBtn.addEventListener('click', () => {
        if (tableBody.querySelector('td[colspan="14"]')) {
            tableBody.innerHTML = '';
        }
        tableBody.insertAdjacentHTML('beforeend', createRowHTML());
    });
    tableBody.addEventListener('input', (e) => {
        if (e.target.matches('input[name="janQuantity"]')) {
            recalculateRow(e.target);
        }
    });
    tableBody.addEventListener('click', (e) => {
        const target = e.target;
        if (target.classList.contains('delete-row-btn')) {
            const topRow = target.closest('tr');
            const bottomRow = topRow.nextElementSibling;
            topRow.remove();
            if (bottomRow) bottomRow.remove();
            if (tableBody.children.length === 0) {
                clearDetailsTable();
            }
        }

        if (target.classList.contains('insert-row-btn')) {
			const topRow = target.closest('tr');
			const bottomRow = topRow.nextElementSibling;
			bottomRow.insertAdjacentHTML('afterend', createRowHTML());
		}

        if (target.classList.contains('product-name-cell')) {
            const activeRow = target.closest('tr');
            // この画面では /api/masters/search_all (製品マスター検索) を使用します
            showModal(activeRow, (selectedProduct, targetRow) => {
                targetRow.dataset.product = JSON.stringify(selectedProduct);
                const lowerRow = targetRow.nextElementSibling;

                targetRow.querySelector('.yj-jan-code').textContent = selectedProduct.yjCode || '';
                targetRow.querySelector('.product-name-cell').textContent = selectedProduct.productName || '';
                targetRow.querySelector('.yj-pack-unit-qty-cell').textContent = selectedProduct.yjPackUnitQty || '';
                targetRow.querySelector('.yj-unit-name-cell').textContent = selectedProduct.yjUnitName || '';
                
                lowerRow.querySelector('.jan-code-cell').textContent = selectedProduct.janCode || selectedProduct.productCode || '';
                lowerRow.querySelector('.package-spec-cell').textContent = selectedProduct.packageSpec || selectedProduct.formattedPackageSpec || '';
                lowerRow.querySelector('.maker-name-cell').textContent = selectedProduct.makerName || '';
                lowerRow.querySelector('.usage-classification-cell').textContent = selectedProduct.usageClassification || '';
                lowerRow.querySelector('.jan-pack-unit-qty-cell').textContent = selectedProduct.janPackUnitQty || '';
                lowerRow.querySelector('.jan-unit-name-cell').textContent = selectedProduct.janUnitName || '';
                const quantityInput = lowerRow.querySelector('input[name="janQuantity"]');
                recalculateRow(quantityInput);
                quantityInput.focus();
                quantityInput.select();
            }, { searchApi: '/api/masters/search_all' });
        }
    });
}

----- C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\precomp_header.js -----
import { getDetailsData, clearDetailsTable, populateDetailsTable } from './precomp_details_table.js';

let patientNumberInput, saveBtn, loadBtn, clearBtn, exportBtn, importBtn, importInput, exportAllBtn, importAllBtn, importAllInput;

export function resetHeader() {
    if (patientNumberInput) {
        patientNumberInput.value = '';
    }
}

export function initHeader() {
    patientNumberInput = document.getElementById('precomp-patient-number');
    saveBtn = document.getElementById('precomp-save-btn');
    loadBtn = document.getElementById('precomp-load-btn');
    clearBtn = document.getElementById('precomp-clear-btn');
    exportBtn = document.getElementById('precomp-export-btn');
    importBtn = document.getElementById('precomp-import-btn');
    importInput = document.getElementById('precomp-import-input');
    exportAllBtn = document.getElementById('precomp-export-all-btn');
    importAllBtn = document.getElementById('precomp-import-all-btn');
    importAllInput = document.getElementById('precomp-import-all-input');

    // ▼▼▼【ここから追加】▼▼▼
    const toggleStatusBtn = document.getElementById('precomp-toggle-status-btn');

    if (toggleStatusBtn) {
        toggleStatusBtn.addEventListener('click', async () => {
            const patientNumber = patientNumberInput.value.trim();
            if (!patientNumber) {
                window.showNotification('患者番号を入力してください。', 'error');
                return;
            }

            // ボタンの現在のテキストに応じてAPIを決定
            const isSuspending = toggleStatusBtn.textContent === '予製中断';
            const endpoint = isSuspending ? '/api/precomp/suspend' : '/api/precomp/resume';
            const actionText = isSuspending ? '中断' : '再開';

            if (!confirm(`患者番号: ${patientNumber} の予製を${actionText}します。よろしいですか？`)) {
                return;
            }

            window.showLoading();
            try {
                const res = await fetch(endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ patientNumber }),
                });

                const resData = await res.json();
                if (!res.ok) throw new Error(resData.message || `${actionText}に失敗しました。`);

                window.showNotification(resData.message, 'success');
                // 状態変更後にビューをリフレッシュ
                loadBtn.click();
            } catch (err) {
                window.showNotification(err.message, 'error');
            } finally {
                window.hideLoading();
            }
        });
    }
    // ▲▲▲【追加ここまで】▲▲▲

    if (!patientNumberInput || !saveBtn || !loadBtn || !clearBtn) return;
    
    loadBtn.addEventListener('click', async () => {
        const patientNumber = patientNumberInput.value.trim();
        if (!patientNumber) {
            window.showNotification('患者番号を入力してください。', 'error');
            return;
        }
        window.showLoading();
        try {
            const res = await fetch(`/api/precomp/load?patientNumber=${encodeURIComponent(patientNumber)}`);
            if (!res.ok) throw new Error('データの呼び出しに失敗しました。');
            
            const responseData = await res.json();
            
            populateDetailsTable(responseData.records);

            const toggleBtn = document.getElementById('precomp-toggle-status-btn');
            const detailsContainer = document.getElementById('precomp-details-container');

            if (responseData.status === 'inactive') {
                if(toggleBtn) {
                    toggleBtn.textContent = '予製再開';
                    toggleBtn.style.backgroundColor = '#198754';
                }
                if(detailsContainer) detailsContainer.classList.add('is-inactive');
                window.showNotification('この患者の予製は中断中です。', 'success');
            } else {
                 if(toggleBtn) {
                    toggleBtn.textContent = '予製中断';
                    toggleBtn.style.backgroundColor = '';
                 }
                 if(detailsContainer) detailsContainer.classList.remove('is-inactive');
            }
        } catch (err) {
            window.showNotification(err.message, 'error');
            clearDetailsTable();
        } finally {
            window.hideLoading();
        }
    });

    clearBtn.addEventListener('click', async () => {
        const patientNumber = patientNumberInput.value.trim();
        if (!patientNumber) {
            window.showNotification('削除する患者番号を入力してください。', 'error');
            return;
        }
        if (!confirm(`患者番号: ${patientNumber} の予製データを完全に削除します。この操作は元に戻せません。よろしいですか？`)) {
            return;
        }
    
        window.showLoading();
        try {
            const res = await fetch(`/api/precomp/clear?patientNumber=${encodeURIComponent(patientNumber)}`, { method: 'DELETE' });
            const resData = await res.json();
            if (!res.ok) throw new Error(resData.message || '削除に失敗しました。');
            window.showNotification(resData.message, 'success');
            resetHeader();
            clearDetailsTable();
        } catch (err) {
            window.showNotification(err.message, 'error');
        } finally {
            window.hideLoading();
        }
    });
    
    saveBtn.addEventListener('click', async () => {
        const patientNumber = patientNumberInput.value.trim();
        if (!patientNumber) {
            window.showNotification('患者番号を入力してください。', 'error');
            return;
        }
        const records = getDetailsData();
        if (records.length === 0 && !confirm(`保存対象の品目がありません。患者番号: ${patientNumber} の予製データをすべて削除しますがよろしいですか？`)) {
            return;
        }
        if (records.length > 0 && !confirm(`患者番号: ${patientNumber} の予製データを保存します。よろしいですか？`)) {
            return;
        }
        const payload = { patientNumber, records };
  
        window.showLoading();
        try {
            const res = await fetch('/api/precomp/save', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload),
            });
            const resData = await res.json();
            if (!res.ok) throw new Error(resData.message || '保存に失敗しました。');
            window.showNotification(resData.message, 'success');
            resetHeader();
            clearDetailsTable();
        } catch (err) {
            window.showNotification(`エラー: ${err.message}`, 'error');
        } finally {
            window.hideLoading();
        }
    });
    
    exportBtn.addEventListener('click', () => {
        const patientNumber = patientNumberInput.value.trim();
        if (!patientNumber) {
            window.showNotification('エクスポートする患者番号を入力してください。', 'error');
            return;
        }
        window.location.href = `/api/precomp/export?patientNumber=${encodeURIComponent(patientNumber)}`;
    });
    
    exportAllBtn.addEventListener('click', () => {
        if (confirm('全患者の予製データをCSVファイルとしてエクスポートします。よろしいですか？')) {
            window.location.href = '/api/precomp/export_all';
        }
    });

    importBtn.addEventListener('click', () => {
        const patientNumber = patientNumberInput.value.trim();
        if (!patientNumber) {
            window.showNotification('インポート先の患者番号を入力してください。', 'error');
            return;
        }
        importInput.click();
    });
    
    importInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        const patientNumber = patientNumberInput.value.trim();
        if (!file || !patientNumber) return;

        const formData = new FormData();
        formData.append('file', file);
        formData.append('patientNumber', patientNumber);

        window.showLoading();
        try {
            const res = await fetch('/api/precomp/import', {
                method: 'POST',
                body: formData,
            });
            const resData = await res.json();
            if (!res.ok) throw new Error(resData.message || 'インポートに失敗しました。');
            
            window.showNotification(resData.message, 'success');
            loadBtn.click(); 
        } catch (err) {
            window.showNotification(`エラー: ${err.message}`, 'error');
        } finally {
            window.hideLoading();
            e.target.value = '';
        }
    });

    importAllBtn.addEventListener('click', () => {
        if (!confirm('複数患者の予製データを一括でインポートします。\nCSVの1列目には患者番号が必要です。\n既存のデータは上書きされます。よろしいですか？')) {
            return;
        }
        importAllInput.click();
    });

    importAllInput.addEventListener('change', async (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const formData = new FormData();
        formData.append('file', file);

        window.showLoading();
        try {
            const res = await fetch('/api/precomp/import_all', {
                method: 'POST',
                body: formData,
            });
            const resData = await res.json();
            if (!res.ok) throw new Error(resData.message || '全件インポートに失敗しました。');
            
            window.showNotification(resData.message, 'success');
            resetHeader();
            clearDetailsTable();
        } catch (err) {
            window.showNotification(`エラー: ${err.message}`, 'error');
        } finally {
            window.hideLoading();
            e.target.value = '';
        }
    });
}

----- C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\precomp.js -----
import { initHeader, resetHeader } from './precomp_header.js';
import { initDetailsTable, clearDetailsTable } from './precomp_details_table.js';

export function resetPrecompView() {
    resetHeader();
    clearDetailsTable();
}

export function initPrecomp() {
    initHeader();
    initDetailsTable();
}

----- C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\pricing.js -----
import { wholesalerMap } from './master_data.js';
let view, wholesalerSelect, exportBtn, uploadInput, bulkUpdateBtn, outputContainer, makerFilterInput;
let fullPricingData = []; 
let orderedWholesalers = []; 
let setLowestPriceBtn;
let unregisteredFilterCheckbox;
let exportUnregisteredBtn; 
let lastSelectedWholesaler = '';

function renderComparisonTable(data) {
    if (!data || data.length === 0) {
        outputContainer.innerHTML = '<p>表示対象のデータがありませんでした。</p>';
        return;
    }

    const wholesalerHeaders = orderedWholesalers.length > 0 ?
        orderedWholesalers.map(w => `<th>${w}</th>`).join('') : '';
    const wholesalerReverseMap = new Map();
    for (const [code, name] of wholesalerMap.entries()) {
        wholesalerReverseMap.set(name, code);
    }

    let tableHTML = `
        <table class="data-table">
            <thead>
                <tr>
                    <th rowspan="2">製品名</th>
                    <th rowspan="2">包装</th>
                    <th rowspan="2">メーカー</th>
                    <th rowspan="2">現納入価</th>
                    <th colspan="${orderedWholesalers.length || 1}">卸提示価格</th>
                    <th rowspan="2">採用卸</th>
                    <th rowspan="2">決定納入価</th>
                </tr>
                <tr>
                    ${wholesalerHeaders}
                </tr>
            </thead>
            <tbody>
    `;
    data.forEach(p => {
        const productCode = p.productCode;
        let wholesalerOptions = '<option value="">--- 選択 ---</option>';
        for (const [wCode, wName] of wholesalerMap.entries()) {
            const isSelected = (wCode === p.supplierWholesale);
            wholesalerOptions += `<option value="${wCode}" ${isSelected ? 'selected' : ''}>${wName}</option>`;
        }
        const quoteCells = orderedWholesalers.length > 0 
            ? orderedWholesalers.map(w => {
            const price = (p.quotes || {})[w];
            if (price === undefined) return '<td>-</td>';
            const lowestPrice = Math.min(...Object.values(p.quotes || {}).filter(v => typeof v === 'number'));
            const style = (price === lowestPrice) ? 'style="background-color: #d1e7dd; font-weight: bold;"' : '';
            return `<td class="right" ${style}>${price.toFixed(2)}</td>`;
        }).join('') : '<td>-</td>';
        const initialPrice = p.purchasePrice > 0 ? p.purchasePrice.toFixed(2) : '';
        tableHTML += `
            <tr data-product-code="${productCode}">
                <td class="left">${p.productName}</td>
                <td class="left">${p.formattedPackageSpec || ''}</td>
                <td class="left">${p.makerName}</td>
                <td class="right">${p.purchasePrice.toFixed(2)}</td>
                ${quoteCells}
                <td><select class="supplier-select">${wholesalerOptions}</select></td>
                <td><input type="number" class="manual-price-input" step="0.01" style="width: 100px;" value="${initialPrice}"></td>
            </tr>
        `;
    });
    tableHTML += `</tbody></table>`;
    outputContainer.innerHTML = tableHTML;
}

async function sendUpdatePayload(payload) {
    if (payload.length === 0) {
        window.showNotification('更新するデータがありません。', 'error');
        return;
    }
    window.showLoading();
    try {
        const res = await fetch('/api/pricing/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload),
        });
        const resData = await res.json();
        if (!res.ok) {
            throw new Error(resData.message || 'マスターの更新に失敗しました。');
        }
        window.showNotification(resData.message, 'success');
        payload.forEach(update => {
            const product = fullPricingData.find(p => p.productCode === update.productCode);
            if (product) {
                product.purchasePrice = update.newPrice;
                product.supplierWholesale = update.newWholesaler;
            }
        });
        applyFiltersAndRender();
    } catch (err) {
        window.showNotification(err.message, 'error');
    } finally {
        window.hideLoading();
    }
}

async function handleBulkUpdate() {
    if (!confirm('表示されている全ての行の内容でマスターデータを一括更新します。よろしいですか？')) {
        return;
    }
    const rows = outputContainer.querySelectorAll('tbody tr');
    const payload = [];
    rows.forEach(row => {
        const productCode = row.dataset.productCode;
        const supplierSelect = row.querySelector('.supplier-select');
        const manualPriceInput = row.querySelector('.manual-price-input');
        const selectedWholesalerCode = supplierSelect.value;
        const price = parseFloat(manualPriceInput.value);
        if (productCode && selectedWholesalerCode && !isNaN(price)) {
            payload.push({ productCode, newPrice: price, newWholesaler: selectedWholesalerCode });
        } else if (productCode && !selectedWholesalerCode) {
             payload.push({ productCode, newPrice: 0, newWholesaler: '' });
        }
    });
    await sendUpdatePayload(payload);
}

function applyFiltersAndRender() {
    let dataToRender = fullPricingData;
    if (unregisteredFilterCheckbox.checked) {
        dataToRender = dataToRender.filter(p => !p.supplierWholesale);
    }
    const filterText = makerFilterInput.value.trim().toLowerCase();
    if (filterText) {
        dataToRender = dataToRender.filter(p => 
            p.makerName && p.makerName.toLowerCase().includes(filterText)
        );
    }
    renderComparisonTable(dataToRender); 
}

async function handleUpload() {
    const files = Array.from(uploadInput.files);
    if (files.length === 0) return;
    window.showLoading();
    try {
        const formData = new FormData();
        const wholesalerNames = [];
        const processedFiles = [];

        files.forEach(file => {
            const match = file.name.match(/^(\d+)_/);
            const priority = match ? parseInt(match[1], 10) : Infinity;
            
            // ファイル名から卸名部分を抽出（例: 1_価格見積依頼_卸名_... -> 卸名）
            const nameParts = file.name.replace(/^\d+_/, '').split('_');
            if (nameParts.length > 1) {
                 processedFiles.push({ file: file, priority: priority, wholesalerName: nameParts[1] });
            } else {
                 window.showNotification(`ファイル名から卸名を抽出できませんでした: ${file.name}`, 'error');
            }
        });

        // 優先順位でファイルをソート
        processedFiles.sort((a, b) => a.priority - b.priority);

        // ソートされた順にFormDataに追加
        processedFiles.forEach(item => {
            formData.append('files', item.file);
            wholesalerNames.push(item.wholesalerName);
        });

        if (formData.getAll('files').length === 0) {
            throw new Error('処理できる有効なファイルがありませんでした。');
        }
        
        wholesalerNames.forEach(name => formData.append('wholesalerNames', name));

        const res = await fetch('/api/pricing/upload', {
            method: 'POST',
            body: formData,
        });
        if (!res.ok) {
            const errText = await res.text();
            throw new Error(errText || 'アップロード処理に失敗しました。'); 
        }
        
        const responseData = await res.json();
        fullPricingData = responseData.productData;
        orderedWholesalers = responseData.wholesalerOrder;
        applyFiltersAndRender();
    } catch (err) {
        window.showNotification(err.message, 'error');
    } finally {
        window.hideLoading();
        uploadInput.value = '';
    }
}

async function handleExport(unregisteredOnly = false) {
    const wholesalerSelectEl = document.getElementById('pricing-wholesaler-select');
    const selectedWholesalerName = wholesalerSelectEl.options[wholesalerSelectEl.selectedIndex].text;
    if (!wholesalerSelectEl.value) {
        window.showNotification('テンプレートを出力する卸業者を選択してください。', 'error'); 
        return;
    }

    const date = new Date();
    const dateStr = `${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2, '0')}${date.getDate().toString().padStart(2, '0')}`;
    
    const params = new URLSearchParams({
        wholesalerName: selectedWholesalerName,
        unregisteredOnly: unregisteredOnly,
        date: dateStr,
    });

    window.location.href = `/api/pricing/export?${params.toString()}`;
}

async function loadInitialMasters() {
    outputContainer.innerHTML = '<p>製品マスターを読み込んでいます...</p>';
    window.showLoading();
    try {
        const res = await fetch('/api/pricing/all_masters');
        if (!res.ok) throw new Error('製品マスターの読み込みに失敗しました。');
        const responseData = await res.json();
        fullPricingData = responseData;
        orderedWholesalers = [];
        applyFiltersAndRender();
    } catch(err) {
        outputContainer.innerHTML = `<p style="color:red;">${err.message}</p>`;
    } finally {
        window.hideLoading();
    }
}

function loadWholesalerDropdown() {
    wholesalerSelect.innerHTML = '<option value="">選択してください</option>';
    for (const [code, name] of wholesalerMap.entries()) {
        const opt = document.createElement('option');
        opt.value = code; 
        opt.textContent = name; 
        wholesalerSelect.appendChild(opt); 
    }
    if (lastSelectedWholesaler) {
        wholesalerSelect.value = lastSelectedWholesaler;
    }
}

function handleSetLowestPrice() {
    const rows = outputContainer.querySelectorAll('tbody tr');
    if (rows.length === 0) return;
    const wholesalerReverseMap = new Map();
    for (const [code, name] of wholesalerMap.entries()) {
        wholesalerReverseMap.set(name, code);
    }

    rows.forEach(row => {
        const productCode = row.dataset.productCode;
        const productData = fullPricingData.find(p => p.productCode === productCode);
        if (!productData || !productData.quotes) return;

        let lowestPrice = Infinity;
        let bestWholesalerName = '';
        
        orderedWholesalers.forEach(wholesalerName => {
            const price = productData.quotes[wholesalerName];
 
            if (price !== undefined && price < lowestPrice) {
                lowestPrice = price;
                bestWholesalerName = wholesalerName;
            }
        });

        if (bestWholesalerName) {
            const bestWholesalerCode = wholesalerReverseMap.get(bestWholesalerName);
            const supplierSelect = row.querySelector('.supplier-select');
            const priceInput = row.querySelector('.manual-price-input');
            
            if(supplierSelect) supplierSelect.value = bestWholesalerCode;
            if(priceInput) priceInput.value = lowestPrice.toFixed(2);
        }
    });
    window.showNotification('すべての品目を最安値に設定しました。', 'success');
}

function handleSupplierChange(event) {
    if (!event.target.classList.contains('supplier-select')) return;
    const row = event.target.closest('tr');
    const productCode = row.dataset.productCode;
    const selectedWholesalerName = event.target.options[event.target.selectedIndex].text;
    const priceInput = row.querySelector('.manual-price-input');
    const productData = fullPricingData.find(p => p.productCode === productCode);
    if (productData && productData.quotes) {
        const newPrice = productData.quotes[selectedWholesalerName];
        if (newPrice !== undefined) {
            priceInput.value = newPrice.toFixed(2);
        } else {
            priceInput.value = '';
        }
    }
}

export function initPricingView() {
    view = document.getElementById('pricing-view');
    if (!view) return;
    wholesalerSelect = document.getElementById('pricing-wholesaler-select');
    exportBtn = document.getElementById('pricing-export-btn');
    uploadInput = document.getElementById('pricing-upload-input'); 
    bulkUpdateBtn = document.getElementById('pricing-bulk-update-btn'); 
    outputContainer = document.getElementById('pricing-output-container');
    makerFilterInput = document.getElementById('pricing-maker-filter');
    setLowestPriceBtn = document.getElementById('set-lowest-price-btn');
    unregisteredFilterCheckbox = document.getElementById('pricing-unregistered-filter');
    exportUnregisteredBtn = document.getElementById('pricing-export-unregistered-btn');

    // ▼▼▼ Add these two lines ▼▼▼
    const directImportBtn = document.getElementById('pricing-direct-import-btn');
    const directImportInput = document.getElementById('pricing-direct-import-input');
    // ▲▲▲ Addition complete ▲▲▲    

    view.addEventListener('show', () => {
        loadWholesalerDropdown();
        loadInitialMasters();
    });

    // ▼▼▼ Add these event listeners ▼▼▼
    directImportBtn.addEventListener('click', () => {
        directImportInput.click();
    });

    directImportInput.addEventListener('change', async (event) => {
        const file = event.target.files[0];
        if (!file) return;

        if (!confirm('選択したファイルの内容で納入価と卸情報を一括更新します。この操作は元に戻せません。よろしいですか？')) {
            event.target.value = ''; // Reset the file input
            return;
        }

        const formData = new FormData();
        formData.append('file', file);

        window.showLoading();
        try {
            const res = await fetch('/api/pricing/direct_import', {
                method: 'POST',
                body: formData,
            });
            const resData = await res.json();
            if (!res.ok) {
                throw new Error(resData.message || 'インポートに失敗しました。');
            }
            window.showNotification(resData.message, 'success');
            loadInitialMasters(); // Refresh the main table with updated data
        } catch (err) {
            console.error(err);
            window.showNotification(`エラー: ${err.message}`, 'error');
        } finally {
            window.hideLoading();
            event.target.value = ''; // Reset the file input
        }
    });
    // ▲▲▲ Addition complete ▲▲▲

    uploadInput.addEventListener('change', handleUpload); 
    bulkUpdateBtn.addEventListener('click', handleBulkUpdate); 
    setLowestPriceBtn.addEventListener('click', handleSetLowestPrice);
    
    exportBtn.addEventListener('click', () => handleExport(false)); 
    exportUnregisteredBtn.addEventListener('click', () => handleExport(true));

    makerFilterInput.addEventListener('input', applyFiltersAndRender);
    unregisteredFilterCheckbox.addEventListener('change', applyFiltersAndRender);

    outputContainer.addEventListener('change', handleSupplierChange);
    wholesalerSelect.addEventListener('change', () => {
        lastSelectedWholesaler = wholesalerSelect.value;
    });
}

----- C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\reprocess.js -----
// C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\reprocess.js

export function initReprocessButton() {
    const reprocessBtn = document.getElementById('reprocessBtn');
    if (!reprocessBtn) return;

    reprocessBtn.addEventListener('click', async () => {
        // ▼▼▼ [修正点] 確認メッセージをより強力なものに変更 ▼▼▼
        if (!confirm('全ての取引データを、最新のマスター情報で更新します。\nデータ量によっては数分かかる場合があります。\nこの操作は元に戻せません。よろしいですか？')) {
            return;
        }
        // ▲▲▲ 修正ここまで ▲▲▲

        window.showLoading();
        try {
            // ▼▼▼ [修正点] APIエンドポイントは /api/transactions/reprocess のまま（main.goで変更済み）▼▼▼
            const res = await fetch('/api/transactions/reprocess', {
                method: 'POST',
            });
            // ▲▲▲ 修正ここまで ▲▲▲
   
            const data = await res.json();
            if (!res.ok) {
                throw new Error(data.message || '処理に失敗しました。');
            }
            window.showNotification(data.message, 'success');
        } catch (err) {
            console.error(err);
     
            window.showNotification(`エラー: ${err.message}`, 'error');
        } finally {
            window.hideLoading();
        }
    });
}

----- C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\returns.js -----
// C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\returns.js

import { createUploadTableHTML, renderUploadTableRows } from './common_table.js';
import { hiraganaToKatakana, getLocalDateString } from './utils.js';


function formatBalance(balance) {
    if (typeof balance === 'number') {
        return balance.toFixed(2);
    }
    return balance;
}

function renderReturnCandidates(data, container) {
    if (!data || data.length === 0) {
        container.innerHTML = "<p>返品可能な品目はありませんでした。</p>";
        return;
    }

    let html = data.map((yjGroup, yjIndex) => {
        const yjHeader = `
            <div class="agg-yj-header" style="background-color: #0d6efd; color: white;">
                <span>YJ: ${yjGroup.yjCode}</span>
                <span class="product-name">${yjGroup.productName}</span>
            </div>
        `;
        
        const packagesHtml = yjGroup.packageLedgers.map((pkg, pkgIndex) => {
            const surplus = pkg.effectiveEndingBalance - pkg.reorderPoint;
            let pkgHeader = `
                <div class="agg-pkg-header" style="border-left: 5px solid #0d6efd;">
                    <span>包装: ${pkg.packageKey}</span>
                    <span class="balance-info">
                        在庫: ${formatBalance(pkg.effectiveEndingBalance)} | 
                        発注点: ${formatBalance(pkg.reorderPoint)} | 
                        <strong style="color: #0d6efd;">余剰数(目安): ${formatBalance(surplus)}</strong>
                    </span>
                </div>
            `;

            if (pkg.deliveryHistory && pkg.deliveryHistory.length > 0) {
                const tableId = `delivery-history-${yjIndex}-${pkgIndex}`;
                
                const tableShell = createUploadTableHTML(tableId);
                const tableBodyContent = renderUploadTableRows(pkg.deliveryHistory);
                
                const fullTableHtml = tableShell.replace('<tbody></tbody>', `<tbody>${tableBodyContent}</tbody>`);
                
                pkgHeader += `<div id="${tableId}-container" style="padding: 0 10px 10px 10px;">${fullTableHtml}</div>`;
            }
            return pkgHeader;
        }).join('');

        return yjHeader + packagesHtml;
    }).join('');

    container.innerHTML = html;
}

export function initReturnsView() {
    const view = document.getElementById('returns-view');
    if (!view) return;
    const runBtn = document.getElementById('run-returns-list-btn');
    const outputContainer = document.getElementById('returns-list-output-container');
    const kanaNameInput = document.getElementById('ret-kanaName');
    const dosageFormInput = document.getElementById('ret-dosageForm');
    const coefficientInput = document.getElementById('ret-coefficient');
    const printBtn = document.getElementById('print-returns-list-btn');
    const shelfNumberInput = document.getElementById('ret-shelf-number');

    runBtn.addEventListener('click', async () => {
        window.showLoading();
        const params = new URLSearchParams({
            kanaName: hiraganaToKatakana(kanaNameInput.value),
            dosageForm: dosageFormInput.value,
            shelfNumber: shelfNumberInput.value,
            coefficient: coefficientInput.value,
        });

        try {
            const res = await fetch(`/api/returns/candidates?${params.toString()}`);
            if (!res.ok) {
                const errText = await res.text();
                throw new Error(errText || 'List generation failed');
            }
            const data = await res.json();
            renderReturnCandidates(data, outputContainer);
        } catch (err) {
            outputContainer.innerHTML = `<p style="color:red;">エラー: ${err.message}</p>`;
        } finally {
            window.hideLoading();
        }
    });

    printBtn.addEventListener('click', () => {
        view.classList.add('print-this-view');
        window.print();
    });

    window.addEventListener('afterprint', () => {
        view.classList.remove('print-this-view');
    });
}

----- C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\settings.js -----
// C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\settings.js
import { refreshWholesalerMap } from './master_data.js';

let view, userIDInput, passwordInput, saveBtn, usageFolderPathInput, calculationPeriodDaysInput, edgePathInput;
let wholesalerCodeInput, wholesalerNameInput, addWholesalerBtn, wholesalersTableBody;
let migrateInventoryBtn, migrateInventoryInput;
let migrationResultContainer;

function initCleanupSection() {
    const getBtn = document.getElementById('getCleanupCandidatesBtn');
    const outputContainer = document.getElementById('cleanup-output-container');

    getBtn.addEventListener('click', async () => {
         if (!confirm('在庫ゼロかつ3ヶ月間動きのない製品マスターを検索します。よろしいですか？')) {
            return;
        }
        window.showLoading('整理対象のマスターを検索中...');
        try {
             const res = await fetch('/api/masters/cleanup/candidates');
            if (!res.ok) throw new Error('候補リストの取得に失敗しました。');
            
            const candidates = await res.json();
            renderCleanupCandidates(candidates, outputContainer);
        } catch (err) {
            outputContainer.innerHTML = `<p style="color:red;">${err.message}</p>`;
            window.showNotification(err.message, 'error');
        } finally {
            window.hideLoading();
         }
    });

    outputContainer.addEventListener('click', async (e) => {
        if (e.target.id === 'executeCleanupBtn') {
            const checkedBoxes = outputContainer.querySelectorAll('.cleanup-check:checked');
    
             if (checkedBoxes.length === 0) {
                window.showNotification('削除するマスターが選択されていません。', 'error');
                 return;
            }
            if (!confirm(`本当に選択された ${checkedBoxes.length} 件の製品マスターを削除しますか？\nこの操作は元に戻せません。`)) {
                 return;
            }

            const productCodes = Array.from(checkedBoxes).map(cb => cb.dataset.productCode);
        
             window.showLoading('マスターを削除中...');
            try {
                const res = await fetch('/api/masters/cleanup/execute', {
                     method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
 
                     body: JSON.stringify({ productCodes }),
                });
    
                 const resData = await res.json();
                if (!res.ok) throw new Error(resData.message || '削除に失敗しました。');
                
                window.showNotification(resData.message, 'success');
                outputContainer.innerHTML = '';
            } catch (err) {
                window.showNotification(err.message, 'error');
            } finally {
                window.hideLoading();
            }
        } else if (e.target.id === 'cleanup-select-all') {
            const isChecked = e.target.checked;
            outputContainer.querySelectorAll('.cleanup-check').forEach(chk => chk.checked = isChecked);
        }
    });
}

function renderCleanupCandidates(candidates, container) {
    if (!candidates || candidates.length === 0) {
        container.innerHTML = '<p>整理対象の製品マスターは見つかりませんでした。</p>';
        return;
    }
    
    let tableHTML = `
        <p><strong>${candidates.length}件</strong>の整理対象マスターが見つかりました。</p>
        <table class="data-table" style="margin-top: 5px;">
            <thead>
                <tr>
                     <th style="width: 5%;"><input type="checkbox" id="cleanup-select-all" checked></th>
                    <th style="width: 35%;">製品名</th>
                    <th style="width: 15%;">JANコード</th>
                     <th style="width: 15%;">メーカー名</th>
                </tr>
            </thead>
             <tbody>
    `;
    candidates.forEach(p => {
        tableHTML += `
            <tr>
                 <td class="center"><input type="checkbox" class="cleanup-check" data-product-code="${p.productCode}" checked></td>
                <td class="left">${p.productName}</td>
                 <td>${p.productCode}</td>
                <td class="left">${p.makerName}</td>
            </tr>
        `;
    });
    tableHTML += `
            </tbody>
        </table>
        <div style="margin-top: 10px; text-align: right;">
             <button id="executeCleanupBtn" class="btn" style="background-color: #dc3545; color: white;">チェックしたマスターを削除</button>
        </div>
    `;
    container.innerHTML = tableHTML;
}

async function loadSettings() {
    try {
         const res = await fetch('/api/settings/get');
        if (!res.ok) throw new Error('設定の読み込みに失敗しました。');
        const settings = await res.json();
        userIDInput.value = settings.emednetUserId || '';
        passwordInput.value = settings.emednetPassword || '';
        if (usageFolderPathInput) {
            usageFolderPathInput.value = settings.usageFolderPath || '';
        }
        if (calculationPeriodDaysInput) {
            calculationPeriodDaysInput.value = settings.calculationPeriodDays || 90;
        }
        if (edgePathInput) {
             edgePathInput.value = settings.edgePath || '';
        }
        const edgeBtn = document.getElementById('edgeDownloadBtn');
        if(edgeBtn) {
            edgeBtn.disabled = !settings.edgePath;
        }

    } catch (err) {
         console.error(err);
        window.showNotification(err.message, 'error');
    }
}

async function saveSettings() {
    window.showLoading();
    try {
        const currentSettingsRes = await fetch('/api/settings/get');
        if (!currentSettingsRes.ok) throw new Error('現在の設定の読み込みに失敗しました。');
        const currentSettings = await currentSettingsRes.json();

        const userId = userIDInput.value;
        const password = passwordInput.value;
        const usagePath = usageFolderPathInput.value;
        const periodDays = parseInt(calculationPeriodDaysInput.value, 10);
        const edgePath = edgePathInput.value.trim();

        const newSettings = {
             ...currentSettings,
            emednetUserId: userId,
            emednetPassword: password,
           
             edeUserId: userId,
            edePassword: password,
            usageFolderPath: usagePath,
            calculationPeriodDays: periodDays,
 
             edgePath: edgePath,
        };

        const res = await fetch('/api/settings/save', {
            method: 'POST',
             headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(newSettings),
        });
        const resData = await res.json();
        if (!res.ok) throw new Error(resData.message || '設定の保存に失敗しました。');
        
        window.showNotification(resData.message, 'success');
        
        const edgeBtn = document.getElementById('edgeDownloadBtn');
        if(edgeBtn) {
            edgeBtn.disabled = !newSettings.edgePath;
        }

    } catch (err) {
        
         console.error(err);
        window.showNotification(err.message, 'error');
    } finally {
        window.hideLoading();
    }
}

function renderWholesalers(wholesalers) {
    if (!wholesalers) {
        wholesalersTableBody.innerHTML = '<tr><td colspan="3">登録されている卸業者がありません。</td></tr>';
        return;
    }
    wholesalersTableBody.innerHTML = wholesalers.map(w => `
        <tr data-code="${w.code}">
            <td>${w.code}</td>
            <td class="left">${w.name}</td>
      
             <td class="center"><button class="delete-wholesaler-btn btn">削除</button></td>
        </tr>
    `).join('');
}

async function loadWholesalers() {
    try {
        const res = await fetch('/api/settings/wholesalers');
        if (!res.ok) throw new Error('卸業者リストの読み込みに失敗しました。');
        const data = await res.json();
        renderWholesalers(data);
    } catch (err) {
        console.error(err);
        window.showNotification(err.message, 'error');
    }
}

async function addWholesaler() {
    const code = wholesalerCodeInput.value.trim();
    const name = wholesalerNameInput.value.trim();
    if (!code || !name) {
        window.showNotification('卸コードと卸業者名の両方を入力してください。', 'error');
        return;
    }

    window.showLoading();
    try {
        const res = await fetch('/api/settings/wholesalers', {
             method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ code, name }),
      
         });
        const resData = await res.json();
        if (!res.ok) throw new Error(resData.message || '卸業者の追加に失敗しました。');
        
        window.showNotification(resData.message, 'success');
        wholesalerCodeInput.value = '';
        wholesalerNameInput.value = '';
        loadWholesalers();
        await refreshWholesalerMap();
    } catch (err) {
        console.error(err);
        window.showNotification(err.message, 'error');
    } finally {
        window.hideLoading();
    }
}

// ▼▼▼【ここから修正】▼▼▼
function renderMigrationResults(results) {
    if (!results || results.length === 0) {
        migrationResultContainer.innerHTML = '<p>処理対象のデータがありませんでした。</p>';
        return;
    }

    const headers = `
        <thead>
            <tr>
                <th>CSV行</th>
                <th>読込JAN</th>
                <th>読込数量(YJ)</th>
                <th>マスター</th>
                <th>登録製品名</th>
                <th>登録JAN</th>
                <th>登録YJ数量</th>
                <th>エラー</th>
            </tr>
        </thead>
    `;

    const rows = results.map(r => {
        const masterStatusMap = {
            "EXISTED": "既存",
            "JCSHMS": "新規(JCSHMS)",
            "PROVISIONAL": "新規(仮)"
        };
        const masterStatus = masterStatusMap[r.masterCreated] || '不明';
        const errorClass = r.error ? 'style="background-color: #f8d7da;"' : '';

        return `
            <tr ${errorClass}>
                <td class="left" style="font-size: 10px;">${(r.originalRow || []).join(', ')}</td>
                <td>${r.parsedRecord ? r.parsedRecord.janCode : ''}</td>
                <td class="right">${r.parsedRecord ? r.parsedRecord.yjQuantity.toFixed(2) : ''}</td>
                <td>${masterStatus}</td>
                <td class="left">${r.resultRecord ? r.resultRecord.productName : '-'}</td>
                <td>${r.resultRecord ? r.resultRecord.janCode : '-'}</td>
                <td class="right">${r.resultRecord ? r.resultRecord.yjQuantity.toFixed(2) : '-'}</td>
                <td class="left" style="color: red;">${r.error || ''}</td>
            </tr>
        `;
    }).join('');

    migrationResultContainer.innerHTML = `<table class="data-table">${headers}<tbody>${rows}</tbody></table>`;
}

export function initSettings() {
    view = document.getElementById('settings-view');
    if (!view) return;

    userIDInput = document.getElementById('emednetUserID');
    passwordInput = document.getElementById('emednetPassword');
    saveBtn = document.getElementById('saveSettingsBtn');
    usageFolderPathInput = document.getElementById('usageFolderPath');
    calculationPeriodDaysInput = document.getElementById('calculationPeriodDays');
    edgePathInput = document.getElementById('edgePath');
    wholesalerCodeInput = document.getElementById('wholesalerCode');
    wholesalerNameInput = document.getElementById('wholesalerName');
    addWholesalerBtn = document.getElementById('addWholesalerBtn');
    wholesalersTableBody = document.querySelector('#wholesalers-table tbody');
    const clearTransactionsBtn = document.getElementById('clearAllTransactionsBtn');
    const clearMastersBtn = document.getElementById('clearAllMastersBtn');
    
    migrateInventoryBtn = document.getElementById('migrateInventoryBtn');
    migrateInventoryInput = document.getElementById('migrateInventoryInput');
    migrationResultContainer = document.getElementById('migration-result-container');

    initCleanupSection();
    
    if (migrateInventoryBtn) {
        migrateInventoryBtn.addEventListener('click', () => {
            if (!confirm('旧システムから在庫データを移行します。\nCSVファイルの形式（inventory_date, product_code, quantity）が正しいことを確認してください。\nよろしいですか？')) {
                return;
            }
            migrateInventoryInput.click();
        });
    }

    if (migrateInventoryInput) {
        migrateInventoryInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            window.showLoading('在庫データを移行中...');
            migrationResultContainer.innerHTML = ''; // 結果表示エリアをクリア
            try {
                const res = await fetch('/api/inventory/migrate', {
                    method: 'POST',
                    body: formData,
                });
                const resData = await res.json();
                if (!res.ok) {
                    throw new Error(resData.message || '移行に失敗しました。');
                }
                window.showNotification(resData.message, 'success');
                if (resData.details) {
                    renderMigrationResults(resData.details);
                }
            } catch (err) {
                console.error(err);
                migrationResultContainer.innerHTML = `<p style="color:red;">エラー: ${err.message}</p>`;
                window.showNotification(`エラー: ${err.message}`, 'error');
            } finally {
                window.hideLoading();
                event.target.value = '';
            }
        });
    }
  
    // ▲▲▲【修正ここまで】▲▲▲

    clearMastersBtn.addEventListener('click', async () => {
        if (!confirm('本当に全ての製品マスターを削除しますか？\n\nJCSHMSマスターも削除されるため、再読み込みするまで品目情報が失われます。この操作は元に戻せません。')) {
            return;
        }
 
        window.showLoading();
        try {
            const res = await fetch('/api/masters/clear_all', { method: 'POST' });
      
             const resData = await res.json();
            if (!res.ok) throw new Error(resData.message || '製品マスターの削除に失敗しました。');
            window.showNotification(resData.message, 'success');
 
         } catch (err) {
            console.error(err);
            window.showNotification(err.message, 'error');
       
         } finally {
            window.hideLoading();
        }
    });

    saveBtn.addEventListener('click', saveSettings);
    addWholesalerBtn.addEventListener('click', addWholesaler);
    
    clearTransactionsBtn.addEventListener('click', async () => {
         if (!confirm('本当にすべての取引履歴（入出庫、納品、処方、棚卸など）を削除しますか？\n\nこの操作は元に戻せません。')) {
            return;
        }
        window.showLoading();
        try {
 
             const res = await fetch('/api/transactions/clear_all', { method: 'POST' });
            const resData = await res.json();
       
             if (!res.ok) throw new Error(resData.message || '取引データの削除に失敗しました。');
            window.showNotification(resData.message, 'success');
        } catch (err) {
       
             console.error(err);
            window.showNotification(err.message, 'error');
        } finally {
            window.hideLoading();
  
         }
    });

    wholesalersTableBody.addEventListener('click', async (e) => {
        if (e.target.classList.contains('delete-wholesaler-btn')) {
            const row = e.target.closest('tr');
  
             const code = row.dataset.code;
            if (!confirm(`卸コード [${code}] を削除します。よろしいですか？`)) {
             
                 return;
            }
            window.showLoading();
            try {
  
                 const res = await fetch(`/api/settings/wholesalers/${code}`, { method: 'DELETE' });
                const resData = await res.json();
                if (!res.ok) throw new Error(resData.message || '削除に失敗しました。');
                window.showNotification(resData.message, 'success');
   
                 loadWholesalers();
                await refreshWholesalerMap();
            
             } catch (err) {
                console.error(err); 
                window.showNotification(err.message, 'error');
     
             } finally {
                window.hideLoading();
            }
         }
    });
}

export function onViewShow() {
    loadSettings();
    loadWholesalers();
}

----- C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\upload.js -----
import { createUploadTableHTML, renderUploadTableRows } from './common_table.js';

let currentUploadType = '';
const fileInputs = {
    dat: document.getElementById('datFileInput'),
    usage: document.getElementById('usageFileInput'),
};

async function handleFileUpload(type, files) {
    if (!files.length) return;
    const uploadContainer = document.getElementById('upload-output-container');
    uploadContainer.innerHTML = createUploadTableHTML('upload-output-table');
    const tbody = uploadContainer.querySelector('tbody');
    tbody.innerHTML = `<tr><td colspan="14" class="center">Processing...</td></tr>`;
    window.showLoading();
    try {
        const formData = new FormData();
        for (const file of files) formData.append('file', file);
        const res = await fetch(`/api/${type}/upload`, { method: 'POST', body: formData });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || `${type.toUpperCase()} file processing failed.`);
        renderUploadTableRows('upload-output-table', data.records || data.details);
        window.showNotification(`${type.toUpperCase()} file(s) processed.`, 'success');
    } catch (err) {
        tbody.innerHTML = `<tr><td colspan="14" class="center" style="color:red;">Error: ${err.message}</td></tr>`;
        window.showNotification(err.message, 'error');
    } finally {
        window.hideLoading();
        if (fileInputs[type]) fileInputs[type].value = '';
    }
}

export function initUploadView() {
    fileInputs.dat.addEventListener('change', (e) => handleFileUpload('dat', e.target.files));
    fileInputs.usage.addEventListener('change', (e) => handleFileUpload('usage', e.target.files));
    document.addEventListener('showUploadView', (e) => {
        currentUploadType = e.detail.type;
        const title = document.getElementById('upload-view-title');
        const container = document.getElementById('upload-output-container');
        if (title) title.textContent = `${currentUploadType.toUpperCase()} File Upload`;
        if (container) container.innerHTML = `<p>Click the ${currentUploadType.toUpperCase()} button again to select files.</p>`;
        if (fileInputs[currentUploadType]) fileInputs[currentUploadType].click();
    });
}
export function resetUploadView() {
    const title = document.getElementById('upload-view-title');
    const container = document.getElementById('upload-output-container');
    if (title) title.textContent = 'File Upload';
    if (container) container.innerHTML = '';
}

----- C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\usage.js -----
// C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\usage.js
// このファイル全体を以下の内容で置き換えてください。

import { createUploadTableHTML, renderUploadTableRows } from './common_table.js';

// 共通のエラーハンドリング関数
async function handleResponseError(res) {
    const errorText = await res.text();
    try {
        // エラーメッセージがJSON形式の場合
        const errorJson = JSON.parse(errorText);
        return new Error(errorJson.message || '不明なエラーが発生しました。');
    } catch (e) {
        // エラーメッセージがテキスト形式の場合
        return new Error(errorText || `サーバーエラーが発生しました (HTTP ${res.status})`);
    }
}

// 自動インポート用の関数
async function handleAutomaticUsageImport() {
    const uploadContainer = document.getElementById('upload-output-container');
    uploadContainer.innerHTML = `<p>設定されたパスからUSAGEファイルを読み込んでいます...</p>`;
    window.showLoading();

    try {
        const res = await fetch('/api/usage/upload', { method: 'POST' });
        if (!res.ok) {
            throw await handleResponseError(res);
        }
        const data = await res.json();

        const tableShell = createUploadTableHTML('upload-output-table');
        const tableBodyContent = renderUploadTableRows(data.records);
        uploadContainer.innerHTML = tableShell.replace('<tbody></tbody>', `<tbody>${tableBodyContent}</tbody>`);
        window.showNotification('USAGEファイルのインポートが完了しました。', 'success');
    } catch (err) {
        const errorRow = `<tr><td colspan="14" style="color:red; text-align:center;">エラー: ${err.message}</td></tr>`;
        uploadContainer.innerHTML = createUploadTableHTML('upload-output-table').replace('<tbody></tbody>', `<tbody>${errorRow}</tbody>`);
        window.showNotification(err.message, 'error');
    } finally {
        window.hideLoading();
    }
}

// 手動ファイルアップロード用の関数
async function handleManualUsageUpload(event) {
    const files = event.target.files;
    if (!files.length) return;

    const uploadContainer = document.getElementById('upload-output-container');
    uploadContainer.innerHTML = `<p>USAGEファイルをアップロードしています...</p>`;
    window.showLoading();
    
    try {
        const formData = new FormData();
        formData.append('file', files[0]);

        const res = await fetch('/api/usage/upload', {
            method: 'POST',
            body: formData,
        });
        if (!res.ok) {
            throw await handleResponseError(res);
        }
        const data = await res.json();

        const tableShell = createUploadTableHTML('upload-output-table');
        const tableBodyContent = renderUploadTableRows(data.records);
        uploadContainer.innerHTML = tableShell.replace('<tbody></tbody>', `<tbody>${tableBodyContent}</tbody>`);
        window.showNotification('USAGEファイルのインポートが完了しました。', 'success');
    } catch (err) {
        const errorRow = `<tr><td colspan="14" style="color:red; text-align:center;">エラー: ${err.message}</td></tr>`;
        uploadContainer.innerHTML = createUploadTableHTML('upload-output-table').replace('<tbody></tbody>', `<tbody>${errorRow}</tbody>`);
        window.showNotification(err.message, 'error');
    } finally {
        window.hideLoading();
        event.target.value = '';
    }
}

export function initUsageUpload() {
    document.addEventListener('importUsageFromPath', handleAutomaticUsageImport);

    const usageInput = document.getElementById('usageFileInput');
    if (usageInput) {
        usageInput.addEventListener('change', handleManualUsageUpload);
    }
}

----- C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\utils.js -----
// C:/Users/wasab/OneDrive/デスクトップ/WASABI/static/js/utils.js
/**
 * 文字列内のひらがなをカタカナに変換します。
 * @param {string} str 変換する文字列
 * @returns {string} カタカナに変換された文字列
 */
export function hiraganaToKatakana(str) {
    if (!str) return '';
    return str.replace(/[\u3041-\u3096]/g, function(match) {
        const charCode = match.charCodeAt(0) + 0x60;
        return String.fromCharCode(charCode);
    });
}

/**
 * 現在のPCのローカル日付を 'YYYY-MM-DD' 形式の文字列で返します。
 * @returns {string} 'YYYY-MM-DD' 形式の文字列
 */
export function getLocalDateString() {
    const today = new Date();
    const yyyy = today.getFullYear();
    const mm = String(today.getMonth() + 1).padStart(2, '0');
    const dd = String(today.getDate()).padStart(2, '0');
    return `${yyyy}-${mm}-${dd}`;
}

// ▼▼▼【ここから追加】▼▼▼
/**
 * 文字列に含まれる全角英数字記号を半角に変換します。
 * @param {string} str 変換する文字列
 * @returns {string} 半角に変換された文字列
 */
export function toHalfWidth(str) {
    if (!str) return '';
    return str.replace(/[！-～]/g, function(s) {
        return String.fromCharCode(s.charCodeAt(0) - 0xFEE0);
    }).replace(/　/g, ' '); // 全角スペースを半角スペースに
}
// ▲▲▲【追加ここまで】▲▲▲

----- C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\valuation.js -----
// C:\Users\wasab\OneDrive\デスクトップ\WASABI\static\js\valuation.js

import { hiraganaToKatakana, getLocalDateString } from './utils.js';
import { showModal } from './inout_modal.js';

let view, dateInput, runBtn, outputContainer, kanaNameInput, dosageFormInput, exportBtn, pdfExportBtn;
let reportDataCache = null;
let fullPricingData = [];
const formatCurrency = (value) => new Intl.NumberFormat('ja-JP', { style: 'currency', currency: 'JPY' }).format(value || 0);

function renderInteractiveView() {
    if (!reportDataCache || reportDataCache.length === 0) {
        outputContainer.innerHTML = '<p>表示するデータがありません。</p>';
        return;
    }

    let html = '';
    let grandTotalNhiValue = 0;
    let grandTotalPurchaseValue = 0;
    const ucMap = {"1": "内", "2": "外", "3": "歯", "4": "注", "5": "機", "6": "他"};

    reportDataCache.forEach(group => {
        grandTotalNhiValue += group.totalNhiValue;
        grandTotalPurchaseValue += group.totalPurchaseValue;

        const ucName = ucMap[group.usageClassification.trim()] || group.usageClassification;
        html += `<div class="agg-yj-header">${ucName} (合計薬価: ${formatCurrency(group.totalNhiValue)} | 合計納入価: ${formatCurrency(group.totalPurchaseValue)})</div>`;

        const sortedRows = group.detailRows.sort((a, b) => {
            const masterA = fullPricingData.find(m => m.productCode === a.productCode);
            const masterB = fullPricingData.find(m => m.productCode === b.productCode);
            const kanaA = (masterA && masterA.kanaName) ? masterA.kanaName : a.productName;
            const kanaB = (masterB && masterB.kanaName) ? masterB.kanaName : b.productName;
            return kanaA.localeCompare(kanaB, 'ja');
        });

        sortedRows.forEach(row => {
            let warningHtml = '';
            if (row.showAlert) {
                warningHtml = `<span class="warning-link" data-yj-code="${row.yjCode}" data-product-name="${row.productName}" data-provisional-code="${row.productCode}" style="color: red; font-weight: bold; cursor: pointer; text-decoration: underline; margin-left: 15px;">[JCSHMS登録]</span>`;
            }
            
            html += `
                <div class="item-row" style="padding: 8px 12px; border: 1px solid #ccc; border-top: none; display: flex; justify-content: space-between; align-items: center; line-height: 1.6;">
                    <div style="flex: 1; min-width: 0; display: flex; align-items: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                        <span style="font-weight: bold;">${row.productName}</span>
                        <span style="margin-left: 10px; overflow: hidden; text-overflow: ellipsis;">${row.packageSpec}</span>
                        ${warningHtml}
                    </div>
                    <div style="white-space: nowrap; text-align: right; padding-left: 20px;">
                        <span style="display: inline-block; min-width: 180px;">在庫: <span style="font-weight: bold;">${row.stock.toFixed(2)} ${row.yjUnitName}</span></span>
                        <span style="display: inline-block; min-width: 180px;">納入価金額: ${formatCurrency(row.totalPurchaseValue)}</span>
                        <span style="display: inline-block; min-width: 180px;">薬価金額: ${formatCurrency(row.totalNhiValue)}</span>
                    </div>
                </div>
            `;
        });
    });
    
    html += `
        <div style="text-align: right; margin-top: 20px; padding: 10px; border-top: 2px solid #333; font-weight: bold;">
            <span>総合計 (薬価): ${formatCurrency(grandTotalNhiValue)}</span> | 
            <span>総合計 (納入価): ${formatCurrency(grandTotalPurchaseValue)}</span>
        </div>
    `;

    html += `<div style="text-align: right; margin-top: 20px;"><button id="generate-report-btn" class="btn" style="background-color: #198754; color: white;">最終帳票を作成</button></div>`;
    outputContainer.innerHTML = html;
}

function renderPrintableReport() {
    const date = new Date(dateInput.value);
    const dateStr = `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`;
    
    let html = `
        <div id="valuation-print-controls" style="text-align: right; margin-bottom: 10px;">
            <button id="print-valuation-report-btn" class="btn">この帳票を印刷</button>
        </div>
        <div id="printable-area">
            <h2 style="text-align: center; margin-bottom: 20px;">${dateStr} 在庫評価一覧</h2>
    `;
    
    let grandTotalNhiValue = 0;
    let grandTotalPurchaseValue = 0;
    const ucMap = {"1": "内", "2": "外", "3": "歯", "4": "注", "5": "機", "6": "他"};

    reportDataCache.forEach(group => {
        grandTotalNhiValue += group.totalNhiValue;
        grandTotalPurchaseValue += group.totalPurchaseValue;

        const ucName = ucMap[group.usageClassification.trim()] || group.usageClassification;
        html += `<h3 style="font-size: 12pt; padding: 10px 0; page-break-before: auto; border-bottom: 1px solid #666;">${ucName}</h3>
            <table class="data-table" style="font-size: 10pt; width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th style="width: 35%; text-align: left; padding: 4px;">製品名</th>
                            <th style="width: 25%; text-align: left; padding: 4px;">包装</th>
                            <th style="width: 10%; text-align: right; padding: 4px;">在庫数</th>
                            <th style="width: 15%; text-align: right; padding: 4px;">薬価金額</th>
                            <th style="width: 15%; text-align: right; padding: 4px;">納入価金額</th>
                        </tr>
                    </thead>
                    <tbody>`;
        group.detailRows.forEach(row => {
            html += `
                <tr>
                    <td class="left" style="padding: 4px;">${row.productName}</td>
                    <td class="left" style="padding: 4px;">${row.packageSpec}</td>
                    <td class="right" style="padding: 4px;">${row.stock.toFixed(2)} ${row.yjUnitName}</td>
                    <td class="right" style="padding: 4px;">${formatCurrency(row.totalNhiValue)}</td>
                    <td class="right" style="padding: 4px;">${formatCurrency(row.totalPurchaseValue)}</td>
                </tr>`;
        });
        html += `</tbody>
                 <tfoot>
                    <tr style="border-top: 1px solid #666;">
                        <td colspan="3" class="right" style="font-weight: bold; padding: 4px;">${ucName} 合計</td>
                        <td class="right" style="font-weight: bold; padding: 4px;">${formatCurrency(group.totalNhiValue)}</td>
                        <td class="right" style="font-weight: bold; padding: 4px;">${formatCurrency(group.totalPurchaseValue)}</td>
                    </tr>
                 </tfoot>
                </table>`;
    });

    html += `
        <table class="data-table" style="margin-top: 20px; width: 100%;">
            <tfoot>
                <tr style="border-top: 2px solid black;">
                    <td colspan="3" class="right" style="font-weight: bold; padding: 8px;">総合計</td>
                    <td class="right" style="font-weight: bold; padding: 8px; width: 15%;">${formatCurrency(grandTotalNhiValue)}</td>
                    <td class="right" style="font-weight: bold; padding: 8px; width: 15%;">${formatCurrency(grandTotalPurchaseValue)}</td>
                </tr>
            </tfoot>
        </table>
    `;
    html += `</div>`;
    outputContainer.innerHTML = html;
}

async function runCalculation() {
    const date = dateInput.value.replace(/-/g, '');
    if (!date) {
        window.showNotification('評価基準日を指定してください。', 'error');
        return;
    }
    window.showLoading();
    try {
        const kanaName = hiraganaToKatakana(kanaNameInput.value);
        const dosageForm = dosageFormInput.value;
        const params = new URLSearchParams({
            date: date,
            kanaName: kanaName,
            dosageForm: dosageForm,
        });
        const res = await fetch(`/api/valuation?${params.toString()}`);
        if (!res.ok) {
            const errText = await res.text();
            throw new Error(errText || '在庫評価の計算に失敗しました。');
        }
        reportDataCache = await res.json();
        const masterRes = await fetch('/api/pricing/all_masters');
        if(!masterRes.ok) console.warn('ソート用のマスターデータ取得に失敗しました。');
        fullPricingData = await masterRes.json();

        renderInteractiveView();
    } catch (err) {
        outputContainer.innerHTML = `<p style="color:red;">${err.message}</p>`;
    } finally {
        window.hideLoading();
    }
}

function handleExport() {
    const date = dateInput.value.replace(/-/g, '');
    if (!date) {
        window.showNotification('評価基準日を指定してください。', 'error');
        return;
    }
    const kanaName = hiraganaToKatakana(kanaNameInput.value);
    const dosageForm = dosageFormInput.value;
    const params = new URLSearchParams({
        date: date,
        kanaName: kanaName,
        dosageForm: dosageForm,
    });
    window.location.href = `/api/valuation/export?${params.toString()}`;
}

function handlePdfExport() {
    const date = dateInput.value.replace(/-/g, '');
    if (!date) {
        window.showNotification('評価基準日を指定してください。', 'error');
        return;
    }
    const kanaName = hiraganaToKatakana(kanaNameInput.value);
    const dosageForm = dosageFormInput.value;
    const params = new URLSearchParams({
        date: date,
        kanaName: kanaName,
        dosageForm: dosageForm,
    });
    // ▼▼▼【ここが修正点です】 'window.location.href' から 'window.open' に変更 ▼▼▼
    window.open(`/api/valuation/export_pdf?${params.toString()}`, '_blank');
    // ▲▲▲【修正ここまで】▲▲▲
}

export function initValuationView() {
    view = document.getElementById('valuation-view');
    if (!view) return;

    dateInput = document.getElementById('valuation-date');
    runBtn = document.getElementById('run-valuation-btn');
    outputContainer = document.getElementById('valuation-output-container');
    kanaNameInput = document.getElementById('val-kanaName');
    dosageFormInput = document.getElementById('val-dosageForm');
    exportBtn = document.getElementById('export-valuation-btn');
    pdfExportBtn = document.getElementById('export-valuation-pdf-btn');

    dateInput.value = getLocalDateString();
    runBtn.addEventListener('click', runCalculation);
    exportBtn.addEventListener('click', handleExport);
    pdfExportBtn.addEventListener('click', handlePdfExport);
    outputContainer.addEventListener('click', async (e) => {
        if (e.target.classList.contains('warning-link')) {
            showModal(e.target, async (selectedProduct) => {
                window.showLoading();
                try {
                    const payload = { ...selectedProduct, origin: 'JCSHMS' };
                    const resMaster = await fetch('/api/master/update', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload),
                    });
                    const resMasterData = await resMaster.json();
                    if (!resMaster.ok) throw new Error(resMasterData.message || 'マスターの登録に失敗しました。');
                    
                    window.showNotification(`「${selectedProduct.productName}」を登録しました。在庫評価を更新します。`, 'success');

                    await runCalculation();
                } catch (err) {
                    window.showNotification(err.message, 'error');
                } finally {
                    window.hideLoading();
                }
            });
        }
        
        if (e.target.id === 'generate-report-btn') {
            renderPrintableReport();
        }
        
        if (e.target.id === 'print-valuation-report-btn') {
            document.getElementById('aggregation-view').classList.remove('print-this-view');
            view.classList.add('print-this-view');
            window.print();
        }
    });

    window.addEventListener('afterprint', () => {
        view.classList.remove('print-this-view');
    });
}

